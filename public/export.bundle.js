(function(){"use strict";const de={defaultLocale:"pt-BR",locale:"pt-BR",bundles:{"pt-BR":{"app.title":"Tiny RPG Studio","intro.byline":"por {author}","intro.startAdventure":"Iniciar aventura","tabs.game":"Jogo","tabs.editor":"Editor","sections.tiles":"Tiles","sections.world":"Mundo","sections.objects":"Objetos","sections.npcs":"NPCs","sections.enemies":"Inimigos","sections.project":"Projeto","buttons.reset":"Reiniciar","buttons.newGame":"Novo jogo","buttons.remove":"Remover","aria.reset":"Reiniciar a partida atual","aria.newGame":"Criar um novo jogo do zero em outra aba","touchControls.show":"Exibir controles","touchControls.hide":"Ocultar controles","touchControls.upLabel":"Mover para cima","touchControls.downLabel":"Mover para baixo","touchControls.leftLabel":"Mover para a esquerda","touchControls.rightLabel":"Mover para a direita","doors.variableLocked":"NÃ£o abre com chave.","doors.openedRemaining":"VocÃª usou uma chave para abrir a porta. Restam: {value}.","doors.opened":"VocÃª usou uma chave para abrir a porta.","doors.locked":"Porta trancada. Precisa de uma chave.","doors.unlockedSkill":"Sua habilidade abriu a porta sem usar chave.","log.engineReady":"Tiny RPG Studio engine initialized successfully.","npc.dialog.defaultLabel":"DiÃ¡logo padrÃ£o:","npc.dialog.placeholder":"Digite o diÃ¡logo do NPC...","npc.reward.defaultLabel":"Ao concluir o diÃ¡logo padrÃ£o, ativar variÃ¡vel:","npc.toggle.create":"Criar diÃ¡logo alternativo","npc.toggle.hide":"Ocultar diÃ¡logo alternativo","npc.conditional.variableLabel":"VariÃ¡vel para diÃ¡logo alternativo:","npc.conditional.textLabel":"Texto alternativo:","npc.conditional.placeholder":"Mensagem exibida quando a variÃ¡vel estiver ON.","npc.conditional.rewardLabel":"Ao concluir o diÃ¡logo alternativo, ativar variÃ¡vel:","npc.delete":"Remover NPC","npc.defaultName":"NPC","npc.variant.label":"AparÃªncia dos NPCs","npc.variant.human":"Humano","npc.variant.elf":"Elfo","npc.variant.dwarf":"AnÃ£o","npc.variant.fixed":"Extras","npcs.names.oldMage":"Velho Mago","npcs.names.oldMage.human":"Velho Mago","npcs.names.oldMage.elf":"Velho Mago","npcs.names.oldMage.dwarf":"Velho Mago","npcs.names.villagerMan":"Homem comum","npcs.names.villagerMan.human":"Homem comum","npcs.names.villagerMan.elf":"Homem comum","npcs.names.villagerMan.dwarf":"Homem comum","npcs.names.villagerWoman":"Mulher comum","npcs.names.villagerWoman.human":"Mulher comum","npcs.names.villagerWoman.elf":"Mulher comum","npcs.names.villagerWoman.dwarf":"Mulher comum","npcs.names.child":"CrianÃ§a curiosa","npcs.names.child.human":"CrianÃ§a curiosa","npcs.names.child.elf":"CrianÃ§a curiosa","npcs.names.child.dwarf":"CrianÃ§a curiosa","npcs.names.thoughtBubble":"BalÃ£o","npcs.names.woodenSign":"Placa de madeira","npcs.names.king":"Rei","npcs.names.king.human":"Rei","npcs.names.king.elf":"Rei","npcs.names.king.dwarf":"Rei","npcs.names.knight":"Cavaleiro","npcs.names.knight.human":"Cavaleiro","npcs.names.knight.elf":"Cavaleiro","npcs.names.knight.dwarf":"Cavaleiro","npcs.names.thief":"Ladra","npcs.names.thief.human":"Ladra","npcs.names.thief.elf":"Ladra","npcs.names.thief.dwarf":"Ladra","npcs.names.blacksmith":"Ferreira","npcs.names.blacksmith.human":"Ferreira","npcs.names.blacksmith.elf":"Ferreira","npcs.names.blacksmith.dwarf":"Ferreira","npcs.dialog.oldMage":"Eu guardo segredos antigos.","npcs.dialog.oldMage.human":"Eu guardo segredos antigos.","npcs.dialog.oldMage.elf":"As Ã¡rvores contam histÃ³rias para quem escuta.","npcs.dialog.oldMage.dwarf":"Lendas ecoam nas cavernas profundas.","npcs.dialog.villagerMan":"Bom dia! Posso ajudar?","npcs.dialog.villagerMan.human":"Bom dia! Posso ajudar?","npcs.dialog.villagerMan.elf":"Que a floresta guie seus passos.","npcs.dialog.villagerMan.dwarf":"Minhas mÃ£os conhecem martelo e picareta.","npcs.dialog.villagerWoman":"Que dia lindo para explorar.","npcs.dialog.villagerWoman.human":"Que dia lindo para explorar.","npcs.dialog.villagerWoman.elf":"As flores florescem com boas intenÃ§Ãµes.","npcs.dialog.villagerWoman.dwarf":"O som das forjas acalma o coraÃ§Ã£o.","npcs.dialog.child":"Vamos brincar de aventura!","npcs.dialog.child.human":"Vamos brincar de aventura!","npcs.dialog.child.elf":"Quer correr pelos bosques comigo?","npcs.dialog.child.dwarf":"Vamos cavar um tÃºnel secreto!","npcs.dialog.thoughtBubble":" ... ","npcs.dialog.woodenSign":"AtenÃ§Ã£o aos perigos Ã  frente.","npcs.dialog.king":"Proteja nosso reino!","npcs.dialog.king.human":"Proteja nosso reino!","npcs.dialog.king.elf":"Honre a natureza acima de tudo.","npcs.dialog.king.dwarf":"Defenda as minas com honra e aÃ§o.","npcs.dialog.knight":"Estou pronto para lutar.","npcs.dialog.knight.human":"Estou pronto para lutar.","npcs.dialog.knight.elf":"Luto para manter o verde vivo.","npcs.dialog.knight.dwarf":"Minha armadura ressoa como um tambor de guerra.","npcs.dialog.thief":"NinguÃ©m me pega no ato.","npcs.dialog.thief.human":"NinguÃ©m me pega no ato.","npcs.dialog.thief.elf":"Sou sombra entre galhos e folhas.","npcs.dialog.thief.dwarf":"Entre pedras e ouro, ninguÃ©m me vÃª chegar.","npcs.dialog.blacksmith":"Minhas forjas estÃ£o em brasas.","npcs.dialog.blacksmith.human":"Minhas forjas estÃ£o em brasas.","npcs.dialog.blacksmith.elf":"Forjo com madeira viva e aÃ§o leve.","npcs.dialog.blacksmith.dwarf":"AÃ§o e pedra; Ã© assim que se constrÃ³i.","npc.status.available":"DisponÃ­vel","npc.status.position":"Mapa ({col}, {row}) - ({x}, {y})","project.titleLabel":"Nome do jogo","project.titlePlaceholder":"Ex.: Lendas do Vale","project.authorLabel":"Autor","project.authorPlaceholder":"Seu nome ou estÃºdio","project.languageLabel":"Idioma","project.generateUrl":"Gerar URL do jogo","project.shareUrlLabel":"URL do jogo","project.generateHTML":"Exportar Projeto","project.variables.title":"VariÃ¡veis do jogo","project.variables.usage":"{used}/{total} usadas","project.variables.used":"Em uso","project.variables.unused":"Sem uso","project.variables.toggle.show":"Mostrar variÃ¡veis","project.variables.toggle.hide":"Esconder variÃ¡veis","project.skills.title":"Skills do jogo","project.skills.toggle.show":"Mostrar skills","project.skills.toggle.hide":"Esconder skills","project.skills.level":"NÃ­vel {value}","project.test.title":"Ajuda nos testes","project.test.toggle.show":"Mostrar","project.test.toggle.hide":"Esconder","project.test.hint":"Apenas para testar: essas opÃ§Ãµes nÃ£o entram na URL gerada.","project.test.startLevel":"Inicia com nÃ­vel","project.test.levelOption":"NÃ­vel {value}","project.test.skills":"Ativar skills no teste","project.test.godMode":"God mode (imortal)","project.shareHint":"Gere uma URL e compartilhe com seus amigos!","language.option.ptBR":"PortuguÃªs (Brasil)","language.option.enUS":"English (US)","history.undo":"Desfazer","history.redo":"Refazer","alerts.npc.full":"Todos os NPCs jÃ¡ estÃ£o no mapa.","alerts.npc.createError":"NÃ£o foi possÃ­vel criar o NPC.","alerts.npc.selectFirst":"Selecione um NPC para colocar.","alerts.npc.placeError":"NÃ£o foi possÃ­vel posicionar o NPC.","alerts.share.unavailable":"FunÃ§Ã£o de compartilhar nÃ£o estÃ¡ disponÃ­vel.","alerts.share.copied":"URL do jogo copiada para a Ã¡rea de transferÃªncia!","alerts.share.copyPrompt":"Copie a URL do seu jogo:","alerts.share.generateError":"NÃ£o foi possÃ­vel gerar a URL do jogo.","alerts.share.loadError":"NÃ£o foi possÃ­vel carregar o arquivo.","enemies.damageInfo":" - Dano: {value}","enemies.variableLabel":"VariÃ¡vel:","enemies.xpBarLabel":"Inimigos colocados","enemies.xpBarValue":"{current} / {total} inimigos","enemies.limitReached":"MÃ¡ximo de inimigos atingido","enemies.names.giantRat":"ðŸ€ Rato Gigante","enemies.names.bandit":"ðŸ§” Bandido","enemies.names.darkKnight":"âš”ï¸ Cavaleiro Negro","enemies.names.necromancer":"ðŸ§™â€â™‚ï¸ Necro","enemies.names.dragon":"ðŸ‰ DragÃ£o","enemies.names.skeleton":"ðŸ’€ Esqueleto","enemies.names.fallenKing":"ðŸ‘‘ Rei CaÃ­do","enemies.names.ancientDemon":"ðŸ˜ˆ DemÃ´nio AnciÃ£o","enemies.defeat.dragon":"Selo do DragÃ£o ativado!","enemies.defeat.fallenKing":"Selo Real despertou!","enemies.defeat.ancientDemon":"Selo DemonÃ­aco ativo!","variables.none":"Nenhuma","variables.skill.bard":"Habilidade: Bardo (falas extras)","objects.info.available":"DisponÃ­vel (1 por cenÃ¡rio)","objects.info.placed":"JÃ¡ no mapa (1 por cenÃ¡rio)","variables.names.var1":"Preto","variables.names.var2":"Azul Escuro","variables.names.var3":"Roxo","variables.names.var4":"Verde","variables.names.var5":"Marrom","variables.names.var6":"Cinza","variables.names.var7":"Azul Claro","variables.names.var8":"Rosa Choque","variables.names.var9":"Amarelo","objects.switch.variableLabel":"VariÃ¡vel associada:","objects.switch.stateLabel":"Estado atual: {state}","objects.state.on":"ON","objects.state.off":"OFF","objects.status.doorOpened":"Porta aberta","objects.status.keyCollected":"Chave coletada","objects.status.potionCollected":"PoÃ§Ã£o coletada","objects.status.scrollUsed":"Pergaminho usado","objects.status.swordBroken":"Espada quebrada","objects.status.gameEnd":"Final do jogo","objects.end.textLabel":"Mensagem final:","objects.end.placeholder":'Escreva a mensagem exibida antes de "The End"...',"objects.end.hint":"MÃ¡x. {max} caracteres.","objects.status.startMarker":"Marcador inicial","objects.label.door":"Porta","objects.label.doorVariable":"Porta mÃ¡gica","objects.label.playerStart":"InÃ­cio do Jogador","objects.label.playerEnd":"Fim do Jogo","objects.label.switch":"Alavanca","objects.label.key":"Chave","objects.label.lifePotion":"PoÃ§Ã£o de Vida","objects.label.sword":"Espada de AÃ§o","objects.label.swordBronze":"Espada de Bronze","objects.label.swordWood":"Espada de Madeira","objects.label.xpScroll":"Pergaminho de XP","objects.item.pickup":"VocÃª pegou um item.","objects.key.pickup.single":"VocÃª pegou uma chave.","objects.key.pickup.count":"VocÃª pegou uma chave. Agora vocÃª tem {value}.","objects.potion.used":"VocÃª usou uma poÃ§Ã£o de vida.","objects.xpScroll.read":"VocÃª leu um pergaminho de XP e ganhou {value} de experiÃªncia.","objects.xpScroll.levelUp":"NÃ­vel +{value}!","objects.switch.onMessage":"Alavanca ligada.","objects.switch.offMessage":"Alavanca desligada.","objects.sword.pickup.single":"VocÃª pegou uma {name}! Ela bloqueia 1 de dano no prÃ³ximo ataque inimigo.","objects.sword.pickup.multi":"VocÃª pegou uma {name}! Ela bloqueia {value} de dano somando os prÃ³ximos ataques inimigos.","combat.block.full":"Ataque bloqueado!","combat.block.partial":"Bloqueado -{value}","combat.stealthKill":"Abate furtivo!","combat.stealthMiss":"Errou o ataque furtivo!","combat.cooldown":"Invulneravel por um instante!","player.levelUp":"Level Up!","player.levelUp.value":"Level Up! NÃ­vel {value}","skills.levelUpTitle":"Escolha uma skill","skills.levelUpHint":"Use 1/2 ou â†‘ â†“","skills.pendingLabel":"+{value} escolha(s) na fila","skills.allUnlocked":"Todas as habilidades jÃ¡ foram aprendidas.","skills.pickupMessage":"VocÃª aprendeu {name}!","skills.keylessDoors.name":"Ladino","skills.keylessDoors.desc":"Portas sem chave.","skills.charisma.name":"Bardo","skills.charisma.desc":"Falas extras.","skills.necromancer.name":"Necromante","skills.necromancer.desc":"Renasce ao morrer.","skills.necromancer.revive":"VocÃª voltou da morte!","skills.necromancer.revivePrompt":"Voltar Ã  vida","gameOver.retryVictory":"Jogar de novo?","gameOver.retryDefeat":"Tentar novamente?","skills.stealth.name":"Assassino","skills.stealth.desc":"Toque inimigos fracos para abatÃª-los.","skills.waterWalker.name":"Monge das Ãguas","skills.waterWalker.desc":"Anda sobre Ã¡gua.","skills.lavaWalker.name":"Mago de Fogo","skills.lavaWalker.desc":"Anda sobre lava.","skills.potionMaster.name":"Alquimista","skills.potionMaster.desc":"PoÃ§Ãµes curam tudo.","skills.xpBoost.name":"Estudioso","skills.xpBoost.desc":"+50% de XP ganho.","skills.ironBody.name":"Cavaleiro de AÃ§o","skills.ironBody.desc":"-1 em todo dano recebido.","game.clearAllEnemies":"Matou todos os inimigos! As terras estÃ£o purificadas e sua forÃ§a de vida floresce.","enemy.defaultName":"Inimigo","world.badge.start":"Start","world.cell.title":"Mapa ({col}, {row})","editor.map.title":"Mapa","editor.mapNav.up":"Ir para cena acima","editor.mapNav.down":"Ir para cena abaixo","editor.mapNav.left":"Ir para cena Ã  esquerda","editor.mapNav.right":"Ir para cena Ã  direita","editor.mobileNav.label":"Selecionar seÃ§Ã£o do editor","editor.mobileNav.tiles":"Mostrar tiles","editor.mobileNav.world":"Mostrar mapa do mundo","editor.mobileNav.objects":"Mostrar objetos","editor.mobileNav.npcs":"Mostrar NPCs","editor.mobileNav.enemies":"Mostrar inimigos","editor.mobileNav.project":"Mostrar projeto","tiles.summaryFallback":"Tile {id}"},"en-US":{"app.title":"Tiny RPG Studio","intro.byline":"by {author}","intro.startAdventure":"Start adventure","tabs.game":"Game","tabs.editor":"Editor","sections.tiles":"Tiles","sections.world":"World","sections.objects":"Objects","sections.npcs":"NPCs","sections.enemies":"Enemies","sections.project":"Project","buttons.reset":"Reset","buttons.newGame":"New Game","buttons.remove":"Remove","aria.reset":"Restart the current run","aria.newGame":"Spin up a fresh project in a new tab","touchControls.show":"Show controls","touchControls.hide":"Hide controls","touchControls.upLabel":"Move up","touchControls.downLabel":"Move down","touchControls.leftLabel":"Move left","touchControls.rightLabel":"Move right","doors.variableLocked":"This door does not open with a key.","doors.openedRemaining":"You used a key to open the door. Remaining: {value}.","doors.opened":"You used a key to open the door.","doors.locked":"Door locked. You need a key.","doors.unlockedSkill":"Your skill opens the door without a key.","log.engineReady":"Tiny RPG Studio engine initialized successfully.","npc.dialog.defaultLabel":"Default dialogue:","npc.dialog.placeholder":"Type the NPC dialogue...","npc.reward.defaultLabel":"After the default dialogue, enable variable:","npc.toggle.create":"Create alternate dialogue","npc.toggle.hide":"Hide alternate dialogue","npc.conditional.variableLabel":"Variable for alternate dialogue:","npc.conditional.textLabel":"Alternate text:","npc.conditional.placeholder":"Message displayed when the variable is ON.","npc.conditional.rewardLabel":"After the alternate dialogue, enable variable:","npc.delete":"Remove NPC","npc.defaultName":"NPC","npc.variant.label":"NPC appearance","npc.variant.human":"Human","npc.variant.elf":"Elf","npc.variant.dwarf":"Dwarf","npc.variant.fixed":"Extras","npcs.names.oldMage":"Old Mage","npcs.names.villagerMan":"Common man","npcs.names.villagerMan.human":"Common man","npcs.names.villagerMan.elf":"Common man","npcs.names.villagerMan.dwarf":"Common man","npcs.names.villagerWoman":"Common woman","npcs.names.villagerWoman.human":"Common woman","npcs.names.villagerWoman.elf":"Common woman","npcs.names.villagerWoman.dwarf":"Common woman","npcs.names.child":"Curious child","npcs.names.child.human":"Curious child","npcs.names.child.elf":"Curious child","npcs.names.child.dwarf":"Curious child","npcs.names.thoughtBubble":"Balloon","npcs.names.woodenSign":"Wooden sign","npcs.names.king":"King","npcs.names.king.human":"King","npcs.names.king.elf":"King","npcs.names.king.dwarf":"King","npcs.names.knight":"Knight","npcs.names.knight.human":"Knight","npcs.names.knight.elf":"Knight","npcs.names.knight.dwarf":"Knight","npcs.names.thief":"Thief","npcs.names.thief.human":"Thief","npcs.names.thief.elf":"Thief","npcs.names.thief.dwarf":"Thief","npcs.names.blacksmith":"Blacksmith","npcs.names.blacksmith.human":"Blacksmith","npcs.names.blacksmith.elf":"Blacksmith","npcs.names.blacksmith.dwarf":"Blacksmith","npcs.dialog.oldMage":"I guard old secrets.","npcs.dialog.oldMage.human":"I guard old secrets.","npcs.dialog.oldMage.elf":"Trees whisper stories to careful ears.","npcs.dialog.oldMage.dwarf":"Legends echo through the deep caverns.","npcs.dialog.villagerMan":"Good morning! Can I help?","npcs.dialog.villagerMan.human":"Good morning! Can I help?","npcs.dialog.villagerMan.elf":"May the forest guide your steps.","npcs.dialog.villagerMan.dwarf":"My hands know hammers and pickaxes.","npcs.dialog.villagerWoman":"What a lovely day to explore.","npcs.dialog.villagerWoman.human":"What a lovely day to explore.","npcs.dialog.villagerWoman.elf":"Flowers bloom with good intentions.","npcs.dialog.villagerWoman.dwarf":"The sound of the forge calms my heart.","npcs.dialog.child":"Let's play adventure!","npcs.dialog.child.human":"Let's play adventure!","npcs.dialog.child.elf":"Want to race through the woods with me?","npcs.dialog.child.dwarf":"Let's dig a secret tunnel!","npcs.dialog.thoughtBubble":" ... ","npcs.dialog.woodenSign":"Beware of the dangers ahead.","npcs.dialog.king":"Defend our kingdom!","npcs.dialog.king.human":"Defend our kingdom!","npcs.dialog.king.elf":"Honor nature above all.","npcs.dialog.king.dwarf":"Guard the mines with steel and honor.","npcs.dialog.knight":"I am ready to fight.","npcs.dialog.knight.human":"I am ready to fight.","npcs.dialog.knight.elf":"I fight to keep the green alive.","npcs.dialog.knight.dwarf":"My armor thunders like a war drum.","npcs.dialog.thief":"No one catches me in the act.","npcs.dialog.thief.human":"No one catches me in the act.","npcs.dialog.thief.elf":"I am a shadow between leaves and branches.","npcs.dialog.thief.dwarf":"Among stone and gold, no one sees me coming.","npcs.dialog.blacksmith":"My forges are blazing hot.","npcs.dialog.blacksmith.human":"My forges are blazing hot.","npcs.dialog.blacksmith.elf":"I forge with living wood and light steel.","npcs.dialog.blacksmith.dwarf":"Steel and stone; that is how you build.","npc.status.available":"Available","npc.status.position":"Map ({col}, {row}) - ({x}, {y})","project.titleLabel":"Game name","project.titlePlaceholder":"Eg: Legends of the Vale","project.authorLabel":"Author","project.authorPlaceholder":"Your name or studio","project.languageLabel":"Language","project.generateUrl":"Generate share URL","project.shareUrlLabel":"Game URL","project.generateHTML":"Export Project","project.variables.title":"Game variables","project.variables.usage":"{used}/{total} used","project.variables.used":"In use","project.variables.unused":"Not used","project.variables.toggle.show":"Show variables","project.variables.toggle.hide":"Hide variables","project.skills.title":"Game skills","project.skills.toggle.show":"Show skills","project.skills.toggle.hide":"Hide skills","project.skills.level":"Level {value}","project.test.title":"Test helpers","project.test.toggle.show":"Show","project.test.toggle.hide":"Hide","project.test.hint":"Testing only: these options are not included in the share URL.","project.test.startLevel":"Start at level","project.test.levelOption":"Level {value}","project.test.skills":"Enable skills for testing","project.test.godMode":"God mode (immortal)","project.shareHint":"Generate a URL and share it with friends!","language.option.ptBR":"Portuguese (Brazil)","language.option.enUS":"English (US)","history.undo":"Undo","history.redo":"Redo","alerts.npc.full":"All NPCs are already on the map.","alerts.npc.createError":"Could not create this NPC.","alerts.npc.selectFirst":"Select an NPC before placing.","alerts.npc.placeError":"Could not place the NPC.","alerts.share.unavailable":"Share feature is not available.","alerts.share.copied":"Game URL copied to your clipboard!","alerts.share.copyPrompt":"Copy your game URL:","alerts.share.generateError":"Unable to generate the game URL.","alerts.share.loadError":"Unable to load the file.","enemies.damageInfo":" - Damage: {value}","enemies.variableLabel":"Variable:","enemies.xpBarLabel":"Enemies placed","enemies.xpBarValue":"{current} / {total} enemies","enemies.limitReached":"Max enemies reached","enemies.names.giantRat":"ðŸ€ Giant Rat","enemies.names.bandit":"ðŸ§” Bandit","enemies.names.darkKnight":"âš”ï¸ Dark Knight","enemies.names.necromancer":"ðŸ§™â€â™‚ï¸ Necromancer","enemies.names.dragon":"ðŸ‰ Dragon","enemies.names.skeleton":"ðŸ’€ Skeleton","enemies.names.fallenKing":"ðŸ‘‘ Fallen King","enemies.names.ancientDemon":"ðŸ˜ˆ Ancient Demon","enemies.defeat.dragon":"Dragon Seal activated!","enemies.defeat.fallenKing":"Royal Seal awakened!","enemies.defeat.ancientDemon":"Demonic Seal is active!","variables.none":"None","variables.skill.bard":"Skill: Bard (alternate lines)","objects.info.available":"Available (1 per scene)","objects.info.placed":"Already on the map (1 per scene)","variables.names.var1":"Black","variables.names.var2":"Dark Blue","variables.names.var3":"Purple","variables.names.var4":"Green","variables.names.var5":"Brown","variables.names.var6":"Gray","variables.names.var7":"Light Blue","variables.names.var8":"Hot Pink","variables.names.var9":"Yellow","objects.switch.variableLabel":"Linked variable:","objects.switch.stateLabel":"Current state: {state}","objects.state.on":"ON","objects.state.off":"OFF","objects.status.doorOpened":"Door opened","objects.status.keyCollected":"Key collected","objects.status.potionCollected":"Potion collected","objects.status.scrollUsed":"Scroll used","objects.status.swordBroken":"Sword broken","objects.status.gameEnd":"End of game","objects.end.textLabel":"Final message:","objects.end.placeholder":'Type the message shown before "The End"...',"objects.end.hint":"Max {max} characters.","objects.status.startMarker":"Start marker","objects.label.door":"Door","objects.label.doorVariable":"Magic door","objects.label.playerStart":"Player start","objects.label.playerEnd":"Game end","objects.label.switch":"Switch","objects.label.key":"Key","objects.label.lifePotion":"Health potion","objects.label.sword":"Steel sword","objects.label.swordBronze":"Bronze sword","objects.label.swordWood":"Wooden sword","objects.label.xpScroll":"XP scroll","objects.item.pickup":"You picked up an item.","objects.key.pickup.single":"You picked up a key.","objects.key.pickup.count":"You picked up a key. You now have {value}.","objects.potion.used":"You used a health potion.","objects.xpScroll.read":"You read an XP scroll and gained {value} experience.","objects.xpScroll.levelUp":"Level +{value}!","objects.switch.onMessage":"Switch turned on.","objects.switch.offMessage":"Switch turned off.","objects.sword.pickup.single":"You picked up a {name}! It blocks 1 damage from the next enemy attack.","objects.sword.pickup.multi":"You picked up a {name}! It blocks {value} damage across upcoming enemy attacks.","combat.block.full":"Attack blocked!","combat.block.partial":"Blocked -{value}","combat.stealthKill":"Stealth kill!","combat.stealthMiss":"Stealth strike missed!","combat.cooldown":"Invulnerable for a moment!","player.levelUp":"Level Up!","player.levelUp.value":"Level Up! Level {value}","skills.levelUpTitle":"Pick a skill","skills.levelUpHint":"Use 1/2 or â†‘ â†“","skills.pendingLabel":"+{value} pick(s) queued","skills.allUnlocked":"All skills already unlocked.","skills.pickupMessage":"You learned {name}!","skills.keylessDoors.name":"Rogue","skills.keylessDoors.desc":"Locked doors open without spending keys.","skills.charisma.name":"Bard","skills.charisma.desc":"Unlock alternate NPC dialogues.","skills.necromancer.name":"Necromancer","skills.necromancer.desc":"Automatically revive once after death.","skills.necromancer.revive":"You returned from death!","skills.necromancer.revivePrompt":"Return to life","gameOver.retryVictory":"Play again?","gameOver.retryDefeat":"Try again?","skills.stealth.name":"Assassin","skills.stealth.desc":"Touch weak enemies for an instant kill.","skills.waterWalker.name":"Water Monk","skills.waterWalker.desc":"Water tiles stop blocking your path.","skills.lavaWalker.name":"Fire Mage","skills.lavaWalker.desc":"Stride over lava without harm.","skills.potionMaster.name":"Alchemist","skills.potionMaster.desc":"Health potions restore all HP.","skills.xpBoost.name":"Scholar","skills.xpBoost.desc":"+50% experience gain.","skills.ironBody.name":"Iron Knight","skills.ironBody.desc":"-1 to every incoming hit.","game.clearAllEnemies":"You felled every foe. The land is cleansed and your life force swells.","enemy.defaultName":"Enemy","world.badge.start":"Start","world.cell.title":"Map ({col}, {row})","editor.map.title":"Map","editor.mapNav.up":"Go to scene above","editor.mapNav.down":"Go to scene below","editor.mapNav.left":"Go to scene on the left","editor.mapNav.right":"Go to scene on the right","editor.mobileNav.label":"Select editor section","editor.mobileNav.tiles":"Show tiles","editor.mobileNav.world":"Show world map","editor.mobileNav.objects":"Show objects","editor.mobileNav.npcs":"Show NPCs","editor.mobileNav.enemies":"Show enemies","editor.mobileNav.project":"Show project","tiles.summaryFallback":"Tile {id}"}},getStrings(m=this.locale){return this.bundles[m]||this.bundles[this.defaultLocale]||{}},detectBrowserLocale(){if(typeof navigator>"u")return this.defaultLocale;const m=Array.isArray(navigator.languages)&&navigator.languages.length?navigator.languages:[navigator.language||navigator.userLanguage||this.defaultLocale];for(const e of m){if(e&&this.bundles[e])return e;const t=String(e||"").split("-")[0],a=Object.keys(this.bundles).find(n=>n.startsWith(t));if(a)return a}return this.defaultLocale},setLocale(m,{silent:e=!1,root:t}={}){return!m||!this.bundles[m]?!1:(this.locale=m,e||(this.apply(t),document.dispatchEvent(new CustomEvent("language-changed",{detail:{locale:this.locale}}))),!0)},getLocale(){return this.locale},extend(m,e={}){if(!m||typeof e!="object")return;const t=this.bundles[m]||{};this.bundles[m]={...t,...e},m===this.locale&&this.apply()},get(m,e=""){if(!m)return e||"";const t=this.getStrings(this.locale);if(Object.prototype.hasOwnProperty.call(t,m))return t[m];if(this.locale!==this.defaultLocale){const a=this.getStrings(this.defaultLocale);if(Object.prototype.hasOwnProperty.call(a,m))return a[m]}return e||m||""},format(m,e={},t=""){const a=this.get(m,t);return a?a.replace(/\{(\w+)\}/g,(n,i)=>Object.prototype.hasOwnProperty.call(e,i)?e[i]:""):t||m||""},apply(m=typeof document<"u"?document:null){!m||typeof m.querySelectorAll!="function"||(m.querySelectorAll("[data-text-key]").forEach(e=>{const t=e.getAttribute("data-text-key"),a=this.get(t,e.textContent);a!==void 0&&(e.textContent=a)}),m.querySelectorAll("[data-placeholder-key]").forEach(e=>{const t=e.getAttribute("data-placeholder-key"),a=this.get(t,e.getAttribute("placeholder")||"");a&&e.setAttribute("placeholder",a)}),m.querySelectorAll("[data-aria-label-key]").forEach(e=>{const t=e.getAttribute("data-aria-label-key"),a=this.get(t,e.getAttribute("aria-label")||"");a&&e.setAttribute("aria-label",a)}),m.querySelectorAll("[data-title-key]").forEach(e=>{const t=e.getAttribute("data-title-key"),a=this.get(t,e.getAttribute("title")||"");a&&e.setAttribute("title",a)}))}};typeof window<"u"?(window.TextResources=de,document.addEventListener("DOMContentLoaded",()=>{const m=de.detectBrowserLocale();de.setLocale(m,{silent:!0}),de.apply()})):typeof globalThis<"u"&&(globalThis.TextResources=de);let nt=class{static SKILLS=[{id:"keyless-doors",nameKey:"skills.keylessDoors.name",descriptionKey:"skills.keylessDoors.desc",icon:"ðŸ”‘"},{id:"charisma",nameKey:"skills.charisma.name",descriptionKey:"skills.charisma.desc",icon:"ðŸ—£ï¸"},{id:"necromancer",nameKey:"skills.necromancer.name",descriptionKey:"skills.necromancer.desc",icon:"â˜ ï¸"},{id:"stealth",nameKey:"skills.stealth.name",descriptionKey:"skills.stealth.desc",icon:"ðŸ•¶ï¸"},{id:"lava-walker",nameKey:"skills.lavaWalker.name",descriptionKey:"skills.lavaWalker.desc",icon:"ðŸ”¥"},{id:"potion-master",nameKey:"skills.potionMaster.name",descriptionKey:"skills.potionMaster.desc",icon:"ðŸ§ª"}];static LEVEL_SKILLS={2:["necromancer","charisma"],4:["stealth"],6:["potion-master"],8:["lava-walker"],10:["keyless-doors"]};static getAll(){return this.SKILLS}static getById(e){return typeof e!="string"||!e?null:this.SKILLS.find(t=>t.id===e)||null}static getSkillsForLevel(e){const t=Number.isFinite(e)?Math.max(1,Math.floor(e)):1,a=this.LEVEL_SKILLS[t]||[];if(!Array.isArray(a))return[];const n=[];return a.forEach(i=>{typeof i!="string"||!i||this.getById(i)&&(n.includes(i)||n.push(i))}),n}static buildQueueForLevel(e,t=[],a=[]){const n=Array.isArray(t)?t:[],i=new Set(Array.isArray(a)?a:[]),r=this.getSkillsForLevel(e),s=[];return[...n,...r].forEach(l=>{typeof l!="string"||!l||i.has(l)||this.getById(l)&&(s.includes(l)||s.push(l))}),s.length||this.getAll().forEach(l=>{!i.has(l.id)&&!s.includes(l.id)&&s.push(l.id)}),s}static pickRandom(e=2,t=[]){const a=Array.isArray(t)?t:[],n=this.getAll().filter(r=>!a.includes(r.id));if(!n.length)return[];const i=this.shuffle(n);return i.slice(0,Math.max(1,Math.min(e,i.length)))}static shuffle(e){const t=Array.isArray(e)?e.slice():[];for(let a=t.length-1;a>0;a--){const n=Math.floor(Math.random()*(a+1));[t[a],t[n]]=[t[n],t[a]]}return t}};typeof window<"u"&&(window.SkillDefinitions=nt);let it=class{constructor(){this.game={title:"My Tiny RPG Game",author:"",palette:["#000000","#1D2B53","#FFF1E8"],roomSize:8,world:{rows:3,cols:3},rooms:StateWorldManager.createWorldRooms(3,3,8),start:{x:1,y:1,roomIndex:0},sprites:[],enemies:[],items:[],objects:[],variables:[],exits:[],tileset:{tiles:[],maps:Array.from({length:9},()=>StateWorldManager.createEmptyTileMap(8))}},this.game.tileset.map=this.game.tileset.maps[0],this.state={player:{x:1,y:1,lastX:1,roomIndex:0,level:1,maxLives:3,currentLives:3,lives:3,keys:0,experience:0,damageShield:0,damageShieldMax:0,swordType:null,lastDamageReduction:0,godMode:!1},dialog:{active:!1,text:"",page:1,maxPages:1,meta:null},enemies:[],variables:[],gameOver:!1,gameOverReason:null,pickupOverlay:{active:!1,name:"",spriteGroup:null,spriteType:null,effect:null},levelUpOverlay:{active:!1,choices:[],cursor:0},levelUpCelebration:{active:!1,level:null,startTime:0,timeoutId:0,durationMs:3e3},skillRuntime:null},this.testSettings=this.createDefaultTestSettings(),this.worldManager=new StateWorldManager(this.game,8),this.variableManager=new StateVariableManager(this.game,this.state),this.objectManager=new StateObjectManager(this.game,this.worldManager,this.variableManager),this.enemyManager=new StateEnemyManager(this.game,this.state,this.worldManager),this.skillManager=new StateSkillManager(this.state),this.playerManager=new StatePlayerManager(this.state,this.worldManager,this.skillManager),this.playerManager.setSkillManager?.(this.skillManager),this.dialogManager=new StateDialogManager(this.state),this.itemManager=new StateItemManager(this.game),this.worldFacade=new GameStateWorldFacade(this,this.worldManager),this.playerFacade=new GameStatePlayerFacade(this,this.playerManager),this.screenManager=new GameStateScreenManager(this),this.dataManager=new StateDataManager({game:this.game,worldManager:this.worldManager,objectManager:this.objectManager,variableManager:this.variableManager}),this.dataFacade=new GameStateDataFacade(this,this.dataManager),this.playing=!1,this.lifecycle=new GameStateLifecycle(this,this.screenManager,{timeToResetAfterGameOver:2e3}),this.ensureDefaultVariables(),this.resetGame(),this.reviveSnapshot=null,this.editorMode=!1,document.addEventListener("game-tab-activated",()=>{this.setEditorMode(!1)}),document.addEventListener("editor-tab-activated",()=>{this.setEditorMode(!0)})}createEmptyRoom(e,t=0,a=1){return this.worldFacade.createEmptyRoom(e,t,a)}createWorldRooms(e,t,a){return this.worldFacade.createWorldRooms(e,t,a)}createEmptyTileMap(e){return this.worldFacade.createEmptyTileMap(e)}getGame(){return this.game}getState(){return this.state}getCurrentRoom(){const e=this.worldManager.clampRoomIndex(this.state.player.roomIndex);return this.state.player.roomIndex=e,this.game.rooms[e]}getPlayer(){return this.playerFacade.getPlayer()}getSkills(){return this.skillManager.getOwnedSkills()}hasSkill(e){return this.skillManager.hasSkill(e)}getPendingLevelUpChoices(){return this.skillManager.getPendingSelections()}getMaxPlayerLevel(){return this.playerManager?.maxLevel??1}isLevelUpOverlayActive(){return this.skillManager.isOverlayActive()}getLevelUpOverlay(){return this.skillManager.getOverlay()}startLevelUpSelectionIfNeeded(){if(this.isLevelUpCelebrationActive())return null;this.skillManager.hasPendingSelections()&&!this.skillManager.isOverlayActive()&&this.skillManager.startLevelSelection()&&this.pauseGame("level-up")}queueLevelUpChoices(e=1,t=null){return this.skillManager.queueLevelUps(e,t),this.startLevelUpSelectionIfNeeded(),this.skillManager.getPendingSelections()}moveLevelUpCursor(e=0){return this.skillManager.moveCursor(e)}selectLevelUpSkill(e=null){if(!this.skillManager.isOverlayActive())return null;const t=this.skillManager.completeSelection(e);return t?.id==="max-life"&&this.playerManager.healToFull(),t?.id,this.skillManager.hasPendingSelections()?this.skillManager.startLevelSelection()&&this.pauseGame("level-up"):this.resumeGame("level-up"),t}consumeRecentReviveFlag(){return this.skillManager.consumeRecentReviveFlag()}getDialog(){return this.dialogManager.getDialog()}setPlayerPosition(e,t,a=null){this.playerFacade.setPlayerPosition(e,t,a)}setDialog(e,t="",a=null){this.dialogManager.setDialog(e,t,a)}setDialogPage(e){this.dialogManager.setPage(e)}setEditorMode(e=!1){this.editorMode=!!e}isEditorModeActive(){return!!this.editorMode}createDefaultTestSettings(){return{startLevel:1,skills:[],godMode:!1}}getTestSettings(){return this.testSettings||(this.testSettings=this.createDefaultTestSettings()),{startLevel:Number.isFinite(this.testSettings.startLevel)?Math.floor(this.testSettings.startLevel):1,skills:Array.isArray(this.testSettings.skills)?this.testSettings.skills.slice():[],godMode:!!this.testSettings.godMode}}setTestSettings(e={}){const t=this.getTestSettings(),a=this.playerManager?.maxLevel??10,n=Number.isFinite(e.startLevel)?Math.max(1,Math.min(a,Math.floor(e.startLevel))):t.startLevel,i=typeof SkillDefinitions<"u"?SkillDefinitions.getAll?.()||[]:[],r=new Set(i.map(c=>c.id)),s=Array.isArray(e.skills)?e.skills.map(c=>typeof c=="string"?c:null).filter(c=>c&&r.has(c)):t.skills,l=Array.from(new Set(s)),o=e.godMode!==void 0?!!e.godMode:t.godMode;return this.testSettings={startLevel:n,skills:l,godMode:o},this.getTestSettings()}applyTestSettingsRuntime(){const e=this.getTestSettings(),t=Number.isFinite(e.startLevel)?e.startLevel:1;this.playerManager?.setLevel&&this.playerManager.setLevel(t),Array.isArray(e.skills)&&e.skills.length&&e.skills.forEach(a=>this.skillManager?.addSkill?.(a)),this.playerManager?.ensurePlayerStats?.(),this.playerManager?.setGodMode?.(e.godMode)}resetGame(){this.screenManager.reset(),this.skillManager.resetRuntime(),this.playerFacade.resetPlayer(),this.dialogManager.reset(),this.enemyManager.resetRuntime(),this.variableManager.resetRuntime(),this.itemManager.resetItems(),this.objectManager.resetRuntime(),this.objectManager.ensurePlayerStartObject(),this.applyTestSettingsRuntime(),this.setGameOver(!1),this.hidePickupOverlay(),this.clearNecromancerRevive(),this.hideLevelUpCelebration({skipResume:!0}),this.resumeGame("game-over")}exportGameData(){return this.dataFacade.exportGameData()}importGameData(e){this.dataFacade.importGameData(e)}normalizeRooms(e,t,a){return this.worldFacade.normalizeRooms(e,t,a)}normalizeTileMaps(e,t){return this.worldFacade.normalizeTileMaps(e,t)}normalizeObjects(e){return this.objectManager.normalizeObjects(e)}cloneEnemies(e){return this.enemyManager.cloneEnemies(e)}generateObjectId(e,t){return this.objectManager.generateObjectId(e,t)}getObjects(){return this.objectManager.getObjects()}getObjectsForRoom(e){return this.objectManager.getObjectsForRoom(e)}getObjectAt(e,t,a){return this.objectManager.getObjectAt(e,t,a)}setObjectPosition(e,t,a,n){return this.objectManager.setObjectPosition(e,t,a,n)}removeObject(e,t){this.objectManager.removeObject(e,t)}setObjectVariable(e,t,a){return this.objectManager.setObjectVariable(e,t,a)}setPlayerEndText(e,t){return this.objectManager.setPlayerEndText(e,t)}getPlayerEndText(e=null){return this.objectManager.getPlayerEndText(e)}setActiveEndingText(e=""){return this.screenManager.setActiveEndingText(e)}getActiveEndingText(){return this.screenManager.getActiveEndingText()}addKeys(e=1){return this.playerFacade.addKeys(e)}addLife(e=1){return this.playerFacade.addLife(e)}addBonusMaxLife(e=1){const t=this.skillManager.addBonusMaxLife?.(e);return this.healPlayerToFull(),t}addDamageShield(e=1,t=null){return this.playerFacade.addDamageShield(e,t)}getDamageShield(){return this.playerFacade.getDamageShield()}getDamageShieldMax(){return this.playerFacade.getDamageShieldMax()}getSwordType(){return this.playerFacade.getSwordType()}consumeKey(){return this.playerFacade.consumeKey()}getKeys(){return this.playerFacade.getKeys()}getMaxKeys(){return this.playerFacade.getMaxKeys()}consumeLastDamageReduction(){return this.playerFacade.consumeLastDamageReduction()}ensureDefaultVariables(){return this.variableManager.ensureDefaultVariables()}cloneVariables(e){return this.variableManager.cloneVariables(e)}normalizeVariables(e){return this.variableManager.normalizeVariables(e)}getVariableDefinitions(){return this.variableManager.getVariableDefinitions()}getVariables(){return this.variableManager.getVariables()}normalizeVariableId(e){return this.variableManager.normalizeVariableId(e)}getVariable(e){return this.variableManager.getVariable(e)}isVariableOn(e){return this.variableManager.isVariableOn(e)}setVariableValue(e,t,a=!1){const n=this.variableManager.setVariableValue(e,t,a);let i=!1;return n&&(i=this.objectManager.checkOpenedMagicDoor(e,t),this.objectManager.syncSwitchState?.(e,t)),[n,i]}getEnemies(){return this.enemyManager.getEnemies()}getEnemyDefinitions(){return this.enemyManager.getEnemyDefinitions()}clampRoomIndex(e){return this.worldManager.clampRoomIndex(e)}clampCoordinate(e){return this.worldManager.clampCoordinate(e)}getWorldRows(){return this.worldManager.getWorldRows()}getWorldCols(){return this.worldManager.getWorldCols()}getRoomCoords(e){return this.worldManager.getRoomCoords(e)}getRoomIndex(e,t){return this.worldManager.getRoomIndex(e,t)}addEnemy(e){return this.enemyManager.addEnemy(e)}removeEnemy(e){this.enemyManager.removeEnemy(e)}setEnemyPosition(e,t,a,n=null){this.enemyManager.setEnemyPosition(e,t,a,n)}setEnemyVariable(e,t=null){const a=this.normalizeVariableId(t);return this.enemyManager.setEnemyVariable(e,a)}damagePlayer(e=1){return this.playerFacade.damage(e)}isPlayerOnDamageCooldown(){return this.playerFacade.isOnDamageCooldown()}getLives(){return this.playerFacade.getLives()}getMaxLives(){return this.playerFacade.getMaxLives()}getLevel(){return this.playerFacade.getLevel()}healPlayerToFull(){return this.playerFacade.healPlayerToFull()}getExperience(){return this.playerFacade.getExperience()}getExperienceToNext(){return this.playerFacade.getExperienceToNext()}addExperience(e=0){const t=this.playerFacade.addExperience(e);return this.processLevelUpResult(t)}handleEnemyDefeated(e=0){const t=this.playerFacade.handleEnemyDefeated(e);return this.processLevelUpResult(t)}processLevelUpResult(e=null){if(e?.leveledUp){this.showLevelUpCelebration(e.level);const t=Number.isFinite(e.levelsGained)?Math.max(1,Math.floor(e.levelsGained)):1;this.queueLevelUpChoices(t,e.level)}return e}getPickupOverlay(){return this.state.pickupOverlay||(this.state.pickupOverlay={active:!1,name:"",spriteGroup:null,spriteType:null,effect:null}),this.state.pickupOverlay}showPickupOverlay(e={}){const t=this.getPickupOverlay();t.active=!0,t.name=e.name||e.title||"",t.spriteGroup=e.spriteGroup||null,t.spriteType=e.spriteType||null,t.effect=typeof e.effect=="function"?e.effect:null,this.pauseGame("pickup-overlay")}hidePickupOverlay(){const e=this.getPickupOverlay();if(!e.active)return;e.active=!1;const t=e.effect;if(e.effect=null,e.name="",e.spriteGroup=null,e.spriteType=null,typeof t=="function")try{t()}catch(a){console.error("Pickup overlay effect error:",a)}this.resumeGame("pickup-overlay")}isPickupOverlayActive(){return!!this.getPickupOverlay().active}getLevelUpCelebration(){return this.state.levelUpCelebration||(this.state.levelUpCelebration={active:!1,level:null,startTime:0,timeoutId:0,durationMs:3e3}),this.state.levelUpCelebration}showLevelUpCelebration(e=null,t={}){const a=this.getLevelUpCelebration(),n=Number.isFinite(e)?Math.max(1,Math.floor(e)):this.getLevel();a.active=!0,a.level=n,a.startTime=this.getNow(),a.durationMs=Number.isFinite(t.durationMs)?Math.max(300,Math.floor(t.durationMs)):a.durationMs||3e3,a.timeoutId&&(clearTimeout(a.timeoutId),a.timeoutId=0);const i=a.durationMs||3e3;a.timeoutId=setTimeout(()=>this.hideLevelUpCelebration(),i),this.pauseGame("level-up-celebration")}hideLevelUpCelebration({skipResume:e=!1}={}){const t=this.getLevelUpCelebration();t.timeoutId&&(clearTimeout(t.timeoutId),t.timeoutId=0);const a=t.active;t.active=!1,t.level=null,t.startTime=0,t.durationMs=t.durationMs||3e3,a&&!e&&(this.resumeGame("level-up-celebration"),this.startLevelUpSelectionIfNeeded())}isLevelUpCelebrationActive(){return!!this.getLevelUpCelebration().active}getNow(){return typeof performance<"u"&&performance.now?performance.now():Date.now()}enableGameOverInteraction(){this.screenManager.clearGameOverCooldown?.(),this.screenManager.canResetAfterGameOver=!0}prepareNecromancerRevive(){return this.skillManager.hasPendingManualRevive?.()?(this.reviveSnapshot=this.captureReviveSnapshot(),!!this.reviveSnapshot):!1}hasNecromancerReviveReady(){return!!(this.skillManager.hasPendingManualRevive?.()&&this.reviveSnapshot)}reviveFromNecromancer(){if(!this.hasNecromancerReviveReady())return!1;const e=this.restoreReviveSnapshot(this.reviveSnapshot);if(this.reviveSnapshot=null,!e||!this.skillManager.consumeManualRevive?.())return!1;if(this.state?.player){const a=Number.isFinite(this.state.player.maxLives)?Math.max(1,Math.floor(this.state.player.maxLives)):1;this.state.player.currentLives=a,this.state.player.lives=a}return this.lifecycle.setGameOver(!1,null),this.lifecycle.resumeGame("game-over"),this.screenManager.clearGameOverCooldown?.(),!0}clearNecromancerRevive(){this.reviveSnapshot=null,this.skillManager.clearManualReviveFlag?.()}captureReviveSnapshot(){try{const e=this.safeClone(this.game),t=this.safeClone(this.state);return{game:e,state:t}}catch(e){return console.error("Failed to capture revive snapshot",e),null}}restoreReviveSnapshot(e=null){if(!e?.game||!e?.state)return!1;try{return this.assignData(this.game,e.game),this.assignData(this.state,e.state),this.worldManager.setGame?.(this.game),this.objectManager.setGame?.(this.game),this.variableManager.setGame?.(this.game),this.itemManager.setGame?.(this.game),!0}catch(t){return console.error("Failed to restore revive snapshot",t),!1}}assignData(e,t){!e||!t||(Object.keys(e).forEach(a=>{delete e[a]}),Object.keys(t).forEach(a=>{e[a]=this.safeClone(t[a])}))}safeClone(e){return typeof structuredClone=="function"?structuredClone(e):JSON.parse(JSON.stringify(e))}pauseGame(e="manual"){this.lifecycle.pauseGame(e)}resumeGame(e="manual"){this.lifecycle.resumeGame(e)}setGameOver(e=!0,t="defeat"){this.lifecycle.setGameOver(e,t)}isGameOver(){return this.lifecycle.isGameOver()}getGameOverReason(){return this.lifecycle.getGameOverReason()}get canResetAfterGameOver(){return this.screenManager.canResetAfterGameOver}};typeof window<"u"&&(window.GameState=it);const Re={"player-start":[[null,null,null,null,null,null,null,null],[null,1,1,1,1,1,1,null],[null,1,3,3,3,3,1,null],[null,1,3,3,11,3,1,null],[null,1,3,11,3,3,1,null],[null,1,3,3,3,3,1,null],[null,1,1,1,1,1,1,null],[null,null,null,null,null,null,null,null]],"player-end":[[null,null,null,null,null,null,null,null],[null,1,1,1,1,1,1,null],[null,1,2,2,2,2,1,null],[null,1,2,2,14,2,1,null],[null,1,2,14,2,2,1,null],[null,1,2,2,2,2,1,null],[null,1,1,1,1,1,1,null],[null,null,null,null,null,null,null,null]],switch:[[null,null,null,null,null,null,null,null],[8,null,null,null,null,null,null,null],[null,6,null,null,null,null,null,null],[null,null,6,null,null,null,null,null],[null,null,null,6,null,null,null,null],[null,null,6,1,1,6,null,null],[null,6,6,6,6,6,6,null],[null,null,null,null,null,null,null,null]],"switch--on":[[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,12],[null,null,null,null,null,null,6,null],[null,null,null,null,null,6,null,null],[null,null,null,null,6,null,null,null],[null,null,6,1,1,6,null,null],[null,6,6,6,6,6,6,null],[null,null,null,null,null,null,null,null]],key:[[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[10,10,7,null,null,null,null,null],[10,null,10,10,10,10,10,10],[9,9,9,null,null,9,null,9],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null]],door:[[null,4,4,4,4,4,4,null],[4,9,9,9,9,9,9,4],[4,9,9,9,9,9,9,4],[4,9,9,9,0,0,9,4],[4,9,9,9,0,0,9,4],[4,9,9,9,9,0,9,4],[4,9,9,9,9,9,9,4],[4,9,9,9,9,9,9,4]],"door-variable":[[null,7,null,7,null,7,null,7],[null,6,6,6,6,6,6,6],[null,6,13,6,13,6,13,6],[null,6,null,6,null,6,null,6],[null,6,null,6,null,6,null,5],[null,6,6,6,6,6,6,6],[null,6,13,6,13,6,13,6],[null,6,null,6,null,6,null,6]],"life-potion":[[null,null,1,1,1,1,null,null],[null,1,1,1,1,1,1,null],[null,null,6,null,null,6,null,null],[null,null,6,8,8,6,null,null],[null,6,8,8,8,8,6,null],[6,8,8,8,6,8,8,6],[null,6,8,6,8,8,6,null],[null,null,6,6,6,6,null,null]],"xp-scroll":[[null,null,null,null,null,null,null,null],[null,null,6,6,6,6,6,6],[null,null,6,1,1,1,6,0],[null,null,6,6,6,6,6,null],[null,null,6,1,1,1,6,null],[null,null,6,6,6,6,6,null],[null,0,6,1,1,6,6,null],[null,6,6,6,6,6,6,null]],sword:[[null,null,null,null,null,null,null,null],[6,6,null,null,null,null,null,null],[6,6,6,null,null,null,null,null],[null,6,6,6,null,null,null,null],[null,null,6,6,6,null,1,null],[null,null,null,6,8,1,1,null],[null,null,null,null,1,1,null,null],[null,null,null,1,1,null,1,null]],"sword-bronze":[[null,null,null,null,null,null,null,null],[9,9,null,null,null,null,null,null],[9,10,9,null,null,null,null,null],[null,9,9,10,null,null,null,null],[null,null,9,9,10,null,1,null],[null,null,null,9,9,1,1,null],[null,null,null,null,1,1,null,null],[null,null,null,1,1,null,1,null]],"sword-wood":[[null,null,null,null,null,null,null,null],[4,4,null,null,null,null,null,null],[4,5,4,null,null,null,null,null],[null,4,4,5,null,null,null,null],[null,null,4,4,5,null,1,null],[null,null,null,4,9,1,1,null],[null,null,null,null,1,1,null,null],[null,null,null,1,1,null,1,null]]};typeof window<"u"&&(window.ObjectSpriteMatrices=Re);const Ne={default:[[null,null,null,5,5,5,null,null],[null,null,5,5,5,5,5,null],[null,null,7,1,7,1,7,null],[5,null,7,7,7,7,7,null],[5,null,5,5,5,5,5,null],[5,7,6,5,5,5,6,null],[5,null,6,6,5,6,6,null],[5,null,6,6,6,6,6,null]],"default-elf":[[null,null,null,11,11,11,null,null],[null,null,11,7,11,7,11,null],[null,null,10,1,10,1,10,null],[11,null,10,11,11,10,11,null],[11,null,10,7,7,10,10,null],[11,10,11,10,10,11,10,null],[11,null,10,10,11,10,10,null],[11,null,10,10,10,10,10,null]],"default-dwarf":[[null,null,null,4,4,4,null,null],[null,null,4,4,4,4,4,null],[null,null,9,9,9,9,9,null],[4,null,9,4,4,9,4,null],[4,null,9,4,4,9,4,null],[4,9,4,9,4,9,4,null],[4,null,9,9,4,9,9,null],[4,null,9,9,9,9,9,null]],"old-mage":[[null,1,1,1,1,1,null,null],[1,4,6,6,6,6,1,null],[1,4,15,12,15,12,1,null],[1,4,15,15,15,15,5,1],[1,15,5,6,6,6,15,1],[1,4,5,6,6,6,1,null],[1,4,5,5,6,6,1,null],[1,4,5,5,5,5,1,null]],"old-mage-elf":[[1,15,10,10,10,10,15,1],[1,15,15,12,15,12,15,1],[1,4,15,15,15,15,1,null],[1,4,10,10,10,10,5,1],[1,4,5,10,10,10,5,1],[1,15,5,5,10,10,15,null],[1,4,5,5,5,5,1,null],[1,4,5,5,5,5,1,null]],"old-mage-dwarf":[[null,1,null,null,null,null,null,null],[1,2,1,1,1,1,null,null],[1,4,6,6,6,6,1,null],[1,4,15,9,15,9,1,null],[1,4,15,15,15,15,1,null],[1,4,5,6,6,6,5,1],[1,15,5,5,6,6,15,1],[1,4,13,1,1,13,1,null]],"villager-man":[[null,null,1,1,1,1,null,null],[null,1,15,15,15,15,1,null],[null,1,15,12,15,12,1,null],[null,1,15,15,15,15,1,null],[1,4,4,4,4,4,4,1],[1,15,4,4,4,4,15,1],[null,1,9,9,9,9,1,null],[null,1,9,1,1,9,1,null]],"villager-man-elf":[[1,15,10,10,10,10,15,1],[1,10,15,12,15,12,10,1],[null,1,15,15,15,15,1,null],[1,11,11,9,9,11,11,1],[1,11,11,11,9,11,11,1],[1,15,11,11,9,11,15,1],[null,1,11,11,9,11,1,null],[null,1,11,11,9,11,1,null]],"villager-man-dwarf":[[null,null,null,null,null,null,null,null],[null,null,1,1,1,1,null,null],[null,1,5,5,5,5,1,null],[null,1,15,9,15,9,1,null],[null,1,15,15,15,15,1,null],[1,4,4,5,5,5,4,1],[1,15,4,4,5,5,15,1],[null,1,9,1,1,9,1,null]],"villager-woman":[[null,null,1,1,1,1,null,null],[null,1,4,4,4,4,1,null],[null,1,4,12,15,12,1,null],[null,1,4,15,15,15,1,null],[1,14,4,14,14,14,14,1],[1,15,4,14,14,14,15,1],[null,1,14,14,14,14,1,null],[null,1,14,14,14,14,1,null]],"villager-woman-elf":[[1,15,10,10,10,10,15,1],[1,10,15,12,15,12,10,1],[1,10,15,15,15,15,10,1],[1,10,10,9,15,10,10,1],[1,11,10,11,9,10,11,1],[1,15,11,11,9,11,15,1],[null,1,11,11,9,11,1,null],[1,11,11,11,9,11,11,1]],"villager-woman-dwarf":[[null,null,null,null,null,null,null,null],[null,null,1,1,1,1,null,null],[null,1,5,5,5,5,1,null],[1,5,15,9,15,9,1,null],[1,5,15,15,15,15,1,null],[1,4,5,4,4,4,4,1],[1,15,5,4,4,4,15,1],[null,1,4,4,4,4,1,null]],child:[[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,1,1,1,1,null,null],[null,1,15,15,15,15,1,null],[null,1,15,12,15,12,1,null],[1,9,9,9,9,9,9,1],[1,15,9,9,9,9,15,1],[null,1,2,1,1,2,1,null]],"child-elf":[[null,null,null,null,null,null,null,null],[null,null,1,1,1,1,null,null],[null,1,10,10,10,10,1,null],[null,1,15,12,15,12,1,null],[null,1,15,15,15,15,1,null],[1,11,11,11,11,11,11,1],[1,15,11,11,11,11,15,1],[null,1,9,1,1,9,1,null]],"child-dwarf":[[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,1,1,1,1,null,null],[null,1,15,9,15,9,1,null],[null,1,15,15,15,15,1,null],[1,15,13,13,13,13,15,1],[null,1,2,1,1,2,1,null]],king:[[1,10,1,10,1,10,1,1],[1,9,9,9,9,9,1,10],[1,15,15,12,15,12,1,9],[1,15,15,15,15,15,1,9],[1,8,7,15,15,7,1,9],[1,8,8,7,8,8,8,15],[1,8,8,7,8,8,1,9],[1,7,7,7,7,7,1,9]],"king-elf":[[15,10,9,10,9,10,1,10],[15,10,15,12,15,12,1,9],[1,10,15,15,15,15,1,9],[1,11,9,15,15,9,1,9],[1,11,11,15,11,11,11,15],[1,11,11,10,11,11,1,9],[1,11,11,10,11,11,1,9],[1,10,10,10,10,10,1,9]],"king-dwarf":[[null,1,1,1,1,1,null,null],[1,10,9,10,9,10,1,1],[1,9,9,9,9,9,1,10],[1,5,15,9,15,9,1,9],[1,5,15,15,15,15,1,9],[1,4,4,5,5,5,4,15],[1,4,4,9,4,4,1,9],[1,9,9,9,9,9,1,9]],knight:[[null,null,1,1,1,1,null,null],[null,1,6,6,6,6,1,null],[null,1,6,12,15,12,1,null],[null,1,6,6,6,6,1,null],[1,5,5,6,6,5,5,1],[1,6,5,5,5,5,6,1],[null,1,6,6,6,6,1,null],[null,1,6,1,1,6,1,null]],"knight-elf":[[1,15,10,10,10,10,1,null],[1,15,10,12,15,12,1,null],[1,4,11,15,15,15,1,null],[4,11,11,15,15,11,11,1],[1,11,11,11,15,11,11,1],[1,15,11,11,11,11,15,1],[null,1,11,11,11,11,4,null],[null,1,11,1,1,11,1,null]],"knight-dwarf":[[null,null,null,null,null,null,null,null],[null,null,1,1,1,1,null,null],[null,1,4,4,4,4,1,null],[null,1,4,9,15,9,1,null],[1,4,4,4,4,4,4,1],[1,5,4,4,4,4,5,1],[null,1,9,9,9,9,1,null],[null,1,9,1,1,9,1,null]],thief:[[null,null,1,1,1,1,null,null],[null,1,5,5,5,5,1,null],[null,1,5,12,15,12,1,null],[null,1,5,5,5,5,1,null],[1,5,5,5,5,5,5,1],[1,15,5,5,5,5,15,1],[null,1,13,13,13,13,1,null],[null,1,13,1,1,13,1,null]],"thief-elf":[[1,15,10,10,10,10,15,1],[1,15,10,12,15,12,15,1],[1,10,15,15,15,15,10,1],[1,3,5,5,5,5,3,1],[1,5,5,5,5,5,5,1],[1,0,5,5,5,5,0,1],[1,10,5,5,5,5,10,1],[null,1,5,1,1,5,1,null]],"thief-dwarf":[[null,null,null,null,null,null,null,null],[null,null,1,1,1,1,null,null],[null,1,5,5,5,5,1,null],[null,1,5,9,15,9,1,null],[1,5,5,5,5,5,5,1],[1,15,5,5,5,5,15,1],[null,1,4,4,4,4,1,null],[null,1,4,1,1,4,1,null]],blacksmith:[[null,null,1,1,1,1,null,null],[null,1,15,15,15,15,1,null],[null,1,15,12,15,12,1,null],[null,1,15,15,15,15,1,null],[1,6,4,6,6,4,6,1],[1,15,4,4,4,4,15,1],[null,1,4,4,4,4,1,null],[null,1,5,1,1,5,1,null]],"blacksmith-elf":[[1,15,10,10,10,10,1,null],[1,15,10,12,15,12,1,null],[1,10,15,15,15,15,1,null],[1,6,11,6,6,11,6,1],[1,6,11,11,11,11,6,1],[1,15,11,11,11,11,15,1],[null,1,11,11,11,11,1,null],[null,1,11,1,1,11,1,null]],"blacksmith-dwarf":[[null,null,null,null,null,null,null,null],[null,null,1,1,1,1,null,null],[null,1,5,5,5,5,1,null],[null,1,15,9,15,9,1,null],[null,1,5,15,15,15,1,null],[1,6,4,5,5,5,6,1],[1,15,4,4,5,5,15,1],[null,1,4,1,1,4,1,null]],"wooden-sign":[[null,1,1,1,1,1,1,null],[1,4,4,4,4,4,4,1],[1,4,5,5,5,5,4,1],[1,4,4,4,4,4,4,1],[1,4,5,5,5,4,4,1],[1,4,4,4,4,4,4,1],[1,4,1,1,1,1,4,1],[1,4,1,null,null,1,4,1]],"thought-bubble":[[null,1,1,1,1,1,1,null],[1,6,6,6,6,6,6,1],[1,6,1,1,1,1,6,1],[1,6,6,6,6,6,6,1],[1,6,1,1,1,6,6,1],[1,6,6,6,6,6,6,1],[null,1,6,6,1,1,1,null],[null,1,6,1,null,null,null,null]]};typeof window<"u"&&(window.NpcSpriteMatrices=Ne);const Oe={default:[[null,null,6,null,null,null,6,null],[null,null,6,6,6,6,6,null],[null,null,6,6,8,6,8,null],[null,null,6,6,6,6,6,null],[null,null,1,1,6,1,1,null],[null,null,6,1,1,1,6,null],[null,null,null,1,1,1,null,null],[null,null,null,6,null,6,null,null]],"giant-rat":[[null,1,15,15,1,15,15,1],[null,1,15,15,1,15,15,1],[1,15,13,13,13,13,13,1],[1,15,13,8,13,8,13,1],[1,15,5,13,13,13,1,null],[1,5,5,5,15,1,null,null],[1,5,5,5,5,1,null,null],[1,15,1,1,15,1,null,null]],bandit:[[null,1,1,1,1,1,6,1],[1,15,15,15,15,1,7,1],[1,15,8,15,8,1,7,1],[1,4,4,4,4,5,6,1],[1,5,4,4,4,2,2,2],[1,5,5,4,5,1,4,1],[1,13,13,13,13,1,1,null],[1,13,1,1,13,1,null,null]],"dark-knight":[[null,1,1,1,1,null,1,null],[1,5,5,5,5,1,2,1],[1,5,8,5,8,1,2,1],[1,5,13,5,13,5,2,1],[1,13,5,13,5,14,14,1],[1,5,13,5,13,1,5,1],[1,5,5,13,5,1,1,null],[1,5,1,1,5,1,null,null]],necromancer:[[null,1,1,1,1,null,1,null],[1,15,15,15,15,1,8,1],[1,15,8,15,8,1,4,1],[1,15,15,15,15,1,4,1],[1,2,2,2,2,2,2,1],[1,2,2,2,2,2,4,1],[1,2,2,2,2,1,4,1],[1,2,2,2,2,2,4,1]],dragon:[[null,1,1,1,1,1,1,null],[1,3,11,11,11,11,11,1],[1,11,11,11,8,11,8,1],[1,3,3,11,11,11,11,1],[1,11,3,11,7,1,7,1],[1,11,11,11,11,3,1,null],[1,3,3,3,1,3,1,null],[1,11,1,11,1,1,null,null]],skeleton:[[null,1,7,7,7,7,1,null],[null,1,7,8,7,8,1,null],[null,1,7,7,7,7,1,null],[1,7,1,7,7,1,7,1],[1,7,7,7,7,7,7,1],[1,7,1,7,1,1,7,1],[null,1,7,7,7,7,1,null],[null,1,7,1,1,7,1,null]],"fallen-king":[[1,10,1,10,1,10,1,1],[1,9,9,9,9,9,1,10],[1,5,15,8,15,8,1,9],[1,5,5,15,15,5,1,9],[1,2,7,5,5,7,1,9],[1,2,2,7,2,2,2,15],[1,2,2,7,2,2,1,9],[1,7,7,7,7,7,1,9]],"ancient-demon":[[null,1,8,1,1,8,1,null],[null,1,8,8,8,8,1,null],[null,1,8,0,8,0,1,null],[1,8,8,8,8,8,8,1],[8,8,8,8,8,8,8,8],[8,1,8,8,8,8,1,8],[1,1,8,8,8,8,1,1],[null,1,8,1,1,8,1,null]]};typeof window<"u"&&(window.EnemySpriteMatrices=Oe);const Pe={default:[[null,null,1,1,1,1,null,null],[null,1,15,15,15,15,1,null],[1,6,15,12,15,12,1,null],[1,6,15,15,15,15,1,null],[1,9,9,4,4,9,9,1],[1,15,9,9,9,4,15,1],[null,1,5,5,5,5,1,null],[null,1,5,1,1,5,1,null]]};typeof window<"u"&&(window.PlayerSpriteMatrices=Pe);let ge=class{static get(e,t="default"){const a={player:Pe,npc:Ne,enemy:Oe,object:Re},n=String(e||"").toLowerCase(),i=a[n];if(!i)throw new Error(`SpriteMatrixRegistry: registry not found for "${e}"`);const r=t??"default",s=i[r];if(!s)throw new Error(`SpriteMatrixRegistry: sprite "${r}" not found for group "${n}"`);return s}};typeof window<"u"&&(window.SpriteMatrixRegistry=ge);let Se=class{static PICO8_COLORS=Object.freeze(["#000000","#1D2B53","#7E2553","#008751","#AB5236","#5F574F","#C2C3C7","#FFF1E8","#FF004D","#FFA300","#FFFF27","#00E756","#29ADFF","#83769C","#FF77A8","#FFCCAA"]);static createTile(e,t,a,n=!1,i="Diversos"){const r=Array.isArray(a)?a.filter(Boolean):[a],s=(r.length?r:[this.createEmptyLayout()]).map(l=>this.toPixels(l));return{id:e,name:t,pixels:s[0],frames:s,animated:s.length>1,collision:n,category:i}}static createEmptyLayout(){return Array.from({length:8},()=>Array(8).fill(null))}static toPixels(e){return e.map(t=>t.map(a=>a===null?"transparent":this.PICO8_COLORS[a]??"transparent"))}static tile(e,t,a,n=!1,i="Diversos",r=null){const s=[a];return Array.isArray(r)&&s.push(r),this.createTile(e,t,s,n,i)}static TILE_PRESETS=[this.tile(0,"Grama Vibrante",[[3,3,3,3,3,3,3,3],[3,3,3,3,3,3,3,3],[3,3,3,3,3,3,3,3],[3,3,3,3,3,3,3,3],[3,3,3,3,3,3,3,3],[3,3,3,3,3,3,3,3],[3,3,3,3,3,3,3,3],[3,3,3,3,3,3,3,3]],!1,"Terreno"),this.tile(1,"Grama Alta",[[3,3,3,3,3,3,3,3],[3,3,3,3,3,3,3,3],[3,3,3,3,3,11,3,3],[3,3,3,3,11,3,11,3],[3,11,3,3,3,3,3,3],[11,3,11,3,3,3,3,3],[3,3,3,3,3,3,3,3],[3,3,3,3,3,3,3,3]],!1,"Terreno",[[3,3,3,3,3,3,3,3],[3,3,3,3,3,3,3,3],[3,3,3,3,3,3,11,3],[3,3,3,3,3,11,3,11],[3,3,11,3,3,3,3,3],[3,11,3,11,3,3,3,3],[3,3,3,3,3,3,3,3],[3,3,3,3,3,3,3,3]]),this.tile(2,"Trilha de Terra",[[4,4,4,4,4,4,4,4],[4,9,4,4,4,4,4,4],[4,4,4,4,4,4,4,4],[4,4,4,4,4,4,4,4],[4,4,4,4,4,4,9,4],[4,4,4,4,4,4,4,4],[4,4,4,9,4,4,4,4],[4,4,4,4,4,4,4,4]],!1,"Terreno"),this.tile(3,"Cascalho",[[3,3,3,3,3,3,3,3],[3,5,5,3,3,3,3,3],[5,6,6,5,3,3,3,3],[3,3,3,3,3,5,3,3],[3,3,3,3,5,6,5,3],[3,3,3,5,6,6,5,3],[3,3,3,3,3,3,3,3],[3,3,3,3,3,3,3,3]],!1,"Terreno"),this.tile(4,"Areia Macia",[[15,15,15,15,15,15,15,15],[15,15,10,15,15,10,15,15],[15,15,15,15,15,15,15,15],[15,10,15,15,15,15,10,15],[15,15,15,15,15,15,15,15],[15,15,10,15,15,10,15,15],[15,15,15,15,15,15,15,15],[15,10,15,15,15,15,10,15]],!1,"Terreno"),this.tile(16,"Piso de madeira",[[5,5,4,4,5,5,4,4],[5,5,4,4,5,5,4,4],[4,4,5,5,4,4,5,5],[4,4,5,5,4,4,5,5],[5,5,4,4,5,5,4,4],[5,5,4,4,5,5,4,4],[4,4,5,5,4,4,5,5],[4,4,5,5,4,4,5,5]],!1,"Terreno"),this.tile(17,"Piso de pedra",[[13,5,5,5,5,13,5,5],[5,5,13,5,5,5,13,5],[5,13,5,13,5,5,5,5],[5,5,5,13,5,5,5,5],[5,5,5,5,5,5,5,13],[5,5,5,5,5,5,5,13],[13,5,5,5,13,5,5,5],[13,5,5,5,5,13,5,13]],!1,"Terreno"),this.tile(5,"Agua Brilhante",[[12,12,12,12,12,12,12,7],[12,7,12,12,12,12,12,12],[7,6,7,12,12,12,12,12],[12,12,12,12,12,12,12,12],[12,12,12,12,12,7,12,12],[12,12,12,12,7,12,7,6],[12,7,12,12,12,12,12,12],[12,12,12,12,12,12,12,12]],!0,"Agua",[[12,12,12,12,12,12,12,12],[12,7,12,12,12,12,7,12],[12,12,12,12,12,7,12,7],[12,12,6,7,12,12,12,12],[7,12,12,12,12,12,12,12],[12,7,12,12,12,12,12,7],[12,12,12,12,6,7,12,12],[12,12,12,12,12,12,12,12]]),this.tile(6,"Lava Borbulhante",[[10,10,8,8,8,8,9,8],[8,10,9,10,9,9,8,8],[9,9,10,9,9,10,9,10],[8,8,8,8,9,10,10,8],[8,8,8,8,8,8,8,8],[8,9,10,8,8,10,9,8],[8,10,9,10,9,10,8,8],[10,8,8,8,8,8,9,8]],!0,"Perigo",[[9,10,8,8,10,8,9,8],[8,9,10,9,9,10,8,8],[9,10,9,10,9,10,9,8],[8,8,10,8,9,9,10,8],[8,8,8,8,8,9,8,8],[8,10,9,8,10,8,9,8],[10,9,10,9,10,9,8,8],[10,8,8,9,8,8,10,8]]),this.tile(7,"Pedra Grande",[[null,null,null,null,null,null,null,null],[null,null,null,null,5,null,null,null],[null,null,null,5,7,5,null,null],[null,null,5,13,6,7,5,null],[null,5,13,6,6,6,5,null],[null,5,13,6,6,6,7,5],[null,5,13,6,6,6,6,5],[null,null,null,null,null,null,null,null]],!0,"Natureza"),this.tile(8,"Arvore Verde",[[null,null,1,1,1,1,null,null],[null,1,11,11,11,11,1,null],[1,11,3,11,11,11,11,1],[1,11,11,11,11,3,11,1],[1,11,11,11,11,11,11,1],[null,1,1,4,4,1,1,null],[null,null,null,4,4,null,null,null],[null,null,4,4,4,4,null,null]],!0,"Natureza"),this.tile(9,"Arbusto Denso",[[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,1,1,1,1,null,null],[null,1,11,11,11,11,1,null],[1,11,11,11,11,3,11,1],[1,11,3,11,11,11,11,1],[1,1,1,1,1,1,1,1]],!0,"Natureza"),this.tile(10,"Parede de Pedra",[[6,7,6,5,13,5,13,6],[5,13,6,6,6,5,5,5],[5,5,6,7,6,5,5,13],[6,5,5,5,13,6,6,7],[6,6,13,5,5,7,6,6],[13,5,7,13,5,5,6,5],[5,6,6,6,7,13,13,5],[7,6,6,13,5,5,5,6]],!0,"Construcoes"),this.tile(11,"Parede de Madeira",[[9,9,9,9,9,9,9,9],[9,9,9,9,9,9,9,9],[9,9,9,9,9,9,9,9],[9,9,9,9,9,9,9,9],[9,9,9,9,9,9,9,9],[4,4,4,4,4,4,4,4],[9,9,9,9,9,9,9,9],[4,4,4,4,4,4,4,4]],!0,"Construcoes"),this.tile(12,"Telhado Classico",[[2,2,8,8,2,2,8,8],[8,8,14,14,8,8,14,14],[8,8,2,2,8,8,2,2],[14,14,8,8,14,14,8,8],[2,2,8,8,2,2,8,8],[8,8,14,14,8,8,14,14],[8,8,2,2,8,8,2,2],[14,14,8,8,14,14,8,8]],!0,"Construcoes"),this.tile(13,"Porta de Madeira",[[4,4,4,4,4,4,4,4],[4,9,9,9,9,9,9,4],[4,9,9,9,9,9,9,4],[4,9,9,9,9,9,9,4],[4,9,9,9,9,10,9,4],[4,9,9,9,9,9,9,4],[4,9,9,9,9,9,9,4],[4,9,9,9,9,9,9,4]],!1,"Construcoes"),this.tile(14,"Janela Azul",[[9,9,9,9,9,9,9,9],[9,9,5,5,5,5,9,9],[9,9,5,12,7,5,9,9],[9,9,5,12,12,5,9,9],[9,9,5,5,5,5,9,9],[4,4,4,4,4,4,4,4],[9,9,9,9,9,9,9,9],[4,4,4,4,4,4,4,4]],!0,"Construcoes"),this.tile(15,"Tocha de Parede",[[null,null,null,7,null,null,null,null],[null,null,null,10,7,null,null,null],[null,null,10,10,10,null,null,null],[null,null,10,8,10,null,null,null],[null,null,null,4,null,null,null,null],[null,null,null,4,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null]],!0,"Decoracao")];static get presets(){return this.TILE_PRESETS}};window.TileDefinitions=Se,window.PICO8_COLORS=Se.PICO8_COLORS,window.TILE_PRESETS=Se.TILE_PRESETS;class rt{static NPC_VARIANTS=["human","elf","dwarf","fixed"];static NPC_DEFINITIONS=[{type:"old-mage",id:"npc-old-mage",name:"Velho Mago",nameKey:"npcs.names.oldMage.human",previewLabel:"Mago",defaultText:"",defaultTextKey:"npcs.dialog.oldMage.human",sprite:SpriteMatrixRegistry.get("npc","old-mage"),variant:"human"},{type:"villager-man",id:"npc-villager-man",name:"Homem comum",nameKey:"npcs.names.villagerMan.human",previewLabel:"Homem",defaultText:"",defaultTextKey:"npcs.dialog.villagerMan.human",sprite:SpriteMatrixRegistry.get("npc","villager-man"),variant:"human"},{type:"villager-woman",id:"npc-villager-woman",name:"Mulher comum",nameKey:"npcs.names.villagerWoman.human",previewLabel:"Mulher",defaultText:"",defaultTextKey:"npcs.dialog.villagerWoman.human",sprite:SpriteMatrixRegistry.get("npc","villager-woman"),variant:"human"},{type:"child",id:"npc-child",name:"Crianca curiosa",nameKey:"npcs.names.child.human",previewLabel:"Crianca",defaultText:"",defaultTextKey:"npcs.dialog.child.human",sprite:SpriteMatrixRegistry.get("npc","child"),variant:"human"},{type:"king",id:"npc-king",name:"Rei",nameKey:"npcs.names.king.human",previewLabel:"Rei",defaultText:"",defaultTextKey:"npcs.dialog.king.human",sprite:SpriteMatrixRegistry.get("npc","king"),variant:"human"},{type:"knight",id:"npc-knight",name:"Cavaleiro",nameKey:"npcs.names.knight.human",previewLabel:"Cavaleiro",defaultText:"",defaultTextKey:"npcs.dialog.knight.human",sprite:SpriteMatrixRegistry.get("npc","knight"),variant:"human"},{type:"thief",id:"npc-thief",name:"Ladra",nameKey:"npcs.names.thief.human",previewLabel:"Ladra",defaultText:"",defaultTextKey:"npcs.dialog.thief.human",sprite:SpriteMatrixRegistry.get("npc","thief"),variant:"human"},{type:"blacksmith",id:"npc-blacksmith",name:"Ferreira",nameKey:"npcs.names.blacksmith.human",previewLabel:"Ferreira",defaultText:"",defaultTextKey:"npcs.dialog.blacksmith.human",sprite:SpriteMatrixRegistry.get("npc","blacksmith"),variant:"human"},{type:"old-mage-elf",id:"npc-old-mage-elf",name:"Velho Mago",nameKey:"npcs.names.oldMage.elf",previewLabel:"Mago",defaultText:"",defaultTextKey:"npcs.dialog.oldMage.elf",sprite:SpriteMatrixRegistry.get("npc","old-mage-elf"),variant:"elf"},{type:"villager-man-elf",id:"npc-villager-man-elf",name:"Homem comum",nameKey:"npcs.names.villagerMan.elf",previewLabel:"Homem",defaultText:"",defaultTextKey:"npcs.dialog.villagerMan.elf",sprite:SpriteMatrixRegistry.get("npc","villager-man-elf"),variant:"elf"},{type:"villager-woman-elf",id:"npc-villager-woman-elf",name:"Mulher comum",nameKey:"npcs.names.villagerWoman.elf",previewLabel:"Mulher",defaultText:"",defaultTextKey:"npcs.dialog.villagerWoman.elf",sprite:SpriteMatrixRegistry.get("npc","villager-woman-elf"),variant:"elf"},{type:"child-elf",id:"npc-child-elf",name:"Crianca curiosa",nameKey:"npcs.names.child.elf",previewLabel:"Crianca",defaultText:"",defaultTextKey:"npcs.dialog.child.elf",sprite:SpriteMatrixRegistry.get("npc","child-elf"),variant:"elf"},{type:"king-elf",id:"npc-king-elf",name:"Rei",nameKey:"npcs.names.king.elf",previewLabel:"Rei",defaultText:"",defaultTextKey:"npcs.dialog.king.elf",sprite:SpriteMatrixRegistry.get("npc","king-elf"),variant:"elf"},{type:"knight-elf",id:"npc-knight-elf",name:"Cavaleiro",nameKey:"npcs.names.knight.elf",previewLabel:"Cavaleiro",defaultText:"",defaultTextKey:"npcs.dialog.knight.elf",sprite:SpriteMatrixRegistry.get("npc","knight-elf"),variant:"elf"},{type:"thief-elf",id:"npc-thief-elf",name:"Ladra",nameKey:"npcs.names.thief.elf",previewLabel:"Ladra",defaultText:"",defaultTextKey:"npcs.dialog.thief.elf",sprite:SpriteMatrixRegistry.get("npc","thief-elf"),variant:"elf"},{type:"blacksmith-elf",id:"npc-blacksmith-elf",name:"Ferreira",nameKey:"npcs.names.blacksmith.elf",previewLabel:"Ferreira",defaultText:"",defaultTextKey:"npcs.dialog.blacksmith.elf",sprite:SpriteMatrixRegistry.get("npc","blacksmith-elf"),variant:"elf"},{type:"old-mage-dwarf",id:"npc-old-mage-dwarf",name:"Velho Mago",nameKey:"npcs.names.oldMage.dwarf",previewLabel:"Mago",defaultText:"",defaultTextKey:"npcs.dialog.oldMage.dwarf",sprite:SpriteMatrixRegistry.get("npc","old-mage-dwarf"),variant:"dwarf"},{type:"villager-man-dwarf",id:"npc-villager-man-dwarf",name:"Homem comum",nameKey:"npcs.names.villagerMan.dwarf",previewLabel:"Homem",defaultText:"",defaultTextKey:"npcs.dialog.villagerMan.dwarf",sprite:SpriteMatrixRegistry.get("npc","villager-man-dwarf"),variant:"dwarf"},{type:"villager-woman-dwarf",id:"npc-villager-woman-dwarf",name:"Mulher comum",nameKey:"npcs.names.villagerWoman.dwarf",previewLabel:"Mulher",defaultText:"",defaultTextKey:"npcs.dialog.villagerWoman.dwarf",sprite:SpriteMatrixRegistry.get("npc","villager-woman-dwarf"),variant:"dwarf"},{type:"child-dwarf",id:"npc-child-dwarf",name:"Crianca curiosa",nameKey:"npcs.names.child.dwarf",previewLabel:"Crianca",defaultText:"",defaultTextKey:"npcs.dialog.child.dwarf",sprite:SpriteMatrixRegistry.get("npc","child-dwarf"),variant:"dwarf"},{type:"king-dwarf",id:"npc-king-dwarf",name:"Rei",nameKey:"npcs.names.king.dwarf",previewLabel:"Rei",defaultText:"",defaultTextKey:"npcs.dialog.king.dwarf",sprite:SpriteMatrixRegistry.get("npc","king-dwarf"),variant:"dwarf"},{type:"knight-dwarf",id:"npc-knight-dwarf",name:"Cavaleiro",nameKey:"npcs.names.knight.dwarf",previewLabel:"Cavaleiro",defaultText:"",defaultTextKey:"npcs.dialog.knight.dwarf",sprite:SpriteMatrixRegistry.get("npc","knight-dwarf"),variant:"dwarf"},{type:"thief-dwarf",id:"npc-thief-dwarf",name:"Ladra",nameKey:"npcs.names.thief.dwarf",previewLabel:"Ladra",defaultText:"",defaultTextKey:"npcs.dialog.thief.dwarf",sprite:SpriteMatrixRegistry.get("npc","thief-dwarf"),variant:"dwarf"},{type:"blacksmith-dwarf",id:"npc-blacksmith-dwarf",name:"Ferreira",nameKey:"npcs.names.blacksmith.dwarf",previewLabel:"Ferreira",defaultText:"",defaultTextKey:"npcs.dialog.blacksmith.dwarf",sprite:SpriteMatrixRegistry.get("npc","blacksmith-dwarf"),variant:"dwarf"},{type:"thought-bubble",id:"npc-thought-bubble",name:"Balao",nameKey:"npcs.names.thoughtBubble",previewLabel:"Balao",defaultText:"",defaultTextKey:"npcs.dialog.thoughtBubble",sprite:SpriteMatrixRegistry.get("npc","thought-bubble"),variant:"fixed"},{type:"wooden-sign",id:"npc-wooden-sign",name:"Placa de madeira",nameKey:"npcs.names.woodenSign",previewLabel:"Placa",defaultText:"",defaultTextKey:"npcs.dialog.woodenSign",sprite:SpriteMatrixRegistry.get("npc","wooden-sign"),variant:"fixed"}];static get definitions(){return this.NPC_DEFINITIONS}static getNpcDefinition(e){return this.NPC_DEFINITIONS.find(t=>t.type===e)||null}static normalizeVariant(e){const t=String(e||"").toLowerCase();return this.NPC_VARIANTS.includes(t)?t:"human"}static getVariants(){return this.NPC_VARIANTS.slice()}}window.NPCDefinitions=rt;let st=class{static ENEMY_DEFINITIONS=[{type:"giant-rat",id:"enemy-giant-rat",name:"ðŸ€ Rato Gigante",nameKey:"enemies.names.giantRat",description:"o primeiro inimigo fraco.",damage:1,missChance:.1,experience:3,hasEyes:!0,sprite:SpriteMatrixRegistry.get("enemy","giant-rat")},{type:"bandit",id:"enemy-bandit",name:"ðŸ§” Bandido",nameKey:"enemies.names.bandit",description:"inimigo humano comum.",damage:2,missChance:.25,experience:4,hasEyes:!0,sprite:SpriteMatrixRegistry.get("enemy","bandit")},{type:"skeleton",id:"enemy-skeleton",name:"ðŸ’€ Esqueleto",nameKey:"enemies.names.skeleton",description:"o morto-vivo clÃ¡ssico.",damage:3,missChance:.25,experience:5,aliases:["skull"],hasEyes:!1,sprite:SpriteMatrixRegistry.get("enemy","skeleton")},{type:"dark-knight",id:"enemy-dark-knight",name:"âš”ï¸ Cavaleiro Negro",nameKey:"enemies.names.darkKnight",description:"o guerreiro corrompido.",damage:4,missChance:.18,experience:7,hasEyes:!0,sprite:SpriteMatrixRegistry.get("enemy","dark-knight")},{type:"necromancer",id:"enemy-necromancer",name:"ðŸ§™â€â™‚ï¸ Necro",nameKey:"enemies.names.necromancer",description:"o mago das trevas.",damage:5,missChance:.12,experience:8,hasEyes:!0,sprite:SpriteMatrixRegistry.get("enemy","necromancer")},{type:"dragon",id:"enemy-dragon",name:"ðŸ‰ DragÃ£o",nameKey:"enemies.names.dragon",description:"o monstro lendÃ¡rio.",damage:6,missChance:.08,defeatActivationMessage:"Selo do DragÃ£o ativado!",defeatActivationMessageKey:"enemies.defeat.dragon",experience:9,hasEyes:!0,boss:!0,sprite:SpriteMatrixRegistry.get("enemy","dragon")},{type:"fallen-king",id:"enemy-fallen-king",name:"ðŸ‘‘ Rei CaÃ­do",nameKey:"enemies.names.fallenKing",description:"o chefe trÃ¡gico corrompido pelo poder.",damage:7,missChance:.08,defeatActivationMessage:"Selo Real despertou!",defeatActivationMessageKey:"enemies.defeat.fallenKing",experience:10,hasEyes:!0,boss:!0,sprite:SpriteMatrixRegistry.get("enemy","fallen-king")},{type:"ancient-demon",id:"enemy-ancient-demon",name:"ðŸ˜ˆ DemÃ´nio AnciÃ£o",nameKey:"enemies.names.ancientDemon",description:"o mal primordial e final.",damage:8,missChance:.05,defeatActivationMessage:"Selo DemonÃ­aco ativo!",defeatActivationMessageKey:"enemies.defeat.ancientDemon",aliases:["boss"],experience:11,hasEyes:!1,boss:!0,sprite:SpriteMatrixRegistry.get("enemy","ancient-demon")}];static get definitions(){return this.ENEMY_DEFINITIONS}static getDefault(){return this.ENEMY_DEFINITIONS[0]||null}static getEnemyDefinition(e){if(typeof e!="string"||!e)return null;const t=this.ENEMY_DEFINITIONS.find(a=>a.type===e);return t||this.ENEMY_DEFINITIONS.find(a=>Array.isArray(a.aliases)&&a.aliases.includes(e))||null}static normalizeType(e){const t=this.getEnemyDefinition(e);return t?t.type:this.getDefault()?.type||"giant-rat"}static getExperienceReward(e){const t=this.getEnemyDefinition(e);if(!t)return 0;const a=Number(t.experience);return Number.isFinite(a)?Math.max(0,Math.floor(a)):0}static getMissChance(e){const t=this.getEnemyDefinition(e);if(!t)return null;const a=Number(t.missChance);return Number.isFinite(a)?Math.max(0,Math.min(1,a)):null}};typeof window<"u"&&(window.EnemyDefinitions=st);const K={PLAYER_START:"player-start",PLAYER_END:"player-end",SWITCH:"switch",DOOR:"door",DOOR_VARIABLE:"door-variable",KEY:"key",LIFE_POTION:"life-potion",XP_SCROLL:"xp-scroll",SWORD:"sword",SWORD_BRONZE:"sword-bronze",SWORD_WOOD:"sword-wood"};let lt=class{static OBJECT_DEFINITIONS=[{type:K.PLAYER_START,id:"object-player-start",name:"Inicio do Jogador",nameKey:"objects.label.playerStart",behavior:{order:10,tags:["placeable","player-start","global-unique","hidden-in-runtime"]},sprite:SpriteMatrixRegistry.get("object","player-start")},{type:K.PLAYER_END,id:"object-player-end",name:"Fim do Jogo",nameKey:"objects.label.playerEnd",behavior:{order:20,tags:["placeable","player-end","per-room-unique"]},sprite:SpriteMatrixRegistry.get("object","player-end")},{type:K.SWITCH,id:"object-switch",name:"Alavanca",nameKey:"objects.label.switch",behavior:{order:30,tags:["placeable","switch","requires-variable"]},sprite:SpriteMatrixRegistry.get("object","switch"),spriteOn:SpriteMatrixRegistry.get("object","switch--on")},{type:K.KEY,id:"object-key",name:"Chave",nameKey:"objects.label.key",behavior:{order:60,tags:["placeable","collectible","hide-when-collected"]},sprite:SpriteMatrixRegistry.get("object","key")},{type:K.DOOR,id:"object-door",name:"Porta",nameKey:"objects.label.door",behavior:{order:40,tags:["placeable","door","locked-door","hide-when-opened"]},sprite:SpriteMatrixRegistry.get("object","door")},{type:K.DOOR_VARIABLE,id:"object-door-variable",name:"Porta Magica",nameKey:"objects.label.doorVariable",behavior:{order:50,tags:["placeable","door","requires-variable","variable-door","hide-when-variable-open"]},sprite:SpriteMatrixRegistry.get("object","door-variable")},{type:K.LIFE_POTION,id:"object-life-potion",name:"Pocao de Vida",nameKey:"objects.label.lifePotion",behavior:{order:70,tags:["placeable","collectible","hide-when-collected"]},sprite:SpriteMatrixRegistry.get("object","life-potion")},{type:K.XP_SCROLL,id:"object-xp-scroll",name:"Pergaminho de XP",nameKey:"objects.label.xpScroll",behavior:{order:110,tags:["placeable","collectible","hide-when-collected"]},sprite:SpriteMatrixRegistry.get("object","xp-scroll")},{type:K.SWORD,id:"object-sword",name:"Espada de AÃ§o",nameKey:"objects.label.sword",behavior:{order:80,swordDurability:5,tags:["placeable","collectible","sword","hide-when-collected"]},sprite:SpriteMatrixRegistry.get("object","sword")},{type:K.SWORD_BRONZE,id:"object-sword-bronze",name:"Espada de Bronze",nameKey:"objects.label.swordBronze",behavior:{order:90,swordDurability:4,tags:["placeable","collectible","sword","hide-when-collected"]},sprite:SpriteMatrixRegistry.get("object","sword-bronze")},{type:K.SWORD_WOOD,id:"object-sword-wood",name:"Espada de Madeira",nameKey:"objects.label.swordWood",behavior:{order:100,swordDurability:3,tags:["placeable","collectible","sword","hide-when-collected"]},sprite:SpriteMatrixRegistry.get("object","sword-wood")}];static get definitions(){return this.OBJECT_DEFINITIONS}static get TYPES(){return K}static getObjectDefinition(e){return this.OBJECT_DEFINITIONS.find(t=>t.type===e)||null}static get behaviorMap(){if(!this._behaviorMap){const e=new Map;this.OBJECT_DEFINITIONS.forEach((t,a)=>{const n=t.behavior||{},i=Array.isArray(n.tags)?n.tags.slice():[];e.set(t.type,{order:Number.isFinite(n.order)?n.order:100+a,tags:i,tagSet:new Set(i),swordDurability:Number.isFinite(n.swordDurability)?Math.max(0,n.swordDurability):null})}),this._behaviorMap=e}return this._behaviorMap}static getTags(e){return this.behaviorMap.get(e)?.tags||[]}static hasTag(e,t){if(!t)return!1;const a=String(t);return this.behaviorMap.get(e)?.tagSet?.has(a)||!1}static getTypesByTag(e){if(!e)return[];const t=String(e),a=[];return this.OBJECT_DEFINITIONS.forEach(n=>{this.hasTag(n.type,t)&&a.push(n.type)}),a}static getEditorTypeOrder(){return[...this.OBJECT_DEFINITIONS].sort((e,t)=>{const a=this.behaviorMap.get(e.type)?.order??0,n=this.behaviorMap.get(t.type)?.order??0;return a-n}).map(e=>e.type)}static getPlaceableTypes(){const e=this.getTypesByTag("placeable");if(e.length)return e;const t=K;return[t.DOOR,t.DOOR_VARIABLE,t.KEY,t.LIFE_POTION,t.XP_SCROLL,t.SWORD,t.SWORD_BRONZE,t.SWORD_WOOD,t.PLAYER_START,t.PLAYER_END,t.SWITCH].filter(Boolean)}static getCollectibleTypes(){const e=this.getTypesByTag("collectible");if(e.length)return e;const t=K;return[t.KEY,t.LIFE_POTION,t.XP_SCROLL,t.SWORD,t.SWORD_BRONZE,t.SWORD_WOOD].filter(Boolean)}static isCollectible(e){return this.hasTag(e,"collectible")}static shouldHideWhenCollected(e){return this.hasTag(e,"hide-when-collected")}static shouldHideWhenOpened(e){return this.hasTag(e,"hide-when-opened")}static shouldHideWhenVariableOpen(e){return this.hasTag(e,"hide-when-variable-open")}static isHiddenInRuntime(e){return this.hasTag(e,"hidden-in-runtime")}static requiresVariable(e){return this.hasTag(e,"requires-variable")}static isDoor(e){return this.hasTag(e,"door")}static isVariableDoor(e){return this.hasTag(e,"variable-door")}static isLockedDoor(e){return this.hasTag(e,"locked-door")}static isSwitch(e){return this.hasTag(e,"switch")}static isPlayerStart(e){return this.hasTag(e,"player-start")}static isPlayerEnd(e){return this.hasTag(e,"player-end")}static getSwordDurability(e){const t=this.behaviorMap.get(e);return t&&Number.isFinite(t.swordDurability)?t.swordDurability:null}};window.ObjectDefinitions=lt,window.ObjectTypes=window.ObjectTypes||K;const le=window.NPCDefinitions?window.NPCDefinitions.definitions||window.NPCDefinitions.NPC_DEFINITIONS||[]:[],Le=m=>window.NPCDefinitions.getNpcDefinition(m),pe="npc-",we=new Map;for(let m=0;m<le.length;m++)we.set(le[m].type,m+1);let fe=le.length+1;const ne=(m,e="")=>TextResources.get(m,e)||e||m||"",Ee=m=>m?m.nameKey?ne(m.nameKey,m.name||"NPC"):m.name||ne("npc.defaultName","NPC"):ne("npc.defaultName","NPC"),Me=m=>m?m.defaultTextKey?ne(m.defaultTextKey,m.defaultText||""):m.defaultText||"":"",ot=(m,e)=>{const t=Me(e),a=e&&e.defaultTextKey?e.defaultTextKey:null,n=Object.prototype.hasOwnProperty.call(m,"text"),i=n?typeof m.text=="string"?m.text:String(m.text||""):"",r=typeof m.textKey=="string"&&m.textKey.trim()?m.textKey.trim():null;return r?{textKey:r,text:ne(r,i||t)}:!n&&a?{textKey:a,text:ne(a,t)}:{textKey:null,text:n?i:t}};function oe(m,e,t,a){return Number.isFinite(m)?Math.max(e,Math.min(t,m)):a}function ct(m){if(typeof m!="string"||!m.startsWith(pe))return null;const e=Number(m.slice(pe.length));return Number.isFinite(e)&&e>0?e:null}function Ae(m){Number.isFinite(m)&&m>=fe&&(fe=m+1)}function De(m){if(!we.has(m))return null;const e=we.get(m);return Ae(e),`${pe}${e}`}function dt(){const m=`${pe}${fe}`;return fe+=1,m}let ht=class{constructor(e){this.gameState=e}generateId(){return dt()}getDefinitions(){return le.slice()}getNPCs(){return this.gameState.game.sprites}getNPC(e){return this.gameState.game.sprites.find(t=>t.id===e)||null}getNPCByType(e){return this.gameState.game.sprites.find(t=>t.type===e)||null}ensureDefaultNPCs(){const e=new Set(le.map(n=>n.type)),t=[],a=new Set;for(const n of this.gameState.game.sprites||[])e.has(n.type)&&(a.has(n.type)||(t.push(this.normalizeNPC(n)),a.add(n.type)));for(const n of le)a.has(n.type)||t.push(this.createFromDefinition(n));return this.gameState.game.sprites=t,this.gameState.game.sprites}normalizeNPC(e){const t=Le(e.type),a=t?De(t.type):null,n=typeof e?.id=="string"?e.id.trim():"",i=ct(n);i&&Ae(i);const r=a||n||this.generateId(),s=t?Ee(t):null,l=e.name||s||ne("npc.defaultName","NPC"),{text:o,textKey:c}=ot(e,t),d=Math.max(0,(this.gameState?.game?.rooms?.length??1)-1),u=oe(Number(e.roomIndex),0,d,0),h=oe(Number(e.x),0,7,1),g=oe(Number(e.y),0,7,1),p=e.initialX!==void 0?e.initialX:h,f=e.initialY!==void 0?e.initialY:g,y=e.initialRoomIndex!==void 0?e.initialRoomIndex:u,T=e.placed!==void 0?!!e.placed:!0,b=e.conditionVariableId??e.conditionalVariableId??null,x=e.conditionText??e.conditionalText??"",O=e.rewardVariableId??e.activateVariableId??e.onCompleteVariableId??null,N=e.conditionalRewardVariableId??e.alternativeRewardVariableId??null,D=this.gameState.normalizeVariableId?.(b)??null,L=typeof x=="string"?x:"",A=this.gameState.normalizeVariableId?.(O)??null,v=this.gameState.normalizeVariableId?.(N)??null;return{id:r,type:t?.type||e.type||r,name:l,text:o,textKey:c,roomIndex:u,x:h,y:g,initialX:p,initialY:f,initialRoomIndex:y,placed:T,conditionVariableId:D,conditionText:L,rewardVariableId:A,conditionalRewardVariableId:v}}createFromDefinition(e){const t=e?.defaultTextKey||null;return{id:De(e.type)||this.generateId(),type:e.type,name:Ee(e),text:Me(e),textKey:t,roomIndex:0,x:1,y:1,placed:!1,conditionVariableId:null,conditionText:"",rewardVariableId:null,conditionalRewardVariableId:null}}resetNPCs(){const e=this.getNPCs();for(const t of e)t.initialX!==void 0&&(t.x=t.initialX),t.initialY!==void 0&&(t.y=t.initialY),t.initialRoomIndex!==void 0&&(t.roomIndex=t.initialRoomIndex)}addNPC(e){const t=e?.type?Le(e.type):null;if(!t)return null;const a=this.getNPCByType(t.type);if(a)return Object.assign(a,this.normalizeNPC({...a,...e,id:a.id,type:t.type})),a.id;const n=this.normalizeNPC({id:t.id,type:t.type,name:Ee(t),text:e?.text??Me(t),textKey:e?.text?null:t.defaultTextKey||null,x:e?.x??1,y:e?.y??1,roomIndex:e?.roomIndex??0,placed:!!e?.placed});return this.gameState.game.sprites.push(n),n.id}updateNPC(e,t){const a=this.getNPC(e);if(!a)return;const n=this.normalizeNPC({...a,...t,id:a.id,type:a.type});Object.assign(a,n)}removeNPC(e){const t=this.getNPC(e);return t?(t.placed=!1,t.x=1,t.y=1,t.roomIndex=0,!0):!1}setNPCPosition(e,t,a,n=null){const i=this.getNPC(e);if(i){if(i.x=oe(Number(t),0,7,i.x),i.y=oe(Number(a),0,7,i.y),i.initialX=i.x,i.initialY=i.y,n!=null){const r=Math.max(0,(this.gameState?.game?.rooms?.length??1)-1);i.roomIndex=oe(Number(n),0,r,i.roomIndex),i.initialRoomIndex=i.roomIndex}return i.placed=!0,!0}}updateNPCDialog(e,t){if(typeof t=="object"&&t!==null){this.updateNPC(e,t);return}this.updateNPC(e,{text:t})}};typeof window<"u"&&(window.NPCManager=ht);const ke=typeof window<"u"&&window.TileDefinitions?window.TileDefinitions:null,je=Array.isArray(ke?.TILE_PRESETS)?ke.TILE_PRESETS:typeof window<"u"&&Array.isArray(window.TILE_PRESETS)?window.TILE_PRESETS||[]:[];let ut=class{gameState;presets;animationFrameIndex;maxAnimationFrames;constructor(e){this.gameState=e,this.presets=this.buildPresetTiles(),this.animationFrameIndex=0,this.maxAnimationFrames=1}generateTileId(){const e=typeof crypto<"u"?crypto:typeof window<"u"?window.crypto:null;return e?.randomUUID?e.randomUUID():`tile-${Math.random().toString(36).slice(2,10)}`}buildPresetTiles(){return Array.isArray(je)?je.map(e=>this.cloneTile(e)).sort((e,t)=>typeof e.id=="number"&&typeof t.id=="number"?e.id-t.id:String(e.id).localeCompare(String(t.id))):[]}cloneTile(e){const t=e.frames?.map(n=>n.map(i=>i.slice())),a=e.pixels?e.pixels.map(n=>n.slice()):void 0;return{...e,frames:t,pixels:a}}ensureDefaultTiles(){const e=this.gameState.game.tileset,t=8,a=(this.gameState.game.world?.rows||1)*(this.gameState.game.world?.cols||1);if((!Array.isArray(e.tiles)||e.tiles.length===0)&&(e.tiles=this.presets.map(n=>this.cloneTile(n))),!Array.isArray(e.maps)||e.maps.length===0){const n=e.tiles[0]?.id??null,i=r=>Array.from({length:t},()=>Array.from({length:t},()=>r));e.maps=Array.from({length:a},()=>({ground:i(n),overlay:i(null)}))}else{const n=e.tiles[0]?.id??null;if(n!=null){const i=s=>Array.isArray(s)&&s.every(l=>Array.isArray(l)&&l.every(o=>o==null)),r=s=>Array.from({length:t},()=>Array.from({length:t},()=>s));e.maps.forEach(s=>{s&&i(s.ground)&&i(s.overlay)&&(s.ground=r(n),s.overlay=r(null))})}}e.map=e.maps[0],this.refreshAnimationMetadata()}getPresetTileNames(){return this.presets.map(e=>e.name||"")}getTiles(){return this.gameState.game.tileset.tiles}getTile(e){return this.gameState.game.tileset.tiles.find(t=>t.id===e)}updateTile(e,t){const a=this.getTile(e);a&&(Object.assign(a,t),Array.isArray(t.frames)?(a.pixels=t.frames[0],a.animated=t.frames.length>1):Array.isArray(t.pixels)&&(a.frames=void 0,a.animated=!1),this.refreshAnimationMetadata())}setMapTile(e,t,a,n=0){if(t<0||t>=8||e<0||e>=8)return;const i=this.gameState.game.tileset.maps,r=Array.isArray(i)?i[n]:null;if(!r)return;if(a===null){r.overlay[t][e]=null,r.ground[t][e]=null;return}const s=this.getTile(a);s&&(s.collision?r.overlay[t][e]=a:(r.ground[t][e]=a,r.overlay[t][e]=null))}getTileMap(e=0){const t=this.gameState.game.tileset.maps;return Array.isArray(t)&&t[e]?t[e]:this.gameState.game.tileset.map}refreshAnimationMetadata(){const e=this.getTiles()||[];let t=1;for(const a of e){const n=Array.isArray(a?.frames)&&a.frames.length?a.frames.length:1;n>t&&(t=n)}this.maxAnimationFrames=Math.max(1,t)}getAnimationFrameCount(){return Math.max(1,this.maxAnimationFrames||1)}getAnimationFrameIndex(){return Math.max(0,this.animationFrameIndex||0)}setAnimationFrameIndex(e=0){if(!Number.isFinite(e))return this.animationFrameIndex;const t=this.getAnimationFrameCount(),a=(Math.floor(e)%t+t)%t;return this.animationFrameIndex=a,this.animationFrameIndex}advanceAnimationFrame(){const e=this.getAnimationFrameCount();return e<=1?this.animationFrameIndex:(this.animationFrameIndex=(this.getAnimationFrameIndex()+1)%e,this.animationFrameIndex)}getTilePixels(e,t=null){const a=typeof e=="object"&&e!==null?e:this.getTile(e);if(!a)return null;const n=Array.isArray(a.frames)&&a.frames.length?a.frames:a.pixels?[a.pixels]:[];if(!n.length)return null;const i=Number.isFinite(t)?t:this.getAnimationFrameIndex(),r=(Math.floor(i)%n.length+n.length)%n.length;return n[r]}};typeof window<"u"&&(window.TileManager=ut);let mt=class{gameState;renderer;pendingDialogAction;constructor(e,t){this.gameState=e,this.renderer=t,this.pendingDialogAction=null}showDialog(e,t={}){const n=t&&Object.keys(t).length>0?{...t}:null,i=n?.pauseReason||"dialog";n&&(n.pauseReason=i),this.gameState.pauseGame(i),this.pendingDialogAction=n,this.gameState.setDialog(!0,e,n)}completeDialog(){const e=ObjectTypes;if(this.pendingDialogAction?.setVariableId&&this.pendingDialogAction.rewardAllowed!==!1){const[,t]=this.gameState.setVariableValue?.(this.pendingDialogAction.setVariableId,!0)||[];t&&this.renderer.setIconOverPlayer(e.DOOR_VARIABLE)}this.pendingDialogAction=null}closeDialog(){if(!this.gameState.getDialog().active)return;const e=this.pendingDialogAction;this.completeDialog(),this.gameState.setDialog(!1);const t=e?.pauseReason||"dialog";this.gameState.resumeGame(t),this.renderer.draw()}reset(){const e=this.pendingDialogAction;this.pendingDialogAction=null;const t=e?.pauseReason||"dialog";this.gameState.resumeGame(t)}};typeof window<"u"&&(window.DialogManager=mt);let gt=class{gameState;dialogManager;options;constructor(e,t,a={}){this.gameState=e,this.dialogManager=t,this.options=a}get types(){return ObjectTypes}handlePlayerInteractions(){const e=this.gameState.getGame(),t=this.gameState.getPlayer();this.checkItems(e.items,t),this.checkObjects(t),this.checkNpcs(e.sprites,t),this.checkRoomExits(e.exits,e.rooms,t)}checkItems(e,t){if(Array.isArray(e))for(const a of e){if(!(a.roomIndex===t.roomIndex&&a.x===t.x&&a.y===t.y)||a.collected)continue;a.collected=!0;const i=typeof a.text=="string"?a.text:this.getInteractionText("objects.item.pickup","");i&&this.dialogManager.showDialog(i);break}}checkObjects(e){const t=this.gameState.getObjectsForRoom?.(e.roomIndex)||[];for(const a of t)if(!(a.x!==e.x||a.y!==e.y)&&(this.handleCollectibleObject(a)||this.handleSwitch(a)||this.handlePlayerEnd(a)))break}handleCollectibleObject(e){if(e.collected)return!1;const t=this.types;switch(e.type){case t.KEY:return e.collected=!0,this.showPickupOverlay(e.type,()=>{this.gameState.addKeys?.(1)}),!0;case t.LIFE_POTION:{const a=this.gameState.getLives?.(),n=this.gameState.getMaxLives?.(),i=this.gameState.hasSkill?.("potion-master");return Number.isFinite(a)&&Number.isFinite(n)&&a>=n?!1:(e.collected=!0,this.showPickupOverlay(e.type,()=>{i?this.gameState.healPlayerToFull?.():this.gameState.addLife?.(1)}),!0)}case t.XP_SCROLL:return e.collected=!0,this.showPickupOverlay(e.type,()=>{const a=this.gameState.getExperienceToNext?.()??0,n=a>0?Math.max(1,Math.floor(a*.5)):0;this.gameState.addExperience?.(n)}),!0;case t.SWORD:case t.SWORD_BRONZE:case t.SWORD_WOOD:{if(!this.shouldPickupSword(e.type))return!1;const a=this.getSwordDurability(e.type);return e.collected=!0,this.showPickupOverlay(e.type,()=>{this.gameState.addDamageShield?.(a,e.type)}),!0}default:return!1}}getSwordDurability(e){const t=ObjectDefinitions.getSwordDurability(e);return Number.isFinite(t)?Math.max(0,t):0}getSwordPriority(e){const t=this.types;return{[t.SWORD_WOOD]:1,[t.SWORD_BRONZE]:2,[t.SWORD]:3}[e]||0}shouldPickupSword(e){const t=this.gameState.getSwordType?.()||null,a=this.getSwordPriority(t||"");return this.getSwordPriority(e)>a}showPickupOverlay(e,t=null){const a=this.getObjectDisplayName(e);this.gameState.showPickupOverlay?.({name:a,spriteGroup:"object",spriteType:e,effect:t})}getObjectDisplayName(e){const t=ObjectDefinitions.getObjectDefinition(e);if(!t)return e||"";if(t.nameKey){const a=TextResources.get(t.nameKey,t.name||e||"");if(a)return a}return t.name?t.name:e||""}getInteractionText(e,t=""){return TextResources.get(e,t)||t||""}formatInteractionText(e,t={},a=""){return TextResources.format(e,t,a)||a||""}handleSwitch(e){const t=this.types;if(e.type!==t.SWITCH)return!1;e.on=!e.on;const a=this.gameState.normalizeVariableId?.(e.variableId)??null;a&&this.gameState.setVariableValue?.(a,e.on);const n=e.on?this.getInteractionText("objects.switch.onMessage",""):this.getInteractionText("objects.switch.offMessage","");return n&&this.dialogManager.showDialog(n),!0}handlePlayerEnd(e){const t=this.types;if(e.type!==t.PLAYER_END)return!1;const a=this.gameState.getPlayerEndText(e.roomIndex);return this.gameState.setActiveEndingText?.(a||""),this.options?.onPlayerVictory?.(),!0}checkNpcs(e,t){for(const a of e){if(!a.placed||!(a.roomIndex===t.roomIndex&&a.x===t.x&&a.y===t.y))continue;const i=this.getNpcDialogText(a),r=this.getNpcDialogMeta(a);this.dialogManager.showDialog(i,r);break}}getNpcDialogText(e){const t=e?.conditionVariableId||null,a=t==="skill:bard",n=a?null:this.gameState.normalizeVariableId?.(t)??null,i=typeof e.conditionText=="string"&&e.conditionText.trim().length>0,r=this.gameState.hasSkill?.("charisma"),l=i&&(a&&r||n&&this.gameState.isVariableOn?.(n))&&i;return l?e.conditionText:typeof e.text=="string"&&e.text.trim()?e.text:l?e.conditionText||"":e.text||"Hello!"}getNpcDialogMeta(e){const t=e?.conditionVariableId||null,a=t==="skill:bard",n=a?null:this.gameState.normalizeVariableId?.(t)??null,i=this.gameState.normalizeVariableId?.(e.rewardVariableId)??null,r=this.gameState.normalizeVariableId?.(e.conditionalRewardVariableId)??null,s=typeof e.conditionText=="string"&&e.conditionText.trim().length>0,l=this.gameState.hasSkill?.("charisma"),o=s&&(a&&l||n&&this.gameState.isVariableOn?.(n));if(o&&r)return{setVariableId:r,rewardAllowed:!0};if(!o&&i)return{setVariableId:i,rewardAllowed:!0}}checkRoomExits(e,t,a){if(Array.isArray(e)){for(const n of e)if(n.roomIndex===a.roomIndex&&n.x===a.x&&n.y===a.y){t[n.targetRoomIndex]&&this.gameState.setPlayerPosition(this.clamp(n.targetX,0,7),this.clamp(n.targetY,0,7),n.targetRoomIndex);break}}}clamp(e,t,a){return Math.max(t,Math.min(a,e))}};typeof window<"u"&&(window.InteractionManager=gt);const te=(m,e="")=>TextResources.get(m,e)||e||"",pt=(m,e={},t="")=>TextResources.format(m,e,t)||t||"";let ft=class{gameState;renderer;tileManager;onPlayerDefeated;interval;enemyMoveTimer;directions;dialogManager;fallbackMissChance;constructor(e,t,a,n={}){this.gameState=e,this.renderer=t,this.tileManager=a,this.onPlayerDefeated=n.onPlayerDefeated||(()=>{}),this.interval=n.interval||600,this.enemyMoveTimer=null,this.directions=n.directions||this.defaultDirections(),this.dialogManager=n.dialogManager||null,this.fallbackMissChance=this.normalizeMissChance(n.missChance===void 0?.25:n.missChance)}getEnemyDefinitions(){return this.gameState.getEnemyDefinitions()}getActiveEnemies(){return this.gameState.getEnemies()}addEnemy(e){const t=e.id||this.generateEnemyId(),a=this.normalizeEnemyType(e.type),n=this.gameState.addEnemy({id:t,type:a,roomIndex:e.roomIndex??0,x:e.x??0,y:e.y??0,lastX:e.x??0,defeatVariableId:e.defeatVariableId??null});return n?(this.renderer.draw(),n):null}removeEnemy(e){this.gameState.removeEnemy(e),this.renderer.draw()}generateEnemyId(){const e=typeof crypto<"u"?crypto:typeof window<"u"?window.crypto:null;return e?.randomUUID?e.randomUUID():`enemy-${Math.random().toString(36).slice(2,10)}`}start(){this.enemyMoveTimer&&clearInterval(this.enemyMoveTimer),this.enemyMoveTimer=setInterval(()=>this.tick(),this.interval)}stop(){this.enemyMoveTimer&&(clearInterval(this.enemyMoveTimer),this.enemyMoveTimer=null)}tick(){if(!this.gameState.playing||this.gameState.isEditorModeActive?.())return;const e=this.gameState.getEnemies();if(!this.hasMovableEnemies(e))return;const t=this.gameState.getGame();let a=!1;for(let n=0;n<e.length;n++){const i=this.tryMoveEnemy(e,n,t);if(i==="moved")a=!0;else if(i==="collided"){a=!0;break}}a&&this.renderer.draw()}handleEnemyCollision(e){if(this.gameState.isPlayerOnDamageCooldown()){this.renderer.showCombatIndicator(te("combat.cooldown",""),{duration:700});return}const t=this.gameState.getEnemies(),a=t[e];if(!a)return;if(a.type=this.normalizeEnemyType(a.type),this.canAssassinate(a)){this.assassinateEnemy(e);return}const n=this.getEnemyMissChance(a.type),i=this.attackMissed(n);if(t.splice(e,1),i)this.showMissFeedback();else{const l=this.getEnemyDamage(a.type),o=this.gameState.damagePlayer(l),c=this.gameState.consumeLastDamageReduction();if(this.gameState.consumeRecentReviveFlag?.()&&this.renderer.showCombatIndicator(te("skills.necromancer.revive",""),{duration:900}),c>0){const u=c>=l?te("combat.block.full",""):pt("combat.block.partial",{value:c},"");this.renderer.showCombatIndicator(u,{duration:700})}if(o<=0){this.onPlayerDefeated();return}}const r=this.getExperienceReward(a.type);this.gameState.handleEnemyDefeated(r)?.leveledUp&&this.shouldStartLevelOverlay()&&this.gameState.startLevelUpSelectionIfNeeded?.(),this.tryTriggerDefeatVariable(a),this.renderer.flashScreen({intensity:.8,duration:160}),this.checkAllEnemiesCleared(),this.renderer.draw()}checkCollisionAt(e,t){const a=this.gameState.getEnemies(),n=this.gameState.getPlayer().roomIndex,i=a.findIndex(r=>r.roomIndex===n&&r.x===e&&r.y===t);if(i!==-1){const r=a[i];if(this.canAssassinate(r)){this.assassinateEnemy(i);return}this.handleEnemyCollision(i)}}clamp(e,t,a){return Math.max(t,Math.min(a,e))}getRoomSize(){return 8}defaultDirections(){return[[0,0],[1,0],[-1,0],[0,1],[0,-1]]}hasMovableEnemies(e){return Array.isArray(e)&&e.length>0}tryMoveEnemy(e,t,a){const n=e[t];if(!n)return"none";n.type=this.normalizeEnemyType(n.type);const i=this.pickRandomDirection(),r=this.getTargetPosition(n,i,a),s=n.roomIndex??0;return this.canEnterTile(s,r.x,r.y,a,e,t)?(n.lastX=n.x,n.x=r.x,n.y=r.y,this.resolvePostMove(s,r.x,r.y,t)?"collided":"moved"):"none"}pickRandomDirection(){const e=this.directions;return e[Math.floor(Math.random()*e.length)]}getTargetPosition(e,t,a=null){const n=this.getRoomSize();return{x:this.clamp(e.x+t[0],0,n-1),y:this.clamp(e.y+t[1],0,n-1)}}canEnterTile(e,t,a,n,i,r){const s=n.rooms[e];return!s||this.isBorderTile(e,t,a,n)||s.walls?.[a]?.[t]||this.isTileBlocked(e,t,a)||this.hasBlockingObject(e,t,a)?!1:!this.isOccupied(i,r,e,t,a)}isTileBlocked(e,t,a){const n=this.tileManager.getTileMap(e),i=n?.ground?.[a]?.[t]??null,s=n?.overlay?.[a]?.[t]??null??i;return s==null?!1:!!this.tileManager.getTile(s)?.collision}hasBlockingObject(e,t,a){const n=ObjectTypes,i=this.gameState.getObjectAt?.(e,t,a)??null;return i?i.type===n.DOOR&&!i.opened?!0:i.type===n.DOOR_VARIABLE?!(i.variableId?this.gameState.isVariableOn(i.variableId):!1):!1:!1}isOccupied(e,t,a,n,i){return e.some((r,s)=>s!==t&&r.roomIndex===a&&r.x===n&&r.y===i)}isBorderTile(e,t,a,n=null){const i=this.getRoomSize();return i<=2?!1:t===0||a===0||t===i-1||a===i-1}resolvePostMove(e,t,a,n){const i=this.gameState.getPlayer();return i.roomIndex===e&&i.x===t&&i.y===a?(this.tryStealthAssassination(n)||this.handleEnemyCollision(n),!0):!1}collideAt(e,t,a){const i=this.gameState.getEnemies().findIndex(r=>r.roomIndex===e&&r.x===t&&r.y===a);return i===-1?!1:(this.handleEnemyCollision(i),!0)}normalizeEnemyType(e){return EnemyDefinitions.normalizeType(e)}getEnemyDefinition(e){return EnemyDefinitions.getEnemyDefinition(e)}enemyHasEyes(e){if(!e)return!0;const t=this.getEnemyDefinition(e.type);return t?t.hasEyes!==!1:!0}canAssassinate(e){return!this.gameState.hasSkill?.("stealth")||!e?!1:this.getEnemyDamage(e.type)<=2}tryStealthAssassination(e){const a=this.gameState.getEnemies()?.[e];return this.canAssassinate(a)?Math.random()<.25?(this.showStealthMissFeedback(),!1):(this.assassinateEnemy(e),!0):!1}assassinateEnemy(e){const t=this.gameState.getEnemies(),a=t?.[e];if(!a)return;const n=this.normalizeEnemyType(a.type);t.splice(e,1);const i=this.getExperienceReward(n);this.gameState.handleEnemyDefeated(i)?.leveledUp&&this.shouldStartLevelOverlay()&&this.gameState.startLevelUpSelectionIfNeeded?.(),this.tryTriggerDefeatVariable({...a,type:n}),this.showStealthKillFeedback(),this.renderer.flashScreen({intensity:.4,duration:120}),this.checkAllEnemiesCleared(),this.renderer.draw()}showStealthKillFeedback(){const e=te("combat.stealthKill","");e&&this.renderer.showCombatIndicator?.(e,{duration:800})}showStealthMissFeedback(){const e=te("combat.stealthMiss","");e&&this.renderer.showCombatIndicator?.(e,{duration:800})}shouldStartLevelOverlay(){return this.gameState?.getPendingLevelUpChoices?.()>0}getEnemyDamage(e){const t=this.getEnemyDefinition(e);return t&&Number.isFinite(t.damage)?Math.max(1,t.damage):1}getExperienceReward(e){return EnemyDefinitions.getExperienceReward(e)}getEnemyMissChance(e){const t=EnemyDefinitions.getMissChance(e);return t!=null?this.normalizeMissChance(t):this.fallbackMissChance}checkAllEnemiesCleared(){if((this.gameState.getEnemies()?.length??0)<=0){const t=te("game.clearAllEnemies","");t&&this.dialogManager?.showDialog?.(t)}}normalizeMissChance(e){const t=Number(e);return Number.isFinite(t)?Math.max(0,Math.min(1,t)):.25}attackMissed(e){let t;return e===void 0?(t=this.normalizeMissChance(this.fallbackMissChance),this.fallbackMissChance=t):t=this.normalizeMissChance(e),t<=0?!1:t>=1?!0:Math.random()<t}getDefeatVariableConfig(e){if(!e)return null;const t=this.getEnemyDefinition(e.type),a=t?.activateVariableOnDefeat&&typeof t.activateVariableOnDefeat=="object"?t.activateVariableOnDefeat:null;let n=typeof e.defeatVariableId=="string"?e.defeatVariableId:null;if(n||(n=typeof a?.variableId=="string"?a.variableId:null),n=this.gameState.normalizeVariableId(n),!n)return null;const i=a?.persist!==void 0?!!a.persist:!0;let r=null;return typeof a?.message=="string"&&a.message.trim().length?r=a.message.trim():a?.messageKey?r=te(a.messageKey,a.message||""):t?.defeatActivationMessageKey?r=te(t.defeatActivationMessageKey,t.defeatActivationMessage?.trim()||""):typeof t?.defeatActivationMessage=="string"&&t.defeatActivationMessage.trim().length&&(r=t.defeatActivationMessage.trim()),{variableId:n,persist:i,message:r}}tryTriggerDefeatVariable(e){const t=this.getDefeatVariableConfig(e);if(!t)return!1;const a=this.gameState.setVariableValue(t.variableId,!0,t.persist),n=this.gameState.isVariableOn(t.variableId);return!a&&!n?!1:(t.message&&this.renderer.showCombatIndicator(t.message,{duration:900}),!0)}showMissFeedback(){this.renderer.showCombatIndicator("Miss",{duration:500})}};typeof window<"u"&&(window.EnemyManager=ft);const he=(m,e="")=>TextResources.get(m,e)||e||"",yt=(m,e={},t="")=>TextResources.format(m,e,t)||t||"";let vt=class{gameState;tileManager;renderer;dialogManager;interactionManager;enemyManager;transitioning;constructor({gameState:e,tileManager:t,renderer:a,dialogManager:n,interactionManager:i,enemyManager:r}){this.gameState=e,this.tileManager=t,this.renderer=a,this.dialogManager=n,this.interactionManager=i,this.enemyManager=r,this.transitioning=!1}tryMove(e,t){if(this.transitioning||this.gameState.isGameOver()||this.gameState.isLevelUpCelebrationActive?.()||this.gameState.isLevelUpOverlayActive?.()||this.gameState.isPickupOverlayActive?.())return;const a=this.gameState.getDialog();if(a.active){if(a.page>=a.maxPages){this.dialogManager.closeDialog();return}this.gameState.setDialogPage(a.page+1),this.renderer.draw();return}const n=this.gameState.getPlayer(),i=this.getDirectionFromDelta(e,t),r=n.roomIndex,s={x:n?.x??0,y:n?.y??0,roomIndex:r,lastX:n?.lastX??n?.x??0,facingLeft:(n?.x??0)<(n?.lastX??n?.x??0)},l=this.gameState.getRoomCoords(r),o=this.gameState.game.roomSize-1;let c=r,d=n.x+e,u=n.y+t;if(d<0){const v=l.col-1,I=this.gameState.getRoomIndex(l.row,v);I!==null?(c=I,d=o):d=0}else if(d>o){const v=l.col+1,I=this.gameState.getRoomIndex(l.row,v);I!==null?(c=I,d=0):d=o}if(u<0){const v=l.row-1,I=this.gameState.getRoomIndex(v,l.col);I!==null?(c=I,u=o):u=0}else if(u>o){const v=l.row+1,I=this.gameState.getRoomIndex(v,l.col);I!==null?(c=I,u=0):u=o}const h=c!==r,g=this.gameState.getGame().rooms?.[c];if(!g){h&&this.flashBlockedEdge(i,{x:d,y:u});return}if(g.walls?.[u]?.[d]){h&&this.flashBlockedEdge(i,{x:d,y:u});return}ObjectTypes;const p=this.gameState.getObjectAt(c,d,u)??null;if(!!p?.isVariableDoor){const v=p?.variableId;if(!(v?this.gameState.isVariableOn(v):!1)){this.dialogManager.showDialog(he("doors.variableLocked")),this.renderer.draw();return}}if(!!p?.isLockedDoor&&!p?.opened){const v=this.gameState.hasSkill?.("keyless-doors");let I=!1,k=!1;if(v?I=!0:k=this.gameState.consumeKey(),I||k){p&&(p.opened=!0);const w=this.gameState.getKeys(),F=I?he("doors.unlockedSkill",he("doors.opened","")):Number.isFinite(w)?yt("doors.openedRemaining",{value:w}):he("doors.opened");F&&this.dialogManager.showDialog(F)}else{this.dialogManager.showDialog(he("doors.locked")),this.renderer.draw();return}}const T=this.tileManager.getTileMap(c),b=T?.overlay?.[u]?.[d]??null,x=T?.ground?.[u]?.[d]??null,O=b??x;if(O!=null){const v=this.tileManager.getTile(O);if(v?.collision&&!this.canTraverseCollisionTile(v)){h&&this.flashBlockedEdge(i,{x:d,y:u});return}}const N=this.findNpcAt(c,d,u);if(N){const v=this.interactionManager.getNpcDialogText?this.interactionManager.getNpcDialogText(N):N.text||"",I=this.interactionManager.getNpcDialogMeta?this.interactionManager.getNpcDialogMeta(N):void 0;v&&(this.dialogManager.showDialog(v,I),this.renderer.draw());return}if(!h&&(this.enemyManager?.collideAt?.(c,d,u)||!1)){this.renderer.draw();return}const D=h,L=D?this.renderer.captureGameplayFrame():null;if(this.gameState.setPlayerPosition(d,u,c!==r?c:null),h){const v=this.gameState.getPlayer();v&&(e!==0?v.lastX=v.x-Math.sign(e):s.lastX!==void 0&&(v.lastX=s.lastX),v.lastRoomChangeTime=Date.now())}this.interactionManager.handlePlayerInteractions();const A=this.gameState.getPlayer();if(this.enemyManager.checkCollisionAt(A.x,A.y),D&&L){this.renderer.draw();const v=this.renderer.captureGameplayFrame();if(v&&this.renderer.startRoomTransition({direction:i,fromFrame:L,toFrame:v,playerPath:{from:s,to:{x:d,y:u,roomIndex:c},facingLeft:e<0?!0:e>0?!1:s.facingLeft},onComplete:()=>{this.transitioning=!1,this.renderer.draw()}})){this.transitioning=!0;return}}this.renderer.draw()}getDirectionFromDelta(e,t){return e<0?"left":e>0?"right":t<0?"up":t>0?"down":""}canTraverseCollisionTile(e=null){if(!e?.collision)return!0;const t=(s="")=>s.toString().trim().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,""),a=t(e.category||""),n=t(e.name||""),i=a==="agua"||n.includes("agua"),r=a==="perigo"||n.includes("lava");return!!(i&&this.gameState.hasSkill?.("water-walker")||r&&this.gameState.hasSkill?.("lava-walker"))}flashBlockedEdge(e,t=null){e&&(this.renderer.flashEdge(e,{duration:240,tileX:t?.x,tileY:t?.y}),this.renderer.draw())}findNpcAt(e,t,a){return(this.gameState?.getGame()?.sprites||[]).find(i=>i.placed&&i.roomIndex===e&&i.x===t&&i.y===a)||null}};typeof window<"u"&&(window.MovementManager=vt);let bt=class{gameEngine;touchStart;constructor(e){this.gameEngine=e,this.touchStart=null,this.setupEventListeners()}isGameModeActive(){return typeof document>"u"?!1:document.body?.classList?.contains("game-mode")??!1}setupEventListeners(){document.addEventListener("keydown",e=>this.handleKeyDown(e)),document.addEventListener("touchstart",e=>this.handleTouchStart(e),{passive:!1}),document.addEventListener("touchmove",e=>this.handleTouchMove(e),{passive:!1}),document.addEventListener("touchend",e=>this.handleTouchEnd(e),{passive:!1}),document.addEventListener("click",e=>this.handleClick(e))}handleKeyDown(e){if(this.gameEngine.isGameOver?.()){e.preventDefault(),this.gameEngine.handleGameOverInteraction?.();return}if(this.gameEngine.isIntroVisible?.()){e.preventDefault(),this.gameEngine.dismissIntroScreen?.();return}if(this.gameEngine.isLevelUpOverlayActive?.()){e.preventDefault(),this.handleLevelUpKey(e);return}if(this.gameEngine.isPickupOverlayActive?.()){e.preventDefault(),this.gameEngine.dismissPickupOverlay?.();return}const t=this.gameEngine.gameState.getDialog();if(t.active){switch(e.key.toLowerCase()){case"z":case"enter":case" ":e.preventDefault(),t.page>=t.maxPages?this.gameEngine.closeDialog():(this.gameEngine.gameState.setDialogPage(t.page+1),this.gameEngine.renderer.draw());break}return}const a=e.target,n=a?.tagName?.toLowerCase?.()||"",i=n==="input"||n==="textarea"||n==="select"||a?.isContentEditable;if(!this.isGameModeActive()||i)return;const s=e.key?.toLowerCase()||"",o={arrowleft:[-1,0],a:[-1,0],arrowright:[1,0],d:[1,0],arrowup:[0,-1],w:[0,-1],arrowdown:[0,1],s:[0,1]}[s];o&&(e.preventDefault(),this.gameEngine.tryMove(o[0],o[1]))}handleTouchStart(e){if(!this.isGameModeActive()){this.touchStart=null;return}if(this.gameEngine.isGameOver?.()){e.preventDefault?.(),this.gameEngine.handleGameOverInteraction?.(),this.touchStart=null;return}if(this.gameEngine.isIntroVisible?.()){e.preventDefault?.(),this.gameEngine.dismissIntroScreen?.(),this.touchStart=null;return}if(this.gameEngine.isLevelUpOverlayActive?.()){e.preventDefault?.();const a=e.changedTouches?.[0];a&&this.chooseLevelUpByPointer(a.clientX,a.clientY),this.touchStart=null;return}if(this.gameEngine.isPickupOverlayActive?.()){e.preventDefault?.(),this.gameEngine.dismissPickupOverlay?.(),this.touchStart=null;return}const t=e.changedTouches?.[0];t&&(this.touchStart={x:t.clientX,y:t.clientY,time:Date.now(),prevented:!1})}handleTouchMove(e){if(!this.isGameModeActive()){this.touchStart=null;return}const t=this.touchStart;if(!t)return;const a=e.changedTouches?.[0];if(!a)return;const n=a.clientX-t.x,i=a.clientY-t.y;Math.sqrt(n*n+i*i)>=12?(e.preventDefault(),t.prevented=!0):t.prevented&&e.preventDefault()}handleTouchEnd(e){if(!this.isGameModeActive()){this.touchStart=null;return}if(this.gameEngine.isGameOver?.()){e.preventDefault?.(),this.gameEngine.handleGameOverInteraction?.(),this.touchStart=null;return}if(this.gameEngine.isIntroVisible?.()){e.preventDefault?.(),this.gameEngine.dismissIntroScreen?.(),this.touchStart=null;return}if(this.gameEngine.isLevelUpOverlayActive?.()){e.preventDefault?.();const u=e.changedTouches?.[0];u&&this.chooseLevelUpByPointer(u.clientX,u.clientY),this.touchStart=null;return}if(this.gameEngine.isPickupOverlayActive?.()){e.preventDefault?.(),this.gameEngine.dismissPickupOverlay?.(),this.touchStart=null;return}const t=this.touchStart;if(!t)return;const a=e.changedTouches?.[0];if(!a){this.touchStart=null;return}const n=a.clientX-t.x,i=a.clientY-t.y,r=Math.abs(n),s=Math.abs(i),l=Math.sqrt(n*n+i*i),o=Date.now()-t.time;this.touchStart=null,!(l<24||o>600)&&(e.preventDefault(),r>s?n>0?this.gameEngine.tryMove(1,0):this.gameEngine.tryMove(-1,0):i>0?this.gameEngine.tryMove(0,1):this.gameEngine.tryMove(0,-1))}handleClick(e){this.isGameModeActive()&&this.gameEngine.isLevelUpOverlayActive?.()&&(e.preventDefault?.(),this.chooseLevelUpByPointer(e.clientX,e.clientY))}handleLevelUpKey(e){const t=e.key?.toLowerCase?.()||"";if(t==="1"){this.gameEngine.chooseLevelUpSkill?.(0);return}if(t==="2"){this.gameEngine.chooseLevelUpSkill?.(1);return}if(t==="arrowup"||t==="w"){this.gameEngine.moveLevelUpCursor?.(-1),this.gameEngine.draw?.();return}if(t==="arrowdown"||t==="s"){this.gameEngine.moveLevelUpCursor?.(1),this.gameEngine.draw?.();return}(t==="enter"||t===" "||t==="z")&&this.gameEngine.confirmLevelUpSelection?.()}chooseLevelUpByPointer(e,t){const a=this.gameEngine.pickLevelUpChoiceFromPointer?.(e,t);a!=null&&this.gameEngine.chooseLevelUpSkill?.(a)}setupEditorInputs(e,t){let a=!1;e.addEventListener("mousedown",n=>{a=!0,t(n)}),e.addEventListener("mousemove",n=>{a&&t(n)}),document.addEventListener("mouseup",()=>{a&&(a=!1)})}setupTileEditorInputs(e,t){let a=!1;e.addEventListener("mousedown",n=>{a=!0,t(n)}),e.addEventListener("mousemove",n=>{a&&t(n)}),document.addEventListener("mouseup",()=>{a=!1})}};typeof window<"u"&&(window.InputManager=bt);let St=class{static get OBJECT_DEFINITIONS(){return this._objectDefinitions||(typeof window<"u"&&window.ObjectDefinitions?(!window.ObjectTypes&&window.ObjectDefinitions.TYPES&&(window.ObjectTypes=window.ObjectDefinitions.TYPES),this._objectDefinitions=window.ObjectDefinitions.definitions||window.ObjectDefinitions.OBJECT_DEFINITIONS||[]):this._objectDefinitions=[]),this._objectDefinitions}static get ENEMY_DEFINITIONS(){const e=typeof window<"u"&&window.EnemyDefinitions;return(!this._enemyDefinitions||e&&!this._enemyDefinitions.length)&&(e?this._enemyDefinitions=window.EnemyDefinitions.definitions||window.EnemyDefinitions.ENEMY_DEFINITIONS||[]:this._enemyDefinitions||(this._enemyDefinitions=[])),this._enemyDefinitions||[]}static get OBJECT_TYPE_ORDER(){return ObjectDefinitions.getEditorTypeOrder()}};typeof window<"u"&&(window.EditorConstants=St);let wt=class{constructor(e=document){this.root=e,this.editorCanvas=e.getElementById("editor-canvas"),this.mapPosition=e.getElementById("editor-map-position"),this.mapNavButtons=Array.from(e.querySelectorAll(".map-nav-button")),this.mobileNavButtons=Array.from(e.querySelectorAll(".editor-mobile-nav-button")),this.mobilePanels=Array.from(e.querySelectorAll(".editor-section[data-mobile-panel]")),this.selectedTilePreview=e.getElementById("selected-tile-preview"),this.tileSummary=e.getElementById("tile-preset-summary"),this.tileList=e.getElementById("tile-list"),this.npcsList=e.getElementById("npcs-list"),this.npcText=e.getElementById("npc-text"),this.npcConditionalText=e.getElementById("npc-conditional-text"),this.npcConditionalVariable=e.getElementById("npc-conditional-variable"),this.npcRewardVariable=e.getElementById("npc-reward-variable"),this.npcConditionalRewardVariable=e.getElementById("npc-conditional-reward-variable"),this.btnToggleNpcConditional=e.getElementById("btn-toggle-npc-conditional"),this.npcConditionalSection=e.getElementById("npc-conditional-section"),this.npcVariantButtons=Array.from(e.querySelectorAll("[data-npc-variant-filter]")),this.worldGrid=e.getElementById("world-grid"),this.titleInput=e.getElementById("game-title"),this.authorInput=e.getElementById("game-author"),this.fileInput=e.getElementById("file-input"),this.objectTypes=e.getElementById("object-types"),this.objectsList=e.getElementById("objects-list"),this.btnNpcDelete=e.getElementById("npc-delete"),this.npcEditor=e.querySelector(".npc-editor"),this.btnGenerateUrl=e.getElementById("btn-generate-url"),this.shareUrlInput=e.getElementById("project-share-url"),this.btnUndo=e.getElementById("btn-undo"),this.btnRedo=e.getElementById("btn-redo"),this.enemyTypes=e.getElementById("enemy-types"),this.enemiesList=e.getElementById("enemies-list"),this.projectVariablesContainer=e.getElementById("project-variables-container"),this.projectVariablesToggle=e.getElementById("project-variables-toggle"),this.projectVariableList=e.getElementById("project-variable-usage-list"),this.projectVariableSummary=e.getElementById("project-variable-usage-summary"),this.projectSkillsContainer=e.getElementById("project-skills-container"),this.projectSkillsToggle=e.getElementById("project-skills-toggle"),this.projectSkillsList=e.getElementById("project-skills-list"),this.projectTestContainer=e.getElementById("project-test-container"),this.projectTestToggle=e.getElementById("project-test-toggle"),this.projectTestPanel=e.getElementById("project-test-panel"),this.projectTestStartLevel=e.getElementById("project-test-start-level"),this.projectTestSkillList=e.getElementById("project-test-skill-list"),this.projectTestGodMode=e.getElementById("project-test-god-mode")}};typeof window<"u"&&(window.EditorDomCache=wt);let Et=class{constructor(){this.selectedTileId=null,this.selectedNpcId=null,this.selectedNpcType=null,this.activeRoomIndex=0,this.placingNpc=!1,this.placingEnemy=!1,this.placingObjectType=null,this.selectedObjectType=null,this.selectedEnemyType=null,this.mapPainting=!1,this.skipMapHistory=!1,this.npcTextUpdateTimer=null,this.suppressNpcFormUpdates=!1,this.conditionalDialogueExpanded=!1,this.activeMobilePanel="tiles",this.npcVariantFilter="human",this.playerEndTextUpdateTimer=null,this.variablePanelCollapsed=!0,this.skillPanelCollapsed=!0,this.testPanelCollapsed=!0}};typeof window<"u"&&(window.EditorState=Et);let Mt=class{constructor(e){this.editorManager=e,this.stack=[],this.index=-1}pushSnapshot(e){this.stack[this.index]!==e&&(this.stack=this.stack.slice(0,this.index+1),this.stack.push(e),this.index=this.stack.length-1)}pushCurrentState(){const e=JSON.stringify(this.editorManager.gameEngine.exportGameData());this.pushSnapshot(e)}canUndo(){return this.index>0}canRedo(){return this.index<this.stack.length-1}undo(){this.canUndo()&&(this.index-=1,this.restoreCurrent())}redo(){this.canRedo()&&(this.index+=1,this.restoreCurrent())}restoreCurrent(){const e=this.stack[this.index];if(!e)return;const t=JSON.parse(e);this.editorManager.restore(t,{skipHistory:!0})}};typeof window<"u"&&(window.EditorHistoryManager=Mt);let Tt=class{constructor(e){this.manager=e,this.shareTracker=this.createShareTracker()}get text(){return typeof TextResources<"u"?TextResources:null}t(e,t=""){const n=this.text?.get?.(e,t);return n||t||e||""}async buildShareUrl(){const e=window.ShareUtils?window.ShareUtils:typeof window<"u"?window.TinyRPGShare:null;if(!e?.buildShareUrl)return alert(this.t("alerts.share.unavailable")),null;const t=this.manager.gameEngine.exportGameData(),a=e.buildShareUrl(t);try{window.history?.replaceState?.(null,"",a)}catch{}return a}updateShareUrlField(e){const t=this.manager?.dom?.shareUrlInput;t&&(t.value=e||"")}async generateShareableUrl(){try{const e=await this.buildShareUrl();if(!e)return;this.updateShareUrlField(e),navigator.clipboard?.writeText?(await navigator.clipboard.writeText(e),alert(this.t("alerts.share.copied"))):prompt(this.t("alerts.share.copyPrompt"),e),this.trackShareUrl(e)}catch(e){console.error(e),alert(this.t("alerts.share.generateError"))}}createShareTracker(){if(typeof FirebaseShareTracker>"u")return null;if(FirebaseShareTracker.fromGlobal)return FirebaseShareTracker.fromGlobal();const e=typeof window<"u"?window.TinyRPGFirebaseConfig:null,t=typeof window<"u"?window.TinyRPGFirebaseCollection:null;return new FirebaseShareTracker(e,{collection:t})}async trackShareUrl(e){if(!this.shareTracker?.trackShareUrl)return;console.info("[TinyRPG] Tracking share URL...",{url:e});const t=await this.shareTracker.trackShareUrl(e,{source:"editor"});console.info("[TinyRPG] Share URL tracking result:",t?"ok":"failed")}saveGame(){const e=new Blob([JSON.stringify(this.manager.gameEngine.exportGameData(),null,2)],{type:"application/json"}),t=URL.createObjectURL(e),a=document.createElement("a");a.href=t,a.download="tiny-rpg-maker.json",document.body.appendChild(a),a.click(),a.remove(),URL.revokeObjectURL(t)}loadGameFile(e){const t=e.target?.files?.[0];if(!t)return;const a=new FileReader;a.onload=()=>{try{const n=JSON.parse(a.result);this.manager.restore(n,{skipHistory:!0}),this.manager.history.pushCurrentState()}catch{alert(this.t("alerts.share.loadError"))}},a.readAsText(t),e.target.value=""}};typeof window<"u"&&(window.EditorShareService=Tt);let xt=class{constructor(e){this.manager=e}get gameEngine(){return this.manager.gameEngine}get state(){return this.manager.state}get dom(){return this.manager.dom}get renderService(){return this.manager.renderService}};typeof window<"u"&&(window.EditorManagerModule=xt);let It=class extends EditorManagerModule{bind(){const{btnNpcDelete:e,btnGenerateUrl:t,btnUndo:a,btnRedo:n,titleInput:i,authorInput:r,npcText:s,npcConditionalText:l,npcConditionalVariable:o,npcRewardVariable:c,npcConditionalRewardVariable:d,btnToggleNpcConditional:u,fileInput:h,editorCanvas:g,npcVariantButtons:p,enemyTypes:f,enemiesList:y,objectTypes:T,objectsList:b,tileList:x,npcsList:O,mapNavButtons:N,mobileNavButtons:D,mobilePanels:L,worldGrid:A,projectVariablesToggle:v,projectSkillsToggle:I,projectTestToggle:k,projectTestStartLevel:w,projectTestSkillList:F,projectTestGodMode:$,shareUrlInput:H}=this.dom,P=this.manager,X=P.npcService,S=P.enemyService,U=P.objectService,z=P.shareService,W=P.tileService,J=P.worldService;e?.addEventListener("click",()=>X.removeSelectedNpc()),u?.addEventListener("click",()=>{this.state.conditionalDialogueExpanded=!this.state.conditionalDialogueExpanded,this.renderService.updateNpcForm()}),t?.addEventListener("click",()=>z.generateShareableUrl()),a?.addEventListener("click",()=>P.undo()),n?.addEventListener("click",()=>P.redo()),v?.addEventListener("click",()=>P.toggleVariablePanel()),I?.addEventListener("click",()=>P.toggleSkillPanel()),k?.addEventListener("click",()=>P.toggleTestPanel()),i?.addEventListener("input",()=>P.updateGameMetadata()),r?.addEventListener("input",()=>P.updateGameMetadata()),w?.addEventListener("change",E=>{const C=Number(E.target.value);P.setTestStartLevel(C)}),$?.addEventListener("change",E=>{P.setGodMode(E.target.checked)}),H?.addEventListener("focus",()=>H.select()),H?.addEventListener("click",()=>H.select()),F?.addEventListener("change",E=>{const C=E.target;if(!C||C.tagName!=="INPUT")return;const j=Array.from(F.querySelectorAll('input[type="checkbox"][data-skill-id]')).filter(Y=>Y.checked).map(Y=>Y.dataset.skillId).filter(Boolean);P.setTestSkills(j)}),s?.addEventListener("input",()=>X.updateNpcText(s.value)),l?.addEventListener("input",()=>X.updateNpcConditionalText(l.value)),o?.addEventListener("change",E=>X.handleConditionVariableChange(E.target.value)),c?.addEventListener("change",E=>X.handleRewardVariableChange(E.target.value)),d?.addEventListener("change",E=>X.handleConditionalRewardVariableChange(E.target.value)),Array.isArray(p)&&p.forEach(E=>{E.addEventListener("click",()=>{const C=E.dataset.npcVariantFilter;C&&X.setVariantFilter(C)})}),h?.addEventListener("change",E=>z.loadGameFile(E)),x?.addEventListener("click",E=>{const C=E.target.closest("[data-tile-id]");if(!C)return;const j=Number(C.dataset.tileId);Number.isFinite(j)&&(this.state.placingObjectType&&U.togglePlacement(this.state.placingObjectType,!0),P.desselectAllAndRender(),P.selectedTileId=j,this.renderService.updateSelectedTilePreview(),this.renderService.renderTileList())}),O?.addEventListener("click",E=>{const C=E.target.closest(".npc-card");if(!C)return;const j=C.dataset.type||null,Y=C.dataset.id||null;P.desselectAllAndRender(),X.updateNpcSelection(j,Y)}),T?.addEventListener("click",E=>{const C=E.target.closest(".object-type-card");if(!C)return;const j=C.dataset.type||null;j&&(P.desselectAllAndRender(),U.selectObjectType(j))}),b?.addEventListener("click",E=>{const C=E.target.closest(".object-remove");if(!C)return;const j=C.closest(".object-card");if(!j)return;const Y=j.dataset.type,re=Number(j.dataset.roomIndex);!Y||!Number.isFinite(re)||U.removeObject(Y,re)}),f?.addEventListener("click",E=>{const C=E.target.closest(".enemy-card");if(!C)return;const j=C.dataset.type||null;j&&(P.desselectAllAndRender(),S.selectEnemyType(j))}),y?.addEventListener("click",E=>{const C=E.target.closest("[data-remove-enemy]");if(!C)return;const j=C.dataset.removeEnemy;j&&S.removeEnemy(j)}),y?.addEventListener("change",E=>{const C=E.target;if(!C||C.tagName!=="SELECT")return;const j=C.dataset.enemyVariable;if(!j)return;const Y=C.value||"";S.handleEnemyVariableChange(j,Y)}),A?.addEventListener("click",E=>{const C=E.target.closest("[data-room-index]");if(!C)return;const j=Number(C.dataset.roomIndex);J.setActiveRoom(j)}),Array.isArray(N)&&N.forEach(E=>{E.addEventListener("click",()=>{const C=E.dataset.direction;C&&J.moveActiveRoom(C)})}),g&&(g.addEventListener("pointerdown",E=>W.startPaint(E)),g.addEventListener("pointermove",E=>W.continuePaint(E))),Array.isArray(D)&&D.forEach(E=>{E.addEventListener("click",()=>{const C=E.dataset.mobileTarget;C&&P.setActiveMobilePanel(C)})}),window.addEventListener("pointerup",E=>W.finishPaint(E)),document.addEventListener("keydown",E=>P.handleKey(E)),window.addEventListener("resize",E=>{P.handleCanvasResize(E),P.updateMobilePanels()}),document.addEventListener("editor-tab-activated",()=>requestAnimationFrame(()=>{P.handleCanvasResize(!0),P.updateMobilePanels()})),window.addEventListener("pointerup",E=>W.finishPaint(E))}};typeof window<"u"&&(window.EditorEventBinder=It);let Ct=class extends EditorManagerModule{updateGameMetadata(){const e=this.gameEngine.getGame(),t=this.normalizeTitle(this.dom.titleInput?.value||""),a=this.normalizeAuthor(this.dom.authorInput?.value||"");e.title=t,e.author=a,this.gameEngine.syncDocumentTitle(),this.gameEngine.refreshIntroScreen(),this.updateJSON()}updateJSON(){this.dom.jsonArea&&(this.dom.jsonArea.value=JSON.stringify(this.gameEngine.exportGameData(),null,2)),this.renderService.renderVariableUsage(),this.renderService.renderSkillList(),this.renderService.renderTestTools()}toggleVariablePanel(){this.state.variablePanelCollapsed=!this.state.variablePanelCollapsed,this.renderService.renderVariableUsage()}toggleSkillPanel(){this.state.skillPanelCollapsed=!this.state.skillPanelCollapsed,this.renderService.renderSkillList()}toggleTestPanel(){this.state.testPanelCollapsed=!this.state.testPanelCollapsed,this.renderService.renderTestTools()}setTestStartLevel(e){const t=this.gameEngine.getMaxPlayerLevel?.()??1,a=Number.isFinite(e)?Math.max(1,Math.min(t,Math.floor(e))):1;this.gameEngine.updateTestSettings?.({startLevel:a}),this.renderService.renderTestTools()}setTestSkills(e){const t=Array.isArray(e)?Array.from(new Set(e.filter(a=>typeof a=="string"&&a))):[];this.gameEngine.updateTestSettings?.({skills:t}),this.renderService.renderTestTools()}setGodMode(e=!1){this.gameEngine.updateTestSettings?.({godMode:!!e}),this.renderService.renderTestTools()}syncUI(){const e=this.gameEngine.getGame();this.dom.titleInput&&(this.dom.titleInput.value=e.title||""),this.dom.authorInput&&(this.dom.authorInput.value=e.author||""),this.updateJSON()}setActiveMobilePanel(e){if(e){if(this.state.activeMobilePanel===e){this.updateMobilePanels();return}this.state.activeMobilePanel=e,this.updateMobilePanels()}}updateMobilePanels(){const e=this.state.activeMobilePanel||"tiles";(Array.isArray(this.dom.mobileNavButtons)?this.dom.mobileNavButtons:[]).forEach(i=>{const r=i.dataset.mobileTarget===e;i.classList.toggle("active",r)});const a=Array.isArray(this.dom.mobilePanels)?this.dom.mobilePanels:[],n=typeof window<"u"?window.matchMedia("(max-width: 920px)").matches:!1;a.forEach(i=>{if(!i)return;if(!n){i.classList.remove("is-mobile-active");return}const r=i.dataset.mobilePanel===e;i.classList.toggle("is-mobile-active",r)})}handleLanguageChange(){TextResources.apply(),this.gameEngine?.gameState?.variableManager?.refreshPresetNames?.(),this.refreshNpcLocalizedText(),this.manager.renderAll(),this.updateJSON()}refreshNpcLocalizedText(){const e=this.gameEngine?.getSprites?.();if(!Array.isArray(e))return;const t=this.gameEngine?.npcManager?.getDefinitions?.()||[],a=new Map(t.map(n=>[n.type,n]));e.forEach(n=>{const i=n?.type?a.get(n.type):null;i?.nameKey&&(n.name=TextResources.get?.(i.nameKey,i.name||n.name||"")||n.name||""),n?.textKey&&(n.text=TextResources.get?.(n.textKey,n.text||"")||n.text||"")})}normalizeTitle(e){return String(e||"").slice(0,18).replace(/\s+/g," ").trim()||"Tiny RPG Studio"}normalizeAuthor(e){return String(e||"").slice(0,18).replace(/\s+/g," ").trim()}};typeof window<"u"&&(window.EditorUIController=Ct);let Rt=class extends EditorManagerModule{handleCanvasResize(e=!1){const t=this.manager.editorCanvas;if(!t)return;const a=t.parentElement;if(!a)return;const n=a.offsetWidth||a.clientWidth||0,i=512,r=128,s=Math.floor((n+r-1)/r)*r,l=Math.min(Math.max(s,r),i);!e&&Math.abs(t.width-l)<1||(t.style.width=`${l}px`,t.width=l,t.height=l,this.renderService.renderEditor(),this.renderService.renderEnemies())}handleKey(e){if(!e.defaultPrevented){if(e.key==="Escape"){if(this.state.placingNpc||this.manager.selectedNpcId||this.manager.selectedNpcType){this.manager.npcService.clearSelection(),e.preventDefault();return}if(this.state.placingEnemy){this.manager.enemyService.deactivatePlacement(),e.preventDefault();return}if(this.state.placingObjectType){this.manager.objectService.togglePlacement(this.state.placingObjectType,!0),e.preventDefault();return}}(e.ctrlKey||e.metaKey)&&e.key.toLowerCase()==="z"&&(e.preventDefault(),e.shiftKey?this.manager.redo():this.manager.undo()),(e.ctrlKey||e.metaKey)&&e.key.toLowerCase()==="y"&&(e.preventDefault(),this.manager.redo())}}};typeof window<"u"&&(window.EditorInteractionController=Rt);let Nt=class{constructor(e){this.service=e}get manager(){return this.service.manager}get dom(){return this.service.dom}get state(){return this.service.state}get gameEngine(){return this.service.gameEngine}t(e,t=""){return this.service.t(e,t)}tf(e,t={},a=""){return this.service.tf(e,t,a)}};typeof window<"u"&&(window.EditorRendererBase=Nt);let Ot=class extends EditorRendererBase{renderEditor(){const e=this.manager.ectx,t=this.dom.editorCanvas;if(!e||!t)return;e.clearRect(0,0,t.width,t.height);const a=Math.floor(t.width/8),n=this.state.activeRoomIndex,i=this.gameEngine.getTileMap(n),r=i?.ground||[],s=i?.overlay||[];for(let l=0;l<8;l++)for(let o=0;o<8;o++){const c=r[l]?.[o];c!=null?this.drawTile(e,c,o*a,l*a,a):(e.fillStyle="#141414",e.fillRect(o*a,l*a,a,a));const d=s[l]?.[o];d!=null&&this.drawTile(e,d,o*a,l*a,a)}e.strokeStyle="rgba(255,255,255,0.1)";for(let l=0;l<=8;l++)e.beginPath(),e.moveTo(l*a,0),e.lineTo(l*a,t.height),e.stroke();for(let l=0;l<=8;l++)e.beginPath(),e.moveTo(0,l*a),e.lineTo(t.width,l*a),e.stroke();this.drawEntities(a)}drawEntities(e){const t=this.manager.ectx,a=this.state.activeRoomIndex,n=e/8,i=this.gameEngine.getObjectsForRoom(a);for(const c of i)this.gameEngine.renderer.drawObjectSprite(t,c.type,c.x*e,c.y*e,n);const r=this.gameEngine.getSprites().filter(c=>c.roomIndex===a&&c.placed);for(const c of r){const d=this.gameEngine.renderer.npcSprites[c.type]||this.gameEngine.renderer.npcSprites.default;this.gameEngine.renderer.drawSprite(t,d,c.x*e,c.y*e,n)}const s=this.gameEngine.getActiveEnemies().filter(c=>c.roomIndex===a),l=this.gameEngine.renderer,o=l.enemySprites||{};for(const c of s){const d=o[c.type]||l.enemySprite;d&&l.drawSprite(t,d,c.x*e,c.y*e,n)}}drawTile(e,t,a,n,i){const r=this.manager.gameEngine.tileManager,s=r.getTile(t);if(!s)return;const l=r.getTilePixels(s);if(!Array.isArray(l))return;const o=Math.max(1,Math.floor(i/8));for(let c=0;c<8;c++)for(let d=0;d<8;d++){const u=l[c]?.[d];!u||u==="transparent"||(e.fillStyle=u,e.fillRect(a+d*o,n+c*o,o,o))}}};typeof window<"u"&&(window.EditorCanvasRenderer=Ot);let Pt=class extends EditorRendererBase{renderTileList(){const e=this.dom.tileList;if(!e)return;const t=this.gameEngine.getTiles(),a=new Map;t.forEach(l=>{const o=l.category||"Diversos";a.has(o)||a.set(o,[]),a.get(o).push(l)});const n=["Terreno","Natureza","Agua","Construcoes","Interior","Decoracao","Objetos","Diversos"],i=Array.from(a.keys()).sort((l,o)=>{const c=n.indexOf(l),d=n.indexOf(o);return c===-1&&d===-1?l.localeCompare(o):c===-1?1:d===-1?-1:c-d}),r=[];i.forEach(l=>{(a.get(l)||[]).forEach(c=>r.push(c))}),e.innerHTML="";const s=document.createElement("div");s.className="tile-grid",r.forEach(l=>{const o=document.createElement("button");o.type="button",o.className="tile-card",o.dataset.tileId=String(l.id),l.id===this.manager.selectedTileId&&o.classList.add("selected");const c=document.createElement("canvas");c.width=64,c.height=64;const d=c.getContext("2d");d&&(d.imageSmoothingEnabled=!1,this.gameEngine.renderer.drawTileOnCanvas(c,l)),o.appendChild(c),s.appendChild(o)}),e.appendChild(s)}updateSelectedTilePreview(){const e=this.dom.selectedTilePreview,t=this.gameEngine.getTiles().find(a=>a.id===this.manager.selectedTileId);!e||!t||(this.gameEngine.renderer.drawTileOnCanvas(e,t),this.dom.tileSummary&&(this.dom.tileSummary.textContent=t.name||this.tf("tiles.summaryFallback",{id:t.id})))}};typeof window<"u"&&(window.EditorTilePanelRenderer=Pt);let Lt=class extends EditorRendererBase{renderNpcs(){const e=this.dom.npcsList;if(!e)return;this.gameEngine.npcManager?.ensureDefaultNPCs?.(),this.updateVariantButtons();const t=this.gameEngine.getGame(),a=this.manager.state.npcVariantFilter||"human",n=(this.gameEngine.npcManager?.getDefinitions?.()??[]).filter(r=>(r.variant||"human")===a),i=this.gameEngine.getSprites();e.innerHTML="",n.forEach(r=>{const s=i.find(h=>h.type===r.type)||null,l=document.createElement("div");l.className="npc-card",l.dataset.type=r.type,l.dataset.id=s?.id||"",r.type===this.manager.selectedNpcType&&l.classList.add("selected"),s?.placed?l.classList.add("npc-card-placed"):l.classList.add("npc-card-available");const o=document.createElement("canvas");o.className="npc-preview",o.width=48,o.height=48,this.drawNpcPreview(o,r);const c=document.createElement("div");c.className="meta";const d=document.createElement("div");d.className="npc-name",d.textContent=this.getNpcName(r);const u=document.createElement("div");if(u.className="npc-position",s?.placed){const h=t.world?.cols||1,g=Math.floor(s.roomIndex/h)+1,p=s.roomIndex%h+1;u.textContent=this.tf("npc.status.position",{col:p,row:g,x:s.x,y:s.y},`Mapa (${p}, ${g}) - (${s.x}, ${s.y})`)}else u.textContent=this.t("npc.status.available");c.append(d,u),l.append(o,c),e.appendChild(l)}),this.updateNpcForm()}drawNpcPreview(e,t){if(!e)return;const a=e.getContext("2d");if(!a)return;a.clearRect(0,0,e.width,e.height),a.imageSmoothingEnabled=!1;const n=this.gameEngine.renderer.npcSprites,i=n[t.type]||n.default,r=e.width/8;for(let s=0;s<i.length;s++)for(let l=0;l<i[s].length;l++){const o=i[s][l];o&&(a.fillStyle=o,a.fillRect(l*r,s*r,r,r))}}updateNpcForm(){const e=this.manager.selectedNpcId,t=this.gameEngine.getSprites().find(p=>p.id===e),{npcEditor:a,npcText:n,npcConditionalText:i,npcConditionalVariable:r,npcRewardVariable:s,npcConditionalRewardVariable:l,btnToggleNpcConditional:o,npcConditionalSection:c}=this.dom,d=!!e,u=!!t;a&&(a.hidden=!d),n&&(n.disabled=!u,n.value=this.getNpcDialogueText(t)),i&&(i.disabled=!u,i.value=t?.conditionText||""),this.manager.npcService.populateVariableSelect(r,t?.conditionVariableId||"",{includeBardSkill:!0}),this.manager.npcService.populateVariableSelect(s,t?.rewardVariableId||""),this.manager.npcService.populateVariableSelect(l,t?.conditionalRewardVariableId||""),r&&(r.disabled=!u),s&&(s.disabled=!u),l&&(l.disabled=!u);const h=this.dom.btnNpcDelete;h&&(h.disabled=!u||!t?.placed);const g=!!this.manager.state.conditionalDialogueExpanded;c&&(c.hidden=!g),o&&(o.textContent=g?this.t("npc.toggle.hide"):this.t("npc.toggle.create"),o.setAttribute("aria-expanded",g?"true":"false"))}getNpcName(e){if(!e)return this.t("npc.defaultName","NPC");const t=e.name||this.t("npc.defaultName","NPC");return e.nameKey?this.t(e.nameKey,t):t}getNpcDialogueText(e){return e?e.textKey?this.t(e.textKey,e.text||""):e.text||"":""}updateVariantButtons(){const e=Array.isArray(this.dom.npcVariantButtons)?this.dom.npcVariantButtons:[];if(!e.length)return;const t=this.manager.state.npcVariantFilter||"human";e.forEach(a=>{const n=a.dataset.npcVariantFilter===t;a.classList.toggle("active",n),a.setAttribute("aria-pressed",n?"true":"false")})}};typeof window<"u"&&(window.EditorNpcRenderer=Lt);let At=class extends EditorRendererBase{renderEnemies(){const e=this.dom.enemiesList;if(!e)return;e.innerHTML="";const t=this.state.activeRoomIndex,a=this.gameEngine.getActiveEnemies().filter(s=>s.roomIndex===t);if(this.renderEnemyOverlay(a,t),!a.length)return;const n=EditorConstants.ENEMY_DEFINITIONS,i=new Map;n.forEach(s=>{i.set(s.type,s),Array.isArray(s.aliases)&&s.aliases.forEach(l=>i.set(l,s))});const r=a.filter(s=>i.get(s.type)?.boss);r.length&&r.forEach(s=>{const l=i.get(s.type),o=document.createElement("div");o.className="enemy-item";const c=document.createElement("span"),d=this.getEnemyDisplayName(l,s.type),u=Number.isFinite(l?.damage)?this.tf("enemies.damageInfo",{value:l.damage}):"";c.textContent=`${d} @ (${s.x}, ${s.y})${u}`;const h=document.createElement("label");h.className="enemy-variable-wrapper",h.textContent=`${this.t("enemies.variableLabel")} `;const g=document.createElement("select");g.className="enemy-variable-select",g.dataset.enemyVariable=s.id,this.manager.npcService.populateVariableSelect(g,s.defeatVariableId||""),h.appendChild(g);const p=document.createElement("button");p.type="button",p.className="enemy-remove",p.dataset.removeEnemy=s.id,p.textContent=this.t("buttons.remove");const f=document.createElement("div");f.className="enemy-controls",f.append(h,p),o.append(c,f),e.appendChild(o)})}renderEnemyCatalog(){const e=this.dom.enemyTypes;if(!e)return;e.innerHTML="";const t=EditorConstants.ENEMY_DEFINITIONS;if(!t.length)return;const a=this.manager.selectedEnemyType;this.renderEnemyCountProgress(e.parentElement||e,e),t.forEach(n=>{const i=document.createElement("div");i.className="enemy-card",i.dataset.type=n.type,n.boss&&i.classList.add("boss"),n.type===a&&i.classList.add("selected");const r=document.createElement("canvas");r.className="enemy-preview",r.width=48,r.height=48,this.drawEnemyPreview(r,n);const s=document.createElement("div");s.className="enemy-meta";const l=document.createElement("div");l.className="enemy-name",l.textContent=this.getEnemyDisplayName(n,n.type);const o=document.createElement("div");o.className="enemy-damage";const c=Number.isFinite(n.damage)?n.damage:"?";if(o.textContent=`Dano: ${c}`,n.boss){const d=document.createElement("span");d.className="enemy-boss-badge",d.textContent="Boss",s.appendChild(d)}s.append(l,o),i.append(r,s),e.appendChild(i)})}drawEnemyPreview(e,t){if(!e)return;const a=e.getContext("2d");if(!a)return;a.clearRect(0,0,e.width,e.height),a.imageSmoothingEnabled=!1;const n=this.gameEngine.renderer;let i=n?.enemySprites?.[t.type]??null;if(!i&&n?.enemySprite&&(i=n.enemySprite),!i&&Array.isArray(t.sprite)&&n?.spriteFactory?.mapPixels){const s=n.paletteManager?.getPicoPalette?.()||RendererConstants.DEFAULT_PALETTE;i=n.spriteFactory.mapPixels(t.sprite,s)}if(!Array.isArray(i))return;const r=e.width/8;for(let s=0;s<i.length;s++){const l=i[s];if(Array.isArray(l))for(let o=0;o<l.length;o++){const c=l[o];c&&(a.fillStyle=c,a.fillRect(o*r,s*r,r,r))}}}getEnemyDisplayName(e,t=""){const a=this.t("enemy.defaultName","Inimigo"),n=e?.name||t||a;return(e?.nameKey?this.t(e.nameKey,n):n).replace(/[^\w\s\u00C0-\u024F'()-]/g," ").replace(/\s+/g," ").trim()||t||a}renderEnemyCountProgress(e,t=null){if(!e)return;e.querySelector(".enemy-xp-block")?.remove();const{currentCount:a,totalCount:n,ratio:i}=this.getEnemyCountProgress(),r=document.createElement("div");r.className="enemy-xp-block";const s=document.createElement("div");s.className="enemy-xp-header";const l=document.createElement("div");l.className="enemy-xp-label",l.textContent=this.t("enemies.xpBarLabel","Inimigos colocados");const o=document.createElement("div");o.className="enemy-xp-value";const c=this.tf("enemies.xpBarValue",{current:a,total:n},`${a} / ${n} inimigos`);o.textContent=c,s.append(l,o);const d=document.createElement("div");d.className="enemy-xp-track";const u=document.createElement("div");u.className="enemy-xp-fill",u.style.width=`${Math.round(i*100)}%`,d.appendChild(u),r.append(s,d),t&&t.parentElement===e?e.insertBefore(r,t):e.appendChild(r)}getEnemyCountProgress(){const t=(this.gameEngine?.getActiveEnemies?.()??[]).length,a=this.gameEngine&&(this.gameEngine.getGame?.()||this.gameEngine.gameState?.getGame?.())||{},n=Number(a?.world?.rows)||3,i=Number(a?.world?.cols)||3,l=Math.max(1,n*i)*6,o=Math.max(0,Math.min(1,l>0?t/l:0));return{currentCount:t,totalCount:l,ratio:o}}renderEnemyOverlay(e,t){const a=this.dom.editorCanvas;if(!a)return;const n=a.parentElement;if(!n)return;const i=Array.isArray(e)?e.filter(u=>u.roomIndex===t):[];let r=n.querySelector(".enemy-overlay");if(!i.length){r&&(r.innerHTML="",r.remove());return}r||(r=document.createElement("div"),r.className="enemy-overlay",n.appendChild(r));const s=this.gameEngine?.gameState?.worldManager?.roomSize||8,l=a.offsetWidth||a.clientWidth||a.width||1,o=a.offsetHeight||a.clientHeight||a.height||1,c=l/s,d=o/s;r.style.width=`${l}px`,r.style.height=`${o}px`,r.style.left=`${a.offsetLeft}px`,r.style.top=`${a.offsetTop}px`,r.innerHTML="",i.forEach(u=>{const h=document.createElement("button");h.type="button",h.className="enemy-overlay-remove",h.textContent="âœ•",h.style.left=`${(u.x+1)*c}px`,h.style.top=`${u.y*d}px`,h.addEventListener("click",g=>{g.stopPropagation(),this.manager.enemyService.removeEnemy(u.id)}),r.appendChild(h)})}};typeof window<"u"&&(window.EditorEnemyRenderer=At);const _=window.ObjectTypes||{},Dt=_.PLAYER_END,kt=_.DOOR_VARIABLE;let jt=class extends EditorRendererBase{renderObjectCatalog(){const e=this.dom.objectTypes;if(!e)return;e.innerHTML="";const t=EditorConstants.OBJECT_DEFINITIONS;if(!Array.isArray(t)||!t.length)return;const a=this.manager.selectedObjectType,n=this.gameEngine.getObjectsForRoom(this.state.activeRoomIndex)||[],i=new Set(n.map(r=>r.type));t.forEach(r=>{const s=document.createElement("div");s.className="object-type-card",s.dataset.type=r.type,r.type===a&&s.classList.add("selected"),i.has(r.type)&&s.classList.add("placed");const l=document.createElement("canvas");l.width=48,l.height=48,l.className="object-type-preview",this.drawObjectPreview(l,r.type);const o=document.createElement("div");o.className="object-type-meta";const c=document.createElement("div");c.className="object-type-name",c.textContent=this.getObjectLabel(r.type,t);const d=document.createElement("div");d.className="object-type-info",d.textContent=i.has(r.type)?this.t("objects.info.placed"):this.t("objects.info.available"),o.append(c,d),s.append(l,o),e.appendChild(s)})}renderObjects(){const e=this.dom.objectsList;if(!e)return;e.innerHTML="";const t=this.gameEngine.getObjectsForRoom(this.state.activeRoomIndex),a=this.gameEngine.getRuntimeVariables?.()??[];new Map(a.map(i=>[i.id,i.value]));const n=EditorConstants.OBJECT_DEFINITIONS;t.forEach(i=>{const r=document.createElement("div");r.className="object-card",r.dataset.type=i.type,r.dataset.roomIndex=String(i.roomIndex);const s=document.createElement("canvas");s.className="object-preview",s.width=48,s.height=48,this.drawObjectPreview(s,i.type);const l=document.createElement("div");l.className="object-body";const o=document.createElement("div");o.className="object-header";const c=document.createElement("h4");c.className="object-name",c.textContent=this.getObjectLabel(i.type,n),o.appendChild(c);const d=document.createElement("span");if(d.className="object-position",d.textContent=`(${i.x}, ${i.y})`,o.appendChild(d),l.appendChild(o),i.type===_.SWITCH||i.type===kt){const h=document.createElement("div");h.className="object-config";const g=document.createElement("label");g.className="object-config-label";const p=document.createElement("select");p.className="object-config-select",this.manager.npcService.populateVariableSelect(p,i.variableId||""),p.addEventListener("change",()=>{this.gameEngine.setObjectVariable(i.type,i.roomIndex,p.value),this.renderObjects(),this.service.worldRenderer.renderWorldGrid(),this.manager.updateJSON(),this.manager.history.pushCurrentState()}),g.append(`${this.t("objects.switch.variableLabel")} `,p),h.appendChild(g);const f=document.createElement("div");f.className="object-status";const y=i.type===_.SWITCH?!!i.on:!!this.gameEngine.isVariableOn?.(i.variableId);f.textContent=this.tf("objects.switch.stateLabel",{state:y?this.t("objects.state.on"):this.t("objects.state.off")}),h.appendChild(f),l.appendChild(h)}if(i.type===_.DOOR&&i.opened){const h=document.createElement("div");h.className="object-status",h.textContent=this.t("objects.status.doorOpened"),l.appendChild(h)}if(i.type===_.KEY&&i.collected){const h=document.createElement("div");h.className="object-status",h.textContent=this.t("objects.status.keyCollected"),l.appendChild(h)}if(i.type===_.LIFE_POTION&&i.collected){const h=document.createElement("div");h.className="object-status",h.textContent=this.t("objects.status.potionCollected"),l.appendChild(h)}if(i.type===_.XP_SCROLL&&i.collected){const h=document.createElement("div");h.className="object-status",h.textContent=this.t("objects.status.scrollUsed"),l.appendChild(h)}if((i.type===_.SWORD||i.type===_.SWORD_BRONZE||i.type===_.SWORD_WOOD)&&i.collected){const h=document.createElement("div");h.className="object-status",h.textContent=this.t("objects.status.swordBroken"),l.appendChild(h)}const u=i.type===Dt;if(u){const h=document.createElement("div");h.className="object-config";const g=document.createElement("label");g.className="object-config-label",g.textContent=this.t("objects.end.textLabel");const p=document.createElement("textarea");p.className="object-config-textarea",p.rows=4;const f=typeof StateObjectManager?.PLAYER_END_TEXT_LIMIT=="number"?StateObjectManager.PLAYER_END_TEXT_LIMIT:40;p.maxLength=f,p.placeholder=this.t("objects.end.placeholder"),p.value=i.endingText||"",p.addEventListener("input",()=>{this.manager.objectService?.updatePlayerEndText?.(i.roomIndex,p.value)}),g.appendChild(p),h.appendChild(g);const y=document.createElement("div");y.className="object-config-hint",y.textContent=this.tf("objects.end.hint",{max:f}),h.appendChild(y),l.appendChild(h)}if(u){const h=document.createElement("div");h.className="object-status",h.textContent=this.t("objects.status.gameEnd"),l.appendChild(h)}if(i.type!==_.PLAYER_START){const h=document.createElement("button");h.type="button",h.className="object-remove",h.dataset.type=i.type,h.dataset.roomIndex=String(i.roomIndex),h.textContent=this.t("buttons.remove"),l.appendChild(h)}else{const h=document.createElement("div");h.className="object-status",h.textContent=this.t("objects.status.startMarker"),l.appendChild(h)}r.append(s,l),e.appendChild(r)})}drawObjectPreview(e,t){if(!e)return;const a=e.getContext("2d");if(!a)return;a.clearRect(0,0,e.width,e.height),a.imageSmoothingEnabled=!1,a.fillStyle="#111827",a.fillRect(0,0,e.width,e.height);const n=this.gameEngine.renderer;if(!n?.drawObjectSprite)return;const i=e.width/8;n.drawObjectSprite(a,t,0,0,i)}getObjectLabel(e,t){const a=t.find(n=>n.type===e);if(a?.nameKey)return this.t(a.nameKey,a?.name||e);if(a?.name)return a.name;switch(e){case _.DOOR:return this.t("objects.label.door");case _.DOOR_VARIABLE:return this.t("objects.label.doorVariable");case _.PLAYER_START:return this.t("objects.label.playerStart");case _.PLAYER_END:return this.t("objects.label.playerEnd");case _.SWITCH:return this.t("objects.label.switch");case _.KEY:return this.t("objects.label.key");case _.LIFE_POTION:return this.t("objects.label.lifePotion");case _.SWORD:return this.t("objects.label.sword");case _.SWORD_BRONZE:return this.t("objects.label.swordBronze");case _.SWORD_WOOD:return this.t("objects.label.swordWood");case _.XP_SCROLL:return this.t("objects.label.xpScroll");default:return e}}};typeof window<"u"&&(window.EditorObjectRenderer=jt);let Ft=class extends EditorRendererBase{renderWorldGrid(){const e=this.dom.worldGrid;if(!e)return;const t=this.gameEngine.getGame(),a=t.world?.rows||1,n=t.world?.cols||1,i=t.start?.roomIndex??0;e.innerHTML="",e.style.setProperty("--world-cols",n);for(let r=0;r<a;r++)for(let s=0;s<n;s++){const l=r*n+s,o=document.createElement("button");o.type="button",o.className="world-cell",o.dataset.roomIndex=String(l),l===this.state.activeRoomIndex&&o.classList.add("active");const c=document.createElement("span");c.className="world-cell-label",c.textContent=`${s+1},${r+1}`,o.appendChild(c);const d=document.createElement("div");if(d.className="world-cell-badges",l===i){const u=document.createElement("span");u.classList.add("world-cell-badge","badge-start"),u.textContent=this.t("world.badge.start"),d.appendChild(u),o.classList.add("start")}d.children.length&&o.appendChild(d),o.title=this.tf("world.cell.title",{col:s+1,row:r+1}),e.appendChild(o)}this.renderMapNavigation()}renderMapNavigation(){const e=Array.isArray(this.dom.mapNavButtons)?this.dom.mapNavButtons:[],t=this.gameEngine.getGame(),a=Math.max(1,Number(t.world?.rows)||1),n=Math.max(1,Number(t.world?.cols)||1),r=Math.max(1,t.rooms?.length||a*n)-1,s=Math.max(0,Math.min(r,this.state.activeRoomIndex??0)),l=Math.floor(s/n),o=s%n;if(this.updateMapPosition(o+1,l+1),!e.length)return;const c=(d,u)=>{const h=l+d,g=o+u;if(h<0||h>=a||g<0||g>=n)return!1;const p=h*n+g;return p>=0&&p<=r};e.forEach(d=>{const u=d.dataset.direction;let h=!1;switch(u){case"up":h=c(-1,0);break;case"down":h=c(1,0);break;case"left":h=c(0,-1);break;case"right":h=c(0,1);break;default:h=!1}d.disabled=!h})}renderGameMinimap(e=null,t=null){const a=this.dom.mapPosition;if(a){a.innerHTML="";for(let n=1;n<=3;n++)for(let i=1;i<=3;i++){const r=document.createElement("div");r.className="game-minimap-cell",r.dataset.mmRow=String(n),r.dataset.mmCol=String(i),n===t&&i===e?r.classList.add("game-minimap-cell-active"):r.classList.add("game-minimap-cell"),a.appendChild(r)}}}updateMapPosition(e,t){if(this.dom.mapPosition)try{this.renderGameMinimap(e,t)}catch{}}};typeof window<"u"&&(window.EditorWorldRenderer=Ft);let Vt=class{constructor(e){this.manager=e,this.canvasRenderer=new EditorCanvasRenderer(this),this.tilePanelRenderer=new EditorTilePanelRenderer(this),this.npcRenderer=new EditorNpcRenderer(this),this.enemyRenderer=new EditorEnemyRenderer(this),this.worldRenderer=new EditorWorldRenderer(this),this.objectRenderer=new EditorObjectRenderer(this),this.handleTileAnimationFrame=()=>{this.renderEditor(),this.updateSelectedTilePreview()},typeof window<"u"&&window.addEventListener&&window.addEventListener("tile-animation-frame",this.handleTileAnimationFrame)}get textResources(){return typeof TextResources<"u"?TextResources:null}t(e,t=""){const n=this.textResources?.get?.(e,t);return n||t||e||""}tf(e,t={},a=""){const n=this.textResources;if(n?.format)return n.format(e,t,a);const i=this.t(e,a);return i?i.replace(/\{(\w+)\}/g,(r,s)=>t[s]??""):""}get dom(){return this.manager.domCache}get gameEngine(){return this.manager.gameEngine}get state(){return this.manager.state}get picoPalette(){return typeof TileDefinitions<"u"&&TileDefinitions?.PICO8_COLORS?TileDefinitions.PICO8_COLORS:typeof window<"u"&&window.PICO8_COLORS?window.PICO8_COLORS:[]}resolvePicoColor(e){const t=this.picoPalette;if(!t.length)return e||"#000000";if(Number.isInteger(e))return t[e]??t[0];if(typeof e!="string")return t[0];const a=r=>String(r||"").replace("#","").trim().toUpperCase(),n=a(e),i=t.findIndex(r=>a(r)===n);return i!==-1?t[i]:t[0]}renderEditor(){this.canvasRenderer.renderEditor(),this.worldRenderer.renderMapNavigation()}renderTileList(){this.tilePanelRenderer.renderTileList()}renderNpcs(){this.npcRenderer.renderNpcs()}updateNpcForm(){this.npcRenderer.updateNpcForm()}renderEnemies(){this.enemyRenderer.renderEnemies()}renderEnemyCatalog(){this.enemyRenderer.renderEnemyCatalog()}renderObjectCatalog(){this.objectRenderer.renderObjectCatalog()}renderObjects(){this.objectRenderer.renderObjects()}renderWorldGrid(){this.worldRenderer.renderWorldGrid()}renderMapNavigation(){this.worldRenderer.renderMapNavigation()}updateMapPosition(e,t){this.worldRenderer.updateMapPosition(e,t)}updateSelectedTilePreview(){this.tilePanelRenderer.updateSelectedTilePreview()}renderVariableUsage(){const e=this.dom.projectVariableList;if(!e)return;const t=this.dom.projectVariablesContainer,a=this.dom.projectVariablesToggle;e.innerHTML="";const n=this.gameEngine?.getVariableDefinitions?.()??[],i=this.collectVariableUsage(),r=n.reduce((o,c)=>o+(i.has(c.id)?1:0),0),s=this.tf("project.variables.usage",{used:r,total:n.length},`${r}/${n.length}`),l=!!this.state.variablePanelCollapsed;if(a){const o=l?this.t("project.variables.toggle.show","Mostrar variÃ¡veis"):this.t("project.variables.toggle.hide","Esconder variÃ¡veis");a.textContent=`${s} Â· ${o}`}if(t&&t.classList.toggle("is-collapsed",l),!n.length){const o=document.createElement("div");o.className="project-variable-item";const c=document.createElement("span");c.className="project-variable-name",c.textContent=this.t("variables.none","Nenhuma"),o.appendChild(c),e.appendChild(o);return}n.forEach(o=>{const c=document.createElement("div");c.className="project-variable-item";const d=document.createElement("span");d.className="project-variable-color",d.style.background=this.resolvePicoColor(o.color);const u=document.createElement("span");u.className="project-variable-name",u.textContent=o.name||o.id;const h=document.createElement("span"),g=i.has(o.id);h.className=`project-variable-badge ${g?"in-use":"unused"}`,h.textContent=g?this.t("project.variables.used","Em uso"):this.t("project.variables.unused","Sem uso"),c.append(d,u,h),e.appendChild(c)})}renderSkillList(){const e=this.dom.projectSkillsList;if(!e)return;const t=this.dom.projectSkillsContainer,a=this.dom.projectSkillsToggle;e.innerHTML="";const n=typeof SkillDefinitions<"u"?SkillDefinitions.getAll?.()||[]:[],i=this.buildSkillLevelMap(),r=this.groupSkillsByLevel(n,i),s=!!this.state.skillPanelCollapsed;if(a){const l=s?this.t("project.skills.toggle.show","Mostrar skills"):this.t("project.skills.toggle.hide","Esconder skills"),o=this.t("project.skills.title","Skills do jogo");a.textContent=`${o} Â· ${l}`}if(t&&t.classList.toggle("is-collapsed",s),!s){if(!n.length){const l=document.createElement("div");l.className="project-skill-item";const o=document.createElement("span");o.className="project-skill-name",o.textContent=this.t("variables.none","Nenhuma"),l.appendChild(o),e.appendChild(l);return}r.forEach(({level:l,items:o})=>{const c=document.createElement("div");c.className="project-skill-group";const d=document.createElement("div");d.className="project-skill-group-title";const u=Number.isFinite(l)?this.tf("project.skills.level",{value:l},`NÃ­vel ${l}`):this.t("project.skills.level","NÃ­vel -");d.textContent=u,c.appendChild(d),o.forEach(h=>{const g=document.createElement("div");g.className="project-skill-item";const p=document.createElement("span");p.className="project-skill-icon",p.textContent=h.icon||"âœ¨";const f=document.createElement("div");f.className="project-skill-name";const y=h.nameKey?this.t(h.nameKey,h.name||h.id||""):h.name||h.id||"";f.textContent=y||h.id||"";const T=document.createElement("div");T.className="project-skill-desc";const b=h.descriptionKey?this.t(h.descriptionKey,h.description||""):h.description||"";T.textContent=b,g.append(p,f,T),c.appendChild(g)}),e.appendChild(c)})}}collectVariableUsage(){const e=new Set,t=this.gameEngine?.getGame?.()||{},a=this.gameEngine?.getVariableDefinitions?.()??[],n=new Set(a.map(o=>o.id)),i=o=>{if(typeof o!="string")return;const c=o.trim();c&&n.has(c)&&e.add(c)};return(Array.isArray(t.sprites)?t.sprites:[]).forEach(o=>{[o.conditionVariableId,o.conditionalVariableId,o.rewardVariableId,o.activateVariableId,o.onCompleteVariableId,o.conditionalRewardVariableId,o.alternativeRewardVariableId].forEach(i)}),(Array.isArray(t.enemies)?t.enemies:[]).forEach(o=>i(o.defeatVariableId)),(Array.isArray(t.objects)?t.objects:[]).forEach(o=>i(o.variableId)),e}buildSkillLevelMap(){const e=new Map,t=typeof SkillDefinitions<"u"?SkillDefinitions.LEVEL_SKILLS||{}:{};return Object.entries(t).forEach(([a,n])=>{const i=Number(a);Number.isFinite(i)&&(Array.isArray(n)?n:[]).forEach(r=>{typeof r=="string"&&(!e.has(r)||i<e.get(r))&&e.set(r,i)})}),e}groupSkillsByLevel(e,t){const a=new Map;return e.forEach(i=>{const r=t.get(i.id)??null,s=Number.isFinite(r)?r:"other";a.has(s)||a.set(s,[]),a.get(s).push(i)}),Array.from(a.keys()).sort((i,r)=>{const s=Number.isFinite(i)?i:1/0,l=Number.isFinite(r)?r:1/0;return s-l}).map(i=>({level:Number.isFinite(i)?i:null,items:a.get(i)||[]}))}renderTestTools(){const e=this.dom.projectTestContainer,t=this.dom.projectTestToggle,a=this.dom.projectTestPanel,n=this.dom.projectTestStartLevel,i=this.dom.projectTestSkillList,r=this.dom.projectTestGodMode;if(!e||!t||!a)return;const s=!!this.state.testPanelCollapsed,l=this.t("project.test.title","Ajuda nos testes"),o=s?this.t("project.test.toggle.show","Mostrar"):this.t("project.test.toggle.hide","Esconder");t.textContent=`${l} Â· ${o}`,e.classList.toggle("is-collapsed",s);const c=this.gameEngine?.getTestSettings?.()||{startLevel:1,skills:[],godMode:!1},d=this.gameEngine?.getMaxPlayerLevel?.()??1,u=e.querySelector(".project-test__hint");if(u&&(u.textContent=this.t("project.test.hint","Apenas para testar: estas opÃ§Ãµes nÃ£o vÃ£o para a URL.")),n){n.innerHTML="";for(let h=1;h<=d;h++){const g=document.createElement("option");g.value=String(h),g.textContent=this.tf("project.test.levelOption",{value:h},`NÃ­vel ${h}`),h===c.startLevel&&(g.selected=!0),n.appendChild(g)}}if(r&&(r.checked=!!c.godMode),i){i.innerHTML="";const h=typeof SkillDefinitions<"u"?SkillDefinitions.getAll?.()||[]:[],g=new Set(Array.isArray(c.skills)?c.skills:[]);if(!h.length){const p=document.createElement("div");p.className="project-test__skill",p.textContent=this.t("variables.none","Nenhuma"),i.appendChild(p);return}h.forEach(p=>{const f=document.createElement("label");f.className="project-test__skill";const y=document.createElement("input");y.type="checkbox",y.dataset.skillId=p.id,y.checked=g.has(p.id);const T=document.createElement("div");T.className="project-test__skill-label";const b=document.createElement("span");b.className="project-test__skill-icon",b.textContent=p.icon||"âœ¨";const x=document.createElement("span");x.textContent=p.nameKey?this.t(p.nameKey,p.name||p.id||""):p.name||p.id||"",T.append(b,x),f.append(y,T),i.appendChild(f)})}}};typeof window<"u"&&(window.EditorRenderService=Vt);let Bt=class{constructor(e){this.manager=e}get dom(){return this.manager.domCache}get state(){return this.manager.state}startPaint(e){const t=this.dom.editorCanvas;t&&(e.preventDefault(),this.state.mapPainting=!0,e.pointerId!==void 0&&t.setPointerCapture&&t.setPointerCapture(e.pointerId),this.applyPaint(e))}continuePaint(e){this.state.mapPainting&&this.applyPaint(e)}finishPaint(e){if(!this.state.mapPainting)return;this.state.mapPainting=!1;const t=this.dom.editorCanvas;if(e?.pointerId!==void 0&&t?.hasPointerCapture?.(e.pointerId)&&t.releasePointerCapture(e.pointerId),this.state.skipMapHistory){this.state.skipMapHistory=!1;return}this.manager.renderService.renderEditor(),this.manager.gameEngine.draw(),this.manager.updateJSON(),this.manager.history.pushCurrentState()}applyPaint(e){const t=this.getTileFromEvent(e);if(!t)return;const a=this.state.activeRoomIndex;if(this.state.placingNpc){this.manager.npcService.placeNpcAt(t),this.state.skipMapHistory=!0;return}if(this.state.placingEnemy){this.manager.enemyService.placeEnemyAt(t),this.state.skipMapHistory=!0;return}if(this.state.placingObjectType){this.manager.objectService.placeObjectAt(this.state.placingObjectType,t,a),this.state.skipMapHistory=!0;return}this.state.selectedTileId===null||this.state.selectedTileId===void 0||(this.manager.gameEngine.setMapTile(t.x,t.y,this.state.selectedTileId,a),this.manager.renderService.renderEditor(),this.manager.gameEngine.draw())}clearSelection({render:e=!0}={}){return this.state.selectedTileId!==null&&this.state.selectedTileId!==void 0?(this.state.selectedTileId=null,e&&(this.manager.renderService.renderTileList(),this.manager.renderService.updateSelectedTilePreview()),!0):!1}getTileFromEvent(e){const t=this.dom.editorCanvas;if(!t)return null;const a=t.getBoundingClientRect();if(!a.width||!a.height)return null;const n=(e.clientX-a.left)/a.width,i=(e.clientY-a.top)/a.height;return n<0||n>1||i<0||i>1?null:{x:Math.min(7,Math.floor(n*8)),y:Math.min(7,Math.floor(i*8))}}};typeof window<"u"&&(window.EditorTileService=Bt);let _t=class{constructor(e){this.manager=e}get text(){return typeof TextResources<"u"?TextResources:null}t(e,t=""){const n=this.text?.get?.(e,t);return n||t||e||""}get gameEngine(){return this.manager.gameEngine}get dom(){return this.manager.domCache}get state(){return this.manager.state}addNpc(){this.gameEngine.npcManager?.ensureDefaultNPCs?.();const e=this.gameEngine.getSprites(),a=(this.gameEngine.npcManager?.getDefinitions?.()??[]).map(i=>({def:i,npc:e.find(r=>r.type===i.type)||null})).find(i=>!i.npc?.placed);if(!a){alert(this.t("alerts.npc.full"));return}const n=a.npc;if(n)this.state.selectedNpcId=n.id,this.state.selectedNpcType=n.type;else{const i=this.gameEngine.npcManager?.createNPC?.(a.def.type);if(!i){alert(this.t("alerts.npc.createError"));return}this.state.selectedNpcId=i.id,this.state.selectedNpcType=i.type}this.activatePlacement(),this.manager.renderService.renderNpcs(),this.manager.renderService.renderWorldGrid(),this.manager.renderService.renderEditor(),this.manager.gameEngine.draw(),this.manager.updateJSON(),this.manager.history.pushCurrentState()}activatePlacement(){if(!this.state.selectedNpcId){alert(this.t("alerts.npc.selectFirst"));return}this.state.placingNpc||(this.manager.enemyService?.deactivatePlacement(),this.state.placingObjectType&&this.manager.objectService?.togglePlacement?.(this.state.placingObjectType,!0),this.state.placingNpc=!0,this.state.placingEnemy=!1,this.state.placingObjectType=null,this.dom.editorCanvas&&(this.dom.editorCanvas.style.cursor="crosshair"))}deactivatePlacement(){this.state.placingNpc&&(this.state.placingNpc=!1,!this.state.placingEnemy&&!this.state.placingObjectType&&this.dom.editorCanvas&&(this.dom.editorCanvas.style.cursor="default"))}clearSelection({render:e=!0}={}){const t=!!(this.state.selectedNpcId||this.state.selectedNpcType||this.state.placingNpc);return this.state.selectedNpcId=null,this.state.selectedNpcType=null,this.state.conditionalDialogueExpanded=!1,this.deactivatePlacement(),e&&t&&this.manager.renderService.renderNpcs(),t}removeSelectedNpc(){!this.state.selectedNpcId||!this.gameEngine.npcManager?.removeNPC?.(this.state.selectedNpcId)||(this.clearSelection({render:!1}),this.manager.renderService.renderNpcs(),this.manager.renderService.renderWorldGrid(),this.manager.renderService.renderEditor(),this.manager.gameEngine.draw(),this.manager.updateJSON(),this.manager.history.pushCurrentState())}updateNpcSelection(e,t){if(!t){this.clearSelection();return}this.state.selectedNpcType=e,this.state.selectedNpcId=t;const a=this.gameEngine.getSprites().find(i=>i.id===t)||null,n=!!(a?.conditionText||a?.conditionVariableId||a?.conditionalRewardVariableId);this.state.conditionalDialogueExpanded=n,this.manager.renderService.renderNpcs(),this.activatePlacement()}placeNpcAt(e){if(!this.state.selectedNpcId){alert(this.t("alerts.npc.selectFirst")),this.deactivatePlacement();return}const t=this.state.activeRoomIndex;if(!this.gameEngine.npcManager?.setNPCPosition?.(this.state.selectedNpcId,e.x,e.y,t)){alert(this.t("alerts.npc.placeError"));return}this.manager.renderService.renderNpcs(),this.manager.renderService.renderWorldGrid(),this.manager.renderService.renderEditor(),this.manager.gameEngine.draw(),this.manager.updateJSON(),this.manager.history.pushCurrentState()}populateVariableSelect(e,t="",a={}){if(!e)return;const n=this.gameEngine.getVariableDefinitions(),i=!!a.includeBardSkill;e.innerHTML="";const r=document.createElement("option");if(r.value="",r.textContent=this.t("variables.none"),e.appendChild(r),i){const s=document.createElement("option");s.value="skill:bard",s.textContent=this.t("variables.skill.bard"),e.appendChild(s)}n.forEach(s=>{const l=document.createElement("option");l.value=s.id,l.textContent=s.name||s.id,e.appendChild(l)}),e.value=t||""}updateNpcText(e){if(!this.state.selectedNpcId)return;const t=this.gameEngine.getSprites().find(a=>a.id===this.state.selectedNpcId);t&&(t.text=e,t.textKey=null,this.manager.renderService.renderNpcs(),this.manager.updateJSON(),this.scheduleNpcTextUpdate())}updateNpcConditionalText(e){if(!this.state.selectedNpcId)return;const t=this.gameEngine.getSprites().find(a=>a.id===this.state.selectedNpcId);t&&(t.conditionText=e,this.manager.renderService.renderNpcs(),this.manager.updateJSON(),this.scheduleNpcTextUpdate())}scheduleNpcTextUpdate(){this.state.npcTextUpdateTimer&&clearTimeout(this.state.npcTextUpdateTimer),this.state.npcTextUpdateTimer=setTimeout(()=>{this.manager.history.pushCurrentState()},400)}handleConditionVariableChange(e){if(!this.state.selectedNpcId)return;const t=this.gameEngine.getSprites().find(a=>a.id===this.state.selectedNpcId);t&&(t.conditionVariableId=e||null,this.manager.renderService.renderNpcs(),this.manager.renderService.renderWorldGrid(),this.manager.updateJSON(),this.manager.history.pushCurrentState())}handleRewardVariableChange(e){if(!this.state.selectedNpcId)return;const t=this.gameEngine.getSprites().find(a=>a.id===this.state.selectedNpcId);t&&(t.rewardVariableId=e||null,this.manager.renderService.renderNpcs(),this.manager.renderService.renderWorldGrid(),this.manager.updateJSON(),this.manager.history.pushCurrentState())}handleConditionalRewardVariableChange(e){if(!this.state.selectedNpcId)return;const t=this.gameEngine.getSprites().find(a=>a.id===this.state.selectedNpcId);t&&(t.conditionalRewardVariableId=e||null,this.manager.renderService.renderNpcs(),this.manager.renderService.renderWorldGrid(),this.manager.updateJSON(),this.manager.history.pushCurrentState())}setVariantFilter(e){const a=["human","elf","dwarf","fixed"].includes(e)?e:"human";this.state.npcVariantFilter!==a&&(this.clearSelection({render:!1}),this.state.npcVariantFilter=a,this.manager.renderService.renderNpcs())}};typeof window<"u"&&(window.EditorNpcService=_t);let Gt=class{constructor(e){this.manager=e,this.editorIndicator=null,this.editorIndicatorTimeout=null}get dom(){return this.manager.domCache}get state(){return this.manager.state}get gameEngine(){return this.manager.gameEngine}activatePlacement(){this.getEnemyDefinition(this.manager.selectedEnemyType)&&(this.state.placingEnemy||(this.manager.npcService?.clearSelection?.(),this.state.placingObjectType&&this.manager.objectService?.togglePlacement?.(this.state.placingObjectType,!0),this.state.placingEnemy=!0,this.state.placingNpc=!1,this.state.placingObjectType=null,this.dom.editorCanvas&&(this.dom.editorCanvas.style.cursor="crosshair")))}deactivatePlacement(){this.state.placingEnemy&&(this.state.placingEnemy=!1,!this.state.placingNpc&&!this.state.placingObjectType&&this.dom.editorCanvas&&(this.dom.editorCanvas.style.cursor="default"))}placeEnemyAt(e){const t=this.state.activeRoomIndex;if((this.gameEngine.getEnemyDefinitions?.()??[]).find(c=>c.roomIndex===t&&c.x===e.x&&c.y===e.y))return;if((this.gameEngine.getActiveEnemies?.()??[]).reduce((c,d)=>d.roomIndex===t?c+1:c,0)>=6){this.showEnemyLimitFeedback();return}const r=this.getEnemyDefinition(this.state.selectedEnemyType),s=EditorConstants.ENEMY_DEFINITIONS[0]?.type||"giant-rat",l=r?.type||s;this.gameEngine.addEnemy({x:e.x,y:e.y,roomIndex:t,type:l})&&(this.manager.renderService.renderEnemies(),this.manager.renderService.renderEnemyCatalog(),this.manager.renderService.renderWorldGrid(),this.manager.renderService.renderEditor(),this.manager.gameEngine.draw(),this.manager.updateJSON(),this.manager.history.pushCurrentState())}removeEnemy(e){this.gameEngine.removeEnemy(e),this.manager.renderService.renderEnemies(),this.manager.renderService.renderEnemyCatalog(),this.manager.renderService.renderWorldGrid(),this.manager.renderService.renderEditor(),this.manager.gameEngine.draw(),this.manager.updateJSON(),this.manager.history.pushCurrentState()}handleEnemyVariableChange(e,t){const a=typeof t=="string"&&t.trim().length?t:null;this.gameEngine.setEnemyVariable(e,a)&&(this.manager.renderService.renderEnemies(),this.manager.renderService.renderWorldGrid(),this.manager.updateJSON(),this.manager.history.pushCurrentState())}selectEnemyType(e){const t=this.getEnemyDefinition(e);t&&(this.state.selectedEnemyType!==t.type&&(this.manager.selectedEnemyType=t.type,this.manager.renderEnemyCatalog()),this.activatePlacement())}clearSelection({render:e=!0}={}){return!(this.manager.selectedEnemyType||this.state.placingEnemy)?!1:(this.manager.selectedEnemyType=null,this.deactivatePlacement(),e&&this.manager.renderEnemyCatalog(),!0)}getEditorIndicator(){if(this.editorIndicator)return this.editorIndicator;const e=document?.querySelector?.(".editor-map-wrapper");if(!e)return null;const t=document.createElement("div");return t.className="combat-indicator",t.setAttribute("aria-live","polite"),t.setAttribute("aria-atomic","true"),e.appendChild(t),this.editorIndicator=t,t}showEnemyLimitFeedback(){const e=this.getEditorIndicator();if(this.editorIndicatorTimeout&&(clearTimeout(this.editorIndicatorTimeout),this.editorIndicatorTimeout=null),e){e.textContent=this.getEnemyLimitMessage(),e.classList.remove("visible"),e.setAttribute("data-visible","false"),e.offsetWidth,e.classList.add("visible"),e.setAttribute("data-visible","true"),this.editorIndicatorTimeout=setTimeout(()=>{e.classList.remove("visible"),e.setAttribute("data-visible","false"),e.textContent="",this.editorIndicatorTimeout=null},700);return}this.gameEngine?.renderer?.showCombatIndicator?.(this.getEnemyLimitMessage(),{duration:700})}getEnemyLimitMessage(){const e=TextResources?.get?.("enemies.limitReached","")?.trim?.();return e||"Max enemies reached"}getEnemyDefinition(e=null){const t=typeof e=="string"&&e.length>0?e:this.state.selectedEnemyType,a=EnemyDefinitions.getEnemyDefinition(t);if(a)return a;const n=EditorConstants.ENEMY_DEFINITIONS;return n.find(i=>i.type===t)||n.find(i=>Array.isArray(i.aliases)&&i.aliases.includes(t))||null}};typeof window<"u"&&(window.EditorEnemyService=Gt);let Ut=class{constructor(e){this.manager=e}get dom(){return this.manager.domCache}get state(){return this.manager.state}get gameEngine(){return this.manager.gameEngine}togglePlacement(e,t=!1){const a=this.normalizeType(e??this.state.placingObjectType??this.manager.selectedObjectType);if(t){if(!this.state.placingObjectType)return;this.state.placingObjectType=null,!this.state.placingNpc&&!this.state.placingEnemy&&this.dom.editorCanvas&&(this.dom.editorCanvas.style.cursor="default"),this.manager.renderObjectCatalog();return}if(a){if(this.state.placingObjectType===a){this.state.placingObjectType=null,!this.state.placingNpc&&!this.state.placingEnemy&&this.dom.editorCanvas&&(this.dom.editorCanvas.style.cursor="default"),this.manager.renderObjectCatalog();return}this.selectObjectType(a)}}updatePlacementButtons(){this.manager.renderObjectCatalog()}placeObjectAt(e,t,a){this.gameEngine.setObjectPosition(e,a,t.x,t.y)&&(this.manager.renderService.renderObjects(),this.manager.renderObjectCatalog(),this.manager.renderService.renderWorldGrid(),this.manager.renderService.renderEditor(),this.manager.gameEngine.draw(),this.manager.updateJSON(),this.manager.history.pushCurrentState())}removeObject(e,t){this.state.placingObjectType===e&&this.togglePlacement(e,!0),this.gameEngine.removeObject(e,t),this.manager.renderService.renderObjects(),this.manager.renderObjectCatalog(),this.manager.renderService.renderWorldGrid(),this.manager.renderService.renderEditor(),this.manager.gameEngine.draw(),this.manager.updateJSON(),this.manager.history.pushCurrentState()}selectObjectType(e){const t=this.normalizeType(e);t&&(this.manager.selectedObjectType!==t&&(this.manager.selectedObjectType=t),this.activatePlacement(t))}activatePlacement(e=null){const t=this.normalizeType(e??this.manager.selectedObjectType);t&&(this.manager.npcService?.clearSelection?.(),this.state.placingEnemy&&this.manager.enemyService.deactivatePlacement(),this.state.placingNpc=!1,this.state.placingObjectType=t,this.manager.selectedObjectType=t,this.dom.editorCanvas&&(this.dom.editorCanvas.style.cursor="crosshair"),this.manager.renderObjectCatalog())}clearSelection({render:e=!0}={}){return!(this.manager.selectedObjectType||this.state.placingObjectType)?!1:(this.state.placingObjectType=null,this.manager.selectedObjectType=null,!this.state.placingNpc&&!this.state.placingEnemy&&this.dom.editorCanvas&&(this.dom.editorCanvas.style.cursor="default"),e&&this.manager.renderObjectCatalog(),!0)}updatePlayerEndText(e,t){this.gameEngine.setPlayerEndText(e,t),this.manager.updateJSON(),this.schedulePlayerEndTextHistory()}schedulePlayerEndTextHistory(){this.state.playerEndTextUpdateTimer&&clearTimeout(this.state.playerEndTextUpdateTimer),this.state.playerEndTextUpdateTimer=setTimeout(()=>{this.manager.history.pushCurrentState()},400)}normalizeType(e){if(typeof e!="string"||!e.length)return null;const t=EditorConstants.OBJECT_DEFINITIONS;if(Array.isArray(t)&&t.length){const n=t.find(i=>i.type===e)?.type||null;if(n)return n}return new Set(ObjectDefinitions.getPlaceableTypes()).has(e)?e:null}};typeof window<"u"&&(window.EditorObjectService=Ut);let zt=class{constructor(e){this.manager=e}get dom(){return this.manager.domCache}get gameEngine(){return this.manager.gameEngine}toggle(e,t=null){if(!e||!this.gameEngine.setVariableDefault)return;const a=(this.gameEngine.getVariableDefinitions?.()??[]).find(r=>r.id===e),n=t!==null?!!t:!a?.value;this.gameEngine.setVariableDefault(e,n)&&(this.manager.renderService.renderObjects(),this.manager.npcService.updateNpcSelection(this.manager.state.selectedNpcType,this.manager.state.selectedNpcId),this.gameEngine.draw(),this.manager.updateJSON(),this.manager.history.pushCurrentState())}};typeof window<"u"&&(window.EditorVariableService=zt);let Wt=class{constructor(e){this.manager=e}get dom(){return this.manager.domCache}get state(){return this.manager.state}get gameEngine(){return this.manager.gameEngine}setActiveRoom(e){const t=Number(e);if(!Number.isFinite(t))return;const a=this.gameEngine.getGame().rooms?.length||1,n=Math.max(0,Math.min(a-1,Math.floor(t)));n!==this.state.activeRoomIndex&&((this.state.placingNpc||this.state.selectedNpcId||this.state.selectedNpcType)&&this.manager.npcService.clearSelection(),this.state.placingEnemy&&this.manager.enemyService.deactivatePlacement(),this.state.activeRoomIndex=n,this.manager.renderService.renderWorldGrid(),this.manager.renderService.renderObjects(),this.manager.renderObjectCatalog(),this.manager.renderService.renderEditor(),this.manager.renderService.renderEnemies())}moveActiveRoom(e){if(!e)return;const t=String(e).toLowerCase(),a=this.gameEngine.getGame(),n=Math.max(1,Number(a.world?.rows)||1),i=Math.max(1,Number(a.world?.cols)||1),r=Math.max(1,a.rooms?.length||n*i);if(!n||!i||!r)return;const s=Math.max(0,Math.min(r-1,this.state.activeRoomIndex??0)),l=Math.floor(s/i),o=s%i;let c=l,d=o;if(t==="up"&&(c-=1),t==="down"&&(c+=1),t==="left"&&(d-=1),t==="right"&&(d+=1),c<0||c>=n||d<0||d>=i)return;const u=c*i+d;u<0||u>=r||this.setActiveRoom(u)}};typeof window<"u"&&(window.EditorWorldService=Wt);let Ht=class{constructor(e){this.gameEngine=e,this.state=new EditorState,this.domCache=new EditorDomCache(typeof document<"u"?document:null),this.editorCanvas=this.domCache.editorCanvas||null,this.ectx=this.editorCanvas?.getContext("2d")??null,this.ectx&&(this.ectx.imageSmoothingEnabled=!1),this.history=new EditorHistoryManager(this),this.renderService=new EditorRenderService(this),this.tileService=new EditorTileService(this),this.shareService=new EditorShareService(this),this.npcService=new EditorNpcService(this),this.enemyService=new EditorEnemyService(this),this.objectService=new EditorObjectService(this),this.variableService=new EditorVariableService(this),this.worldService=new EditorWorldService(this),this.uiController=new EditorUIController(this),this.eventBinder=new EditorEventBinder(this),this.interactionController=new EditorInteractionController(this),this.bindEvents(),this.initialize(),typeof document<"u"&&document.addEventListener("language-changed",()=>this.handleLanguageChange())}get selectedTileId(){return this.state.selectedTileId}set selectedTileId(e){this.state.selectedTileId=e}get selectedNpcId(){return this.state.selectedNpcId}set selectedNpcId(e){this.state.selectedNpcId=e}get selectedNpcType(){return this.state.selectedNpcType}set selectedNpcType(e){this.state.selectedNpcType=e}get activeRoomIndex(){return this.state.activeRoomIndex}set activeRoomIndex(e){this.state.activeRoomIndex=e}get placingNpc(){return this.state.placingNpc}set placingNpc(e){this.state.placingNpc=e}get placingEnemy(){return this.state.placingEnemy}set placingEnemy(e){this.state.placingEnemy=e}get placingObjectType(){return this.state.placingObjectType}set placingObjectType(e){this.state.placingObjectType=e}get selectedObjectType(){return this.state.selectedObjectType}set selectedObjectType(e){this.state.selectedObjectType=e}get selectedEnemyType(){return this.state.selectedEnemyType}set selectedEnemyType(e){this.state.selectedEnemyType=e}get mapPainting(){return this.state.mapPainting}set mapPainting(e){this.state.mapPainting=e}get dom(){return this.domCache}bindEvents(){this.eventBinder.bind()}initialize(){this.gameEngine.tileManager.ensureDefaultTiles();const e=this.gameEngine.getTiles();e.length>0&&(this.selectedTileId=e[0].id),this.syncUI();const t=this.gameEngine.getGame()?.start?.roomIndex??0,a=this.gameEngine.getGame()?.rooms?.length||1;this.activeRoomIndex=Math.max(0,Math.min(a-1,t)),this.gameEngine.npcManager?.ensureDefaultNPCs?.(),this.renderAll(),this.updateMobilePanels(),this.handleCanvasResize(!0),this.history.pushCurrentState()}desselectAllAndRender(){const e=!!this.tileService?.clearSelection?.({render:!1}),t=!!this.npcService?.clearSelection?.({render:!1}),a=!!this.enemyService?.clearSelection?.({render:!1}),n=!!this.objectService?.clearSelection?.({render:!1});return e&&(this.renderService.renderTileList(),this.renderService.updateSelectedTilePreview()),t&&this.renderService.renderNpcs(),a&&this.renderService.renderEnemyCatalog(),n&&this.renderService.renderObjectCatalog(),e||t||a||n}renderAll(){this.renderService.renderTileList(),this.renderService.renderWorldGrid(),this.renderService.renderNpcs(),this.renderService.renderEnemyCatalog(),this.renderService.renderEnemies(),this.renderService.renderObjectCatalog(),this.renderService.renderObjects(),this.renderService.renderEditor(),this.renderService.updateSelectedTilePreview()}renderEditor(){this.renderService.renderEditor()}renderTileList(){this.renderService.renderTileList()}updateSelectedTilePreview(){this.renderService.updateSelectedTilePreview()}renderNpcs(){this.renderService.renderNpcs()}renderEnemies(){this.renderService.renderEnemies()}renderEnemyCatalog(){this.renderService.renderEnemyCatalog()}renderObjectCatalog(){this.renderService.renderObjectCatalog()}renderObjects(){this.renderService.renderObjects()}renderWorldGrid(){this.renderService.renderWorldGrid()}toggleVariablePanel(){this.uiController.toggleVariablePanel()}toggleSkillPanel(){this.uiController.toggleSkillPanel()}toggleTestPanel(){this.uiController.toggleTestPanel()}setTestStartLevel(e){this.uiController.setTestStartLevel(e)}setTestSkills(e){this.uiController.setTestSkills(e)}setGodMode(e){this.uiController.setGodMode(e)}setActiveMobilePanel(e){this.uiController.setActiveMobilePanel(e)}updateMobilePanels(){this.uiController.updateMobilePanels()}startMapPaint(e){this.tileService.startPaint(e)}continueMapPaint(e){this.tileService.continuePaint(e)}finishMapPaint(e){this.tileService.finishPaint(e)}addNPC(){this.npcService.addNpc()}removeSelectedNpc(){this.npcService.removeSelectedNpc()}updateNpcSelection(){this.npcService.updateNpcSelection(this.selectedNpcType,this.selectedNpcId)}updateNpcText(){this.dom.npcText&&this.npcService.updateNpcText(this.dom.npcText.value)}updateNpcConditionalText(){this.dom.npcConditionalText&&this.npcService.updateNpcConditionalText(this.dom.npcConditionalText.value)}handleNpcConditionVariableChange(){const e=this.dom.npcConditionalVariable;e&&this.npcService.handleConditionVariableChange(e.value)}handleNpcRewardVariableChange(){const e=this.dom.npcRewardVariable;e&&this.npcService.handleRewardVariableChange(e.value)}handleNpcConditionalRewardVariableChange(){const e=this.dom.npcConditionalRewardVariable;e&&this.npcService.handleConditionalRewardVariableChange(e.value)}removeEnemy(e){this.enemyService.removeEnemy(e)}removeObject(e,t){this.objectService.removeObject(e,t)}toggleVariableDefault(e,t=null){this.variableService.toggle(e,t)}setActiveRoom(e){this.worldService.setActiveRoom(e)}generateShareableUrl(){return this.shareService.generateShareableUrl()}saveGame(){this.shareService.saveGame()}loadGameFile(e){this.shareService.loadGameFile(e)}pushHistory(){this.history.pushCurrentState()}undo(){this.history.undo()}redo(){this.history.redo()}updateGameMetadata(){this.uiController.updateGameMetadata()}updateJSON(){this.uiController.updateJSON()}syncUI(){this.uiController.syncUI()}restore(e,t={}){const{skipHistory:a=!1}=t;this.gameEngine.importGameData(e),this.gameEngine.tileManager.ensureDefaultTiles();const n=this.gameEngine.getTiles();n.length&&!n.find(l=>l.id===this.selectedTileId)&&(this.selectedTileId=n[0].id),this.gameEngine.getSprites().find(l=>l.id===this.selectedNpcId)||(this.selectedNpcId=null,this.selectedNpcType=null,this.placingNpc=!1);const r=EditorConstants.ENEMY_DEFINITIONS,s=EnemyDefinitions.normalizeType(this.selectedEnemyType);s!==this.selectedEnemyType?this.selectedEnemyType=s:r.some(l=>l.type===this.selectedEnemyType)||(this.selectedEnemyType=r[0]?.type||"giant-rat"),this.renderAll(),this.gameEngine.draw(),this.syncUI(),a||this.history.pushCurrentState()}handleCanvasResize(e=!1){this.interactionController.handleCanvasResize(e)}handleLanguageChange(){this.uiController.handleLanguageChange()}refreshNpcLocalizedText(){this.uiController.refreshNpcLocalizedText()}handleKey(e){this.interactionController.handleKey(e)}createNewGame(){const e=()=>Array.from({length:8},()=>Array(8).fill(null)),t={title:"Novo Jogo",palette:["#0e0f13","#2e3140","#f4f4f8"],roomSize:8,rooms:[{size:8,bg:0,tiles:Array.from({length:8},()=>Array(8).fill(0)),walls:Array.from({length:8},()=>Array(8).fill(!1))}],start:{x:1,y:1,roomIndex:0},sprites:[],items:[],exits:[],objects:[],enemies:[],variables:[],tileset:{tiles:[],map:{ground:e(),overlay:e()}}};this.restore(t)}};typeof window<"u"&&(window.EditorManager=Ht);class Fe{constructor(){this.btn=typeof document<"u"?document.getElementById("btn-generate-html"):null,this.btn&&this.btn.addEventListener("click",e=>{setTimeout(()=>this.exportProjectAsHtml(),0)})}async exportProjectAsHtml(){try{const e=typeof window<"u"&&window.TinyRPGMaker&&typeof window.TinyRPGMaker.exportGameData=="function"?window.TinyRPGMaker.exportGameData():null;if(!e){alert("Unable to read current project data.");return}const t=typeof ShareUtils<"u"&&typeof ShareUtils.encode=="function"?ShareUtils.encode(e):"",a="Unable to download project assets. Please run Tiny RPG Studio from an HTTP/HTTPS server (not file://) to export HTML.";let n="";const i=document.querySelector('link[rel="stylesheet"][href]');if(i){const v=i.getAttribute("href");try{const I=await fetch(v);if(I.ok)n=await I.text();else{alert(a);return}}catch{alert(a);return}}const r={},s=[];let l="";const o="export.bundle.js";try{const v=await fetch(o);v.ok&&(l=await v.text(),r[o]=l)}catch{}const c=typeof TextResources<"u"&&typeof TextResources.getLocale=="function"&&TextResources.getLocale()||"en-US",d="legacy/index.html",u=["js/core/TextResources.js","js/core/SkillDefinitions.js","js/core/state/StateWorldManager.js","js/core/state/StateSkillManager.js","js/core/state/StatePlayerManager.js","js/core/state/StateDialogManager.js","js/core/state/StateVariableManager.js","js/core/state/StateEnemyManager.js","js/core/state/StateObjectManager.js","js/core/state/StateItemManager.js","js/core/state/GameStateLifecycle.js","js/core/state/GameStateScreenManager.js","js/core/state/GameStateWorldFacade.js","js/core/state/GameStatePlayerFacade.js","js/core/state/GameStateDataFacade.js","js/core/state/StateDataManager.js","js/core/GameState.js","js/core/sprites/PlayerSprites.js","js/core/sprites/NpcSprites.js","js/core/sprites/EnemySprites.js","js/core/sprites/ObjectSprites.js","js/core/sprites/SpriteMatrixRegistry.js","js/core/renderer/RendererConstants.js","js/core/renderer/RendererPalette.js","js/core/renderer/RendererSpriteFactory.js","js/core/renderer/RendererCanvasHelper.js","js/core/renderer/RendererTileRenderer.js","js/core/renderer/RendererEntityRenderer.js","js/core/renderer/RendererDialogRenderer.js","js/core/renderer/RendererHudRenderer.js","js/core/renderer/RendererMinimapRenderer.js","js/core/renderer/RendererModuleBase.js","js/core/renderer/RendererEffectsManager.js","js/core/renderer/RendererTransitionManager.js","js/core/renderer/RendererOverlayRenderer.js","js/core/share/ShareConstants.js","js/core/share/ShareMath.js","js/core/share/ShareBase64.js","js/core/share/ShareTextCodec.js","js/core/share/ShareVariableCodec.js","js/core/share/ShareMatrixCodec.js","js/core/share/SharePositionCodec.js","js/core/share/ShareDataNormalizer.js","js/core/share/ShareEncoder.js","js/core/share/ShareDecoder.js","js/core/share/ShareUrlHelper.js","js/core/TileDefinitions.js","js/core/NPCDefinitions.js","js/core/EnemyDefinitions.js","js/core/ObjectDefinitions.js","js/editor/modules/EditorConstants.js","js/editor/modules/EditorDomCache.js","js/editor/modules/EditorState.js","js/editor/modules/EditorHistoryManager.js","js/editor/modules/EditorShareService.js","js/editor/manager/EditorManagerModule.js","js/editor/manager/EditorEventBinder.js","js/editor/manager/EditorUIController.js","js/editor/manager/EditorInteractionController.js","js/editor/modules/renderers/EditorRendererBase.js","js/editor/modules/renderers/EditorCanvasRenderer.js","js/editor/modules/renderers/EditorTilePanelRenderer.js","js/editor/modules/renderers/EditorNpcRenderer.js","js/editor/modules/renderers/EditorEnemyRenderer.js","js/editor/modules/renderers/EditorObjectRenderer.js","js/editor/modules/renderers/EditorWorldRenderer.js","js/editor/modules/EditorRenderService.js","js/editor/modules/EditorTileService.js","js/editor/modules/EditorNpcService.js","js/editor/modules/EditorEnemyService.js","js/editor/modules/EditorObjectService.js","js/editor/modules/EditorVariableService.js","js/editor/modules/EditorWorldService.js","js/editor/EditorManager.js","js/core/ShareUtils.js","js/core/TileManager.js","js/core/NPCManager.js","js/core/InputManager.js","js/core/Renderer.js","js/core/engine/DialogManager.js","js/core/engine/InteractionManager.js","js/core/engine/EnemyManager.js","js/core/engine/MovementManager.js","js/core/GameEngine.js","js/main.js","js/editor/modules/EditorExportService.js"],h=[];if(!l)try{const v=await fetch(d);if(v.ok){const I=await v.text(),k=new DOMParser().parseFromString(I,"text/html");h.push(...Array.from(k.querySelectorAll("script[src]")).filter(w=>w.getAttribute("type")!=="module").map(w=>w.getAttribute("src")).filter(w=>w&&(w.startsWith("js/")||w.startsWith("./js/"))&&!w.includes("/editor/")))}}catch{}const g=h.length&&h.some(v=>v.includes("js/main.js"))?h:u;for(const v of g){if(l)break;try{const I=await fetch(v);if(I.ok){const k=await I.text();/^(?:\s*import\s+[\w*{]|\s*export\s+)/m.test(k)?s.push(v):r[v]=k}else{alert(a);return}}catch{alert(a);return}}const p=document.getElementById("game-container");if(!p){alert("game-container not found");return}const f=p.cloneNode(!0),y=Object.values(r).join(""),T=`<!DOCTYPE html>
                <html lang="${c}">
                <head>
                <meta charset="utf-8">
                <meta name="viewport" content="width=device-width, initial-scale=1">
                <title>Tiny RPG</title>
                <style>${n}
                #game-container{position:relative;display:flex;flex-direction:column;justify-content:center;align-items:center;background-color:#000;overflow:hidden}
                </style>
                <script>
                console.log('[TinyRPG Export] Booting exported build');
                window.__TINY_RPG_EXPORT_MODE = true;
                window.__TINY_RPG_SHARED_CODE = ${JSON.stringify(t)};
                console.log('[TinyRPG Export] Share code ready', { length: (window.__TINY_RPG_SHARED_CODE || '').length });
                if(!location.hash) try{ location.hash = '#' + window.__TINY_RPG_SHARED_CODE; }catch(e){}
                <\/script>
                </head>
                <body class="game-mode">
                <div class="app">
                <main>
                <div class="tab-content active" id="tab-game">
                ${f.outerHTML}
                </div>
                </main>
                </div>
                <script>
            console.log('[TinyRPG Export] Loading scripts', { count: ${Object.keys(r).length}, requested: ${g.length}, skipped: ${JSON.stringify(s)}, bundle: ${!!l} });
                ${y}
                console.log('[TinyRPG Export] Scripts executed');
                <\/script>
                </body>
            </html>`,x=(typeof e?.title=="string"?e.title:"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-zA-Z0-9]+/g,"-").replace(/^-+|-+$/g,"").toLowerCase(),O=typeof ShareConstants<"u"&&ShareConstants?.VERSION?ShareConstants.VERSION:1,N=`${x||"tiny-rpg"}-v${O}.html`,D=new Blob([T],{type:"text/html;charset=utf-8"}),L=URL.createObjectURL(D),A=document.createElement("a");A.href=L,A.download=N,document.body.appendChild(A),A.click(),A.remove(),URL.revokeObjectURL(L)}catch(e){console.error("Export failed",e),alert("Export failed. See console for details.")}}}typeof window<"u"&&(window.EditorExportService=Fe,document.addEventListener("DOMContentLoaded",()=>{try{window.__editorExportService=new Fe}catch{}}));let ue=class{static _npcDefinitions;static _objectDefinitions;static _enemyDefinitions;static get NPC_DEFINITIONS(){const e=typeof window<"u"&&window.NPCDefinitions;return(!this._npcDefinitions||e&&!this._npcDefinitions.length)&&(e?this._npcDefinitions=window.NPCDefinitions.definitions||window.NPCDefinitions.NPC_DEFINITIONS||[]:this._npcDefinitions||(this._npcDefinitions=[])),this._npcDefinitions||[]}static get OBJECT_DEFINITIONS(){const e=typeof window<"u"&&window.ObjectDefinitions;return(!this._objectDefinitions||e&&!this._objectDefinitions.length)&&(e?this._objectDefinitions=window.ObjectDefinitions.definitions||window.ObjectDefinitions.OBJECT_DEFINITIONS||[]:this._objectDefinitions||(this._objectDefinitions=[])),this._objectDefinitions||[]}static get ENEMY_DEFINITIONS(){const e=typeof window<"u"&&window.EnemyDefinitions;return(!this._enemyDefinitions||e&&!this._enemyDefinitions.length)&&(e?this._enemyDefinitions=window.EnemyDefinitions.definitions||window.EnemyDefinitions.ENEMY_DEFINITIONS||[]:this._enemyDefinitions||(this._enemyDefinitions=[])),this._enemyDefinitions||[]}static get DEFAULT_PALETTE(){return["#000000","#1D2B53","#7E2553","#008751","#AB5236","#5F574F","#C2C3C7","#FFF1E8","#FF004D","#FFA300","#FFFF27","#00E756","#29ADFF","#83769C","#FF77A8","#FFCCAA"]}};typeof window<"u"&&(window.RendererConstants=ue);class Ve{gameState;constructor(e){this.gameState=e}getPalette(){return this.getPicoPalette()}getPicoPalette(){return typeof window<"u"&&window.PICO8_COLORS?window.PICO8_COLORS:ue.DEFAULT_PALETTE}getColor(e){return this.getPalette()[e]||"#f4f4f8"}}typeof window<"u"&&(window.RendererPalette=Ve);class ye{renderer;constructor(e){this.renderer=e}get canvas(){return this.renderer.canvas}get ctx(){return this.renderer.ctx}get gameState(){return this.renderer.gameState}get gameEngine(){return this.renderer.gameEngine}get tileManager(){return this.renderer.tileManager}get paletteManager(){return this.renderer.paletteManager}get spriteFactory(){return this.renderer.spriteFactory}get canvasHelper(){return this.renderer.canvasHelper}get entityRenderer(){return this.renderer.entityRenderer}}typeof window<"u"&&(window.RendererModuleBase=ye);class Be{canvas;ctx;tileManager;constructor(e,t,a){this.canvas=e,this.ctx=t,this.tileManager=a||null}getTilePixelSize(){return Math.floor(this.canvas.width/8)}drawSprite(e,t,a,n,i){if(t)for(let r=0;r<t.length;r++){const s=t[r];for(let l=0;l<s.length;l++){const o=s[l];o&&(e.fillStyle=o,e.fillRect(a+l*i,n+r*i,i,i))}}}resolveTilePixels(e,t=null){return this.tileManager?.getTilePixels?this.tileManager.getTilePixels(e,t):Array.isArray(e?.frames)&&e.frames.length?e.frames[0]:Array.isArray(e?.pixels)?e.pixels:null}drawCustomTile(e,t,a,n,i=null){if(!this.tileManager)return;const r=this.tileManager.getTile(e);if(!r)return;const s=this.resolveTilePixels(r,i);if(!s)return;const l=Math.max(1,Math.floor(n/8));for(let o=0;o<8;o++)for(let c=0;c<8;c++){const d=s[o]?.[c];!d||d==="transparent"||(this.ctx.fillStyle=d,this.ctx.fillRect(t+c*l,a+o*l,l,l))}}drawTileOnCanvas(e,t,a=null){const n=e.getContext("2d");if(!n)return;n.clearRect(0,0,e.width,e.height);const i=this.resolveTilePixels(t,a);if(!i)return;const r=Math.max(1,Math.floor(e.width/8));for(let s=0;s<8;s++)for(let l=0;l<8;l++){const o=i[s]?.[l];!o||o==="transparent"||(n.fillStyle=o,n.fillRect(l*r,s*r,r,r))}}drawTilePreview(e,t,a,n,i=this.ctx,r=null){if(!this.tileManager)return;const s=this.tileManager.getTile(e);if(!s)return;const l=this.resolveTilePixels(s,r);if(!l)return;const o=Math.max(1,Math.floor(n/8));for(let c=0;c<8;c++)for(let d=0;d<8;d++){const u=l[c]?.[d];!u||u==="transparent"||(i.fillStyle=u,i.fillRect(t+d*o,a+c*o,o,o))}}}typeof window<"u"&&(window.RendererCanvasHelper=Be);class _e{paletteManager;gameState;playerSprite;enemySprite;enemySprites;npcSprites;objectSprites;constructor(e,t=null){this.paletteManager=e,this.gameState=t,this.playerSprite=null,this.enemySprite=null,this.enemySprites=null,this.npcSprites=null,this.objectSprites=null}getPlayerSprite(){return this.playerSprite||(this.playerSprite=this.buildPlayerSprite()),this.playerSprite}getEnemySprite(e=null){this.enemySprites||(this.enemySprites=this.buildEnemySprites());const t=this.enemySprites;if(e&&t[e])return t[e];if(e){const a=EnemyDefinitions.normalizeType(e);if(t[a])return t[a]}return this.enemySprite||(this.enemySprite=t.default||this.buildEnemySprite()),this.enemySprite}getEnemySprites(){return this.enemySprites||(this.enemySprites=this.buildEnemySprites()),this.enemySprites}getNpcSprites(){return this.npcSprites||(this.npcSprites=this.buildNpcSprites()),this.npcSprites}getObjectSprites(){return this.objectSprites||(this.objectSprites=this.buildObjectSprites()),this.objectSprites}buildPlayerSprite(){const e=this.paletteManager.getPicoPalette(),t=ge.get("player");return this.mapPixels(t,e)}buildNpcSprites(){const e=this.paletteManager.getPicoPalette(),t={};for(const a of ue.NPC_DEFINITIONS){const n=a.sprite;t[a.type]=this.mapPixels(n,e,()=>this.buildDefaultNpcSprite(e))}return t.default=this.buildDefaultNpcSprite(e),t}buildObjectSprites(){const e=this.paletteManager.getPicoPalette(),t={};for(const a of ue.OBJECT_DEFINITIONS)Array.isArray(a.sprite)&&(t[a.type]=this.mapPixels(a.sprite,e),Array.isArray(a.spriteOn)&&(t[`${a.type}--on`]=this.mapPixels(a.spriteOn,e)));return t}buildEnemySprites(){const e=this.paletteManager.getPicoPalette(),t=this.buildDefaultEnemySprite(e),a={default:t},n=ue.ENEMY_DEFINITIONS;if(Array.isArray(n))for(const i of n){if(!Array.isArray(i.sprite))continue;const r=this.mapPixels(i.sprite,e,()=>t);if(a[i.type]=r,Array.isArray(i.aliases))for(const s of i.aliases)a[s]=r}return a}buildDefaultNpcSprite(e){const t=ge.get("npc");return this.mapPixels(t,e)}buildEnemySprite(){const e=this.buildEnemySprites();return this.enemySprites=e,this.enemySprite=e.default,this.enemySprite}buildDefaultEnemySprite(e){const t=e||this.paletteManager.getPicoPalette(),a=ge.get("enemy");return this.mapPixels(a,t)}mapPixels(e,t,a){return Array.isArray(e)?e.map(n=>n.map(i=>i==null?null:t[i]??null)):a?a():null}turnSpriteHorizontally(e){if(e)return e.map(t=>[...t].reverse())}}typeof window<"u"&&(window.RendererSpriteFactory=_e);class Ge{gameState;tileManager;paletteManager;canvasHelper;constructor(e,t,a,n){this.gameState=e,this.tileManager=t,this.paletteManager=a,this.canvasHelper=n}clearCanvas(e,t){const a=this.gameState.getCurrentRoom(),n=this.paletteManager.getColor(a.bg);e.fillStyle=n,e.fillRect(0,0,t.width,t.height)}drawBackground(e,t){const a=this.gameState.getCurrentRoom(),n=this.paletteManager.getColor(a.bg);e.fillStyle=n,e.fillRect(0,0,t.width,t.height)}drawTiles(e,t){const a=this.gameState.getCurrentRoom(),n=this.canvasHelper.getTilePixelSize(),i=this.gameState.getPlayer?.()??{roomIndex:0},r=this.tileManager.getTileMap(i.roomIndex??0),s=r?.ground||[],l=r?.overlay||[];for(let o=0;o<8;o++)for(let c=0;c<8;c++){const d=s[o]?.[c];if(d!=null)this.canvasHelper.drawCustomTile(d,c*n,o*n,n);else{const h=a.tiles[o][c];e.fillStyle=this.paletteManager.getColor(h),e.fillRect(c*n,o*n,n,n)}const u=l[o]?.[c];u!=null&&this.canvasHelper.drawCustomTile(u,c*n,o*n,n)}}drawWalls(e){const t=this.gameState.getCurrentRoom(),a=this.canvasHelper.getTilePixelSize();e.fillStyle=this.paletteManager.getColor(1);for(let n=0;n<8;n++)for(let i=0;i<8;i++)t.walls[n][i]&&e.fillRect(i*a,n*a,a,a)}}typeof window<"u"&&(window.RendererTileRenderer=Ge);class Ue{gameState;tileManager;spriteFactory;canvasHelper;paletteManager;viewportOffsetY;constructor(e,t,a,n,i){this.gameState=e,this.tileManager=t,this.spriteFactory=a,this.canvasHelper=n,this.paletteManager=i}setViewportOffset(e=0){this.viewportOffsetY=Number.isFinite(e)?Math.max(0,e):0}drawObjects(e){const t=this.gameState.getGame(),a=this.gameState.getPlayer(),n=this.canvasHelper.getTilePixelSize(),i=n/8,r=Array.isArray(t.objects)?t.objects:[],s=this.spriteFactory.getObjectSprites(),l=ObjectTypes;for(const o of r){if(o.roomIndex!==a.roomIndex||o.hiddenInRuntime||o.hideWhenCollected&&o.collected||o.hideWhenOpened&&o.opened||o.hideWhenVariableOpen&&(o.variableId?this.gameState.isVariableOn?.(o.variableId):!1))continue;let c=s?.[o.type];if(o.type===l.SWITCH&&o.on&&(c=s?.[`${o.type}--on`]||c),!c)continue;const d=o.x*n,u=o.isCollectible&&!o.collected?this.getFloatingOffset(o.x,o.y,n):0,h=Math.round(o.y*n+u);this.canvasHelper.drawSprite(e,c,d,h,i)}}drawItems(e){const t=this.gameState.getGame(),a=this.gameState.getPlayer(),n=this.canvasHelper.getTilePixelSize(),i=this.getNow();e.fillStyle=this.paletteManager.getColor(2);for(const r of t.items){if(r.roomIndex!==a.roomIndex||r.collected)continue;const s=(r.x*.75+r.y*1.15)*.6,l=Math.sin(i*.004+s)*n*.1,o=.5+Math.sin(i*.006+s)*.03,c=n*o,d=(n*.5-c)/2,u=Math.round(r.x*n+n*.25+d),h=Math.round(r.y*n+n*.25+l+d);e.fillRect(u,h,Math.round(c),Math.round(c))}}drawNPCs(e){const t=this.gameState.getGame(),a=this.gameState.getPlayer(),n=this.canvasHelper.getTilePixelSize(),i=n/8,r=this.spriteFactory.getNpcSprites();for(const s of t.sprites){if(!s.placed||s.roomIndex!==a.roomIndex)continue;const l=s.x*n,o=s.y*n;let c=r[s.type]||r.default;c=this.adjustSpriteHorizontally(a.x,s.x,c),this.canvasHelper.drawSprite(e,c,l,o,i)}}drawEnemies(e){const t=this.gameState.getEnemies?.()??[];if(!t.length)return;const a=this.gameState.getPlayer(),n=this.canvasHelper.getTilePixelSize(),i=n/8;t.forEach(r=>{if(r.roomIndex!==a.roomIndex)return;const s=this.spriteFactory.getEnemySprite(r.type);if(!s)return;const l=this.adjustSpriteHorizontally(r.x,r.lastX,s),o=r.x*n,c=r.y*n;this.canvasHelper.drawSprite(e,l,o,c,i);const d=this.getEnemyDamage(r.type);this.drawEnemyDamageMarkers(e,o,c,n,d)})}drawPlayer(e){const t=this.gameState.getPlayer(),a=this.canvasHelper.getTilePixelSize(),n=a/8,i=t.x*a,r=t.y*a;let s=this.spriteFactory.getPlayerSprite();s=this.adjustSpriteHorizontally(t.x,t.lastX,s);const l=this.shouldFadePlayerForStealth();l&&e.save(),l&&(e.globalAlpha=.45),this.canvasHelper.drawSprite(e,s,i,r,n),l&&e.restore()}drawTileIconOnPlayer(e,t){let n=this.spriteFactory.getObjectSprites()?.[t];if(!n)return;const i=this.gameState.getPlayer();let r=this.canvasHelper.getTilePixelSize();r=r/2;const s=r/8,l=(i.x+.2)*r*2,o=(i.y-1)*r*2;this.canvasHelper.drawSprite(e,n,l,o,s)}adjustSpriteHorizontally(e,t,a){return e<t?this.spriteFactory.turnSpriteHorizontally(a):a}getFloatingOffset(e,t,a){const n=(e*.7+t*1.3)*.6;return Math.sin(this.getNow()*.003+n)*a*.12}getNow(){return typeof performance<"u"&&performance.now?performance.now():Date.now()}getEnemyDamage(e){const t=EnemyDefinitions.getEnemyDefinition(e);if(t&&Number.isFinite(t.damage))return Math.max(1,t.damage);const a=EnemyDefinitions.normalizeType(e),n=EnemyDefinitions.getEnemyDefinition(a);return n&&Number.isFinite(n.damage)?Math.max(1,n.damage):1}shouldFadePlayerForStealth(){if(!this.gameState.hasSkill?.("stealth"))return!1;const e=this.gameState.getEnemies?.()||[],t=this.gameState.getPlayer?.()?.roomIndex??-1;return e.some(a=>a.roomIndex===t&&this.getEnemyDamage(a.type)<=3)}drawEnemyDamageMarkers(e,t,a,n,i){if(!e)return;const r=Math.max(1,Math.floor(i)),s=Math.max(2,Math.floor(n/8)),l=Math.max(1,Math.floor(s/2)),o=r*s+(r-1)*l,c=Math.round(t+n/2-o/2),d=Math.round(a-s-l),u="#000000",h=this.paletteManager.getColor(6)||"#5F574F";e.fillStyle=u,e.strokeStyle=h,e.lineWidth=1;for(let g=0;g<r;g++){const p=c+g*(s+l);e.fillRect(p,d,s,s),e.strokeRect(p+.5,d+.5,s-1,s-1)}}cleanupEnemyLabels(){}}typeof window<"u"&&(window.RendererEntityRenderer=Ue);class ze{gameState;paletteManager;constructor(e,t){this.gameState=e,this.paletteManager=t}drawDialog(e,t){const a=this.gameState.getDialog();!a.active||!a.text||((!a.page||a.page<1)&&(a.page=1),this.drawDialogBox(e,t,a))}drawDialogBox(e,t,a){const i=t.width-12,r=40,s=6,l=t.height-r-6;e.fillStyle="rgba(0,0,0,0.7)",e.fillRect(s,l,i,r);const o=this.paletteManager.getColor(7)||"#FFF1E8";e.strokeStyle=o,e.strokeRect(s,l,i,r),e.fillStyle=o,e.font="10px monospace";const c=12,d=i-16,u=this.calculateDialogPages(a,e,d,c,r-8),h=Math.max(1,u.length);a.maxPages!==h&&(a.maxPages=h);const g=Math.min(Math.max((a.page??1)-1,0),h-1);a.page!==g+1&&(a.page=g+1);const p=u[g]||[];let f=l+14;for(const y of p)e.fillText(y,s+8,f),f+=c}calculateDialogPages(e,t,a,n,i){const r=(e.text||"").split(/\s+/);let s="";const l=[];for(let d=0;d<r.length;d++){const u=s+r[d]+" ";t.measureText(u).width>a&&d>0?(l.push(s.trim()),s=r[d]+" "):s=u}l.push(s.trim());const o=Math.max(1,Math.floor(i/n)),c=[];for(let d=0;d<l.length;d+=o)c.push(l.slice(d,d+o));return c}}typeof window<"u"&&(window.RendererDialogRenderer=ze);class We{gameState;entityRenderer;paletteManager;padding;gap;backgroundColor;viewportOffsetY;canvasHelper;healthIconDefinitions;objectSprites;constructor(e,t,a){this.gameState=e,this.entityRenderer=t,this.paletteManager=a,this.padding=4,this.gap=6,this.backgroundColor="#000000",this.viewportOffsetY=0,this.canvasHelper=t.canvasHelper,this.healthIconDefinitions={},this.objectSprites=this.entityRenderer?.spriteFactory?.getObjectSprites?.()||{},this.setupHealthIcons()}drawHUD(e,t={}){if(!e)return;const a=t.width??e.canvas?.width??128,n=t.height??16,i=t.padding??this.padding,r=this.paletteManager?.getColor?.(7)||"#FFF1E8";if(e.save(),e.fillStyle=this.backgroundColor,e.fillRect(0,0,a,n),this.gameState.isGameOver()){e.restore();return}const s=this.getLevelLabel(),l=t.fontSize??Math.max(6,Math.floor(n*.4));e.font=`${l}px monospace`,e.textBaseline="middle";const o=Math.max(4,Math.floor((n-i*2)/3)),c=o*3,d=a-i-c,u=Math.round(n/2-c/2),h=s?e.measureText(s).width:0,g=s?this.gap:0,p=c+this.gap+h+g,f=Math.max(0,a-i-p),y=this.canvasHelper.getTilePixelSize?.()??16,T=this.gameState.getMaxLives?.()??0,b=Math.max(6,Math.min(n-i*2,y/2)),x=b+2,O=T>0?Math.max(1,Math.ceil(T/2)):1,N=Math.max(O,Math.floor(f/Math.max(x,1)));this.drawHealth(e,{offsetX:i-4,offsetY:i+Math.max(0,(n-i*2-b)/2)-2,heartsPerRow:N,heartSize:b,gap:2}),s&&(e.fillStyle=r,e.textAlign="right",e.fillText(s,d-this.gap,n/2)),this.drawMiniMap(e,d,u,o,c),this.drawXpBar(e,d-30,u+c),e.restore()}drawInventory(e,t={}){if(!e)return;const a=t.width??e.canvas?.width??128,n=t.height??16,i=t.padding??this.padding,r=t.x??0,s=t.y??0,l=Number.isFinite(t.gap)?Math.max(0,t.gap):2,o=Math.min(9,this.gameState.getMaxKeys());let c=this.gameState.getKeys();c=Math.max(0,Math.min(o,c));const d=Math.max(0,this.gameState.getDamageShield()),u=Math.max(0,this.gameState.getDamageShieldMax()),h=this.gameState.getSwordType?.()||null;if(e.save(),e.translate(r,s),e.fillStyle=this.backgroundColor,e.fillRect(0,0,a,n),this.gameState.isGameOver()){e.restore();return}const g=this.canvasHelper.getTilePixelSize?.()??16,p=Math.max(0,n-i*2),f=Math.max(6,Math.min(p,g/2)),y=Math.min(f,Math.floor((p+l)/3-l)),T=Math.max(6,y),b=T+l,x=3,N=3*b-l,D=i,L=i+Math.max(0,(n-i*2-N)/2),A=this.objectSprites?.[ObjectTypes.KEY]||null;if(A&&c>0){const I=Math.min(c,o);for(let k=0;k<I;k++){const w=Math.floor(k/x),F=k%x,$=D+F*b,H=L+w*b,P=T/8;this.canvasHelper.drawSprite(e,A,$,H,P)}}const v=this.getSwordHudSprite(h);if(d>0&&v){const k=this.canvasHelper.getTilePixelSize?.()??16,w=a-i-k,F=i+Math.max(0,Math.round((n-i*2-k)/2)),$=k/8,H=u>0?Math.max(.25,Math.min(1,d/u)):1;e.save(),e.globalAlpha=H,this.canvasHelper.drawSprite(e,v,w,F,$),e.restore()}e.restore()}getSwordHudSprite(e){const t=this.objectSprites||{};return e&&t[e]?t[e]:null}drawHealth(e,t={}){if(!e||typeof this.gameState.getLives!="function"||typeof this.gameState.getMaxLives!="function")return;const a=this.gameState.getLives(),n=this.gameState.getMaxLives(),i=Number.isFinite(t.offsetX)?t.offsetX:0,r=Number.isFinite(t.offsetY)?t.offsetY:0,s=Number.isFinite(t.gap)?Math.max(0,t.gap):0,l=Number.isFinite(t.heartsPerRow)?Math.max(1,Math.floor(t.heartsPerRow)):5;let o=Number.isFinite(t.heartSize)&&t.heartSize>0?t.heartSize:this.canvasHelper.getTilePixelSize()/2;o=Math.max(4,o);const c=o/8;for(let d=0;d<n;d++){const u=d<a?this.healthIconDefinitions.full:this.healthIconDefinitions.empty,h=Math.floor(d/l),g=d%l,p=i+g*(o+s),f=r+h*(o+s);this.canvasHelper.drawSprite(e,u,p,f,c)}}getLevelLabel(){if(typeof this.gameState.getLevel!="function")return null;const e=this.gameState.getLevel();return Number.isFinite(e)?`LVL ${Math.max(1,Math.floor(e))}`:null}drawMiniMap(e,t,a,n,i){const l="rgba(255,255,255,0.08)",o="rgba(255,255,255,0.25)",c="#64b5f6";e.save(),e.translate(t,a),e.strokeStyle="rgba(255,255,255,0.12)",e.strokeRect(-2,-2,i+4,i+4);const d=this.gameState.getGame?.()||{},u=Math.max(1,d.world?.rows||1),h=Math.max(1,d.world?.cols||1),g=this.gameState.getPlayer?.()?.roomIndex??0,p=Math.floor(g/h),f=g%h,y=Math.max(1,Math.ceil(u/3)),T=Math.max(1,Math.ceil(h/3)),b=Math.min(2,Math.floor(p/y)),x=Math.min(2,Math.floor(f/T));for(let O=0;O<3;O++)for(let N=0;N<3;N++){const D=N*n,L=O*n;e.fillStyle=O===b&&N===x?c:l,e.fillRect(D,L,n,n),e.strokeStyle=o,e.strokeRect(D+.5,L+.5,n-1,n-1)}e.restore()}drawXpBar(e,t,a){const n=this.gameState.getExperienceToNext?.();if(!Number.isFinite(n)||n<=0)return;const i=24;e.strokeStyle="rgba(204, 204, 204, 0.25)",e.lineWidth=3,e.lineCap="round",e.beginPath(),e.moveTo(t,a),e.lineTo(t+i,a),e.stroke();const r=this.gameState.getExperience();if(r==0)return;const s=r*i/n;e.strokeStyle=this.paletteManager.getColor(13),e.lineWidth=3,e.lineCap="round",e.beginPath(),e.moveTo(t,a),e.lineTo(t+s,a),e.stroke()}setupHealthIcons(){const e=this.paletteManager.getColor(7),t=this.paletteManager.getColor(8);this.healthIconDefinitions={full:[[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,t,t,null,t,t,null],[null,t,t,t,t,t,e,t],[null,t,t,t,t,t,t,t],[null,null,t,t,t,t,t,null],[null,null,null,t,t,t,null,null],[null,null,null,null,t,null,null,null]],empty:[[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,t,t,null,t,t,null],[null,t,null,null,t,null,null,t],[null,t,null,null,null,null,null,t],[null,null,t,null,null,null,t,null],[null,null,null,t,null,t,null,null],[null,null,null,null,t,null,null,null]]}}}typeof window<"u"&&(window.RendererHudRenderer=We);class Kt{gameState;minimapElement;minimapCells;constructor(e){this.gameState=e,this.minimapElement=typeof document<"u"?document.getElementById("game-minimap"):null,this.minimapCells=null}drawMinimap(){if(!this.minimapElement)return;const e=this.gameState.getGame(),t=this.gameState.getPlayer?.()??{roomIndex:0},a=e.world?.rows||1,n=e.world?.cols||1,i=a*n;if(!this.minimapCells||this.minimapCells.length!==i){this.minimapElement.innerHTML="",this.minimapElement.style.gridTemplateColumns=`repeat(${n}, 1fr)`,this.minimapCells=[];for(let s=0;s<i;s++){const l=document.createElement("div");l.className="game-minimap-cell",this.minimapElement.appendChild(l),this.minimapCells.push(l)}}if(!this.minimapCells||!this.minimapCells.length)return;const r=Math.max(0,Math.min(this.minimapCells.length-1,t.roomIndex??0));for(let s=0;s<this.minimapCells.length;s++)this.minimapCells[s].classList.toggle("active",s===r)}}typeof window<"u"&&(window.RendererMinimapRenderer=Kt);class He extends ye{edgeFlash;combatIndicatorElement;combatIndicatorTimeout;screenFlashElement;screenFlashTimeout;constructor(e){super(e),this.edgeFlash={direction:"",expiresAt:0,color:"rgba(255,255,255,0.35)",tileX:null,tileY:null},this.combatIndicatorElement=typeof document<"u"?document.getElementById("combat-indicator"):null,this.combatIndicatorTimeout=null,this.screenFlashElement=typeof document<"u"?document.getElementById("screen-flash"):null,this.screenFlashTimeout=null,this.combatIndicatorElement&&(this.combatIndicatorElement.classList.remove("visible"),this.combatIndicatorElement.setAttribute("data-visible","false")),this.screenFlashElement&&this.screenFlashElement.classList.remove("visible")}showCombatIndicator(e,t={}){const a=this.combatIndicatorElement;if(!a)return;const n=Number.isFinite(t.duration)?Math.max(0,t.duration):600;this.combatIndicatorTimeout&&(clearTimeout(this.combatIndicatorTimeout),this.combatIndicatorTimeout=null),a.classList.remove("visible"),a.setAttribute("data-visible","false"),a.textContent="",a.offsetWidth,a.textContent=e??"",a.classList.add("visible"),a.setAttribute("data-visible","true"),this.combatIndicatorTimeout=setTimeout(()=>{a.classList.remove("visible"),a.setAttribute("data-visible","false"),a.textContent="",this.combatIndicatorTimeout=null},n)}flashScreen(e={}){const t=this.screenFlashElement;if(!t)return;const a=Number.isFinite(e.duration)?Math.max(16,e.duration):140;if(typeof e.intensity=="number"&&Number.isFinite(e.intensity)){const n=Math.max(0,Math.min(1,e.intensity));t.style.setProperty("--screen-flash-opacity",n.toString())}typeof e.color=="string"&&e.color.trim()&&t.style.setProperty("--screen-flash-color",e.color.trim()),this.screenFlashTimeout&&(clearTimeout(this.screenFlashTimeout),this.screenFlashTimeout=null),t.classList.remove("visible"),t.offsetWidth,t.classList.add("visible"),this.screenFlashTimeout=setTimeout(()=>{t.classList.remove("visible"),this.screenFlashTimeout=null},a)}flashEdge(e,t={}){if(typeof e!="string"||!e.trim())return;const a=e.trim().toLowerCase(),n=Number.isFinite(t.duration)?Math.max(32,t.duration):220,i=typeof t.color=="string"&&t.color.trim()?t.color.trim():"rgba(255,255,255,0.35)",r=o=>{if(!Number.isFinite(o))return null;const c=Math.floor(o);return Math.max(0,Math.min(7,c))},s=r(t.tileX),l=r(t.tileY);this.edgeFlash={direction:a,expiresAt:Date.now()+n,color:i,tileX:s,tileY:l}}drawEdgeFlash(e,t){const a=this.edgeFlash;if(!a?.direction)return;const n=Date.now();if(!Number.isFinite(a.expiresAt)||a.expiresAt<=n){this.edgeFlash.direction="";return}const i=Math.max(1,this.canvasHelper.getTilePixelSize()),r=Math.max(2,Math.floor(i/4)),s=i,l=(u,h=0)=>Number.isFinite(u)?Math.max(0,Math.min(7,Math.floor(u))):Math.max(0,Math.min(7,Math.floor(h))),o=this.gameState.getPlayer(),c=l(a.tileX,o?.x??0),d=l(a.tileY,o?.y??0);switch(e.save(),e.fillStyle=a.color||"rgba(255,255,255,0.35)",a.direction){case"left":e.fillRect(0,d*s,r,s);break;case"right":e.fillRect(t.width-r,d*s,r,s);break;case"up":e.fillRect(c*s,0,s,r);break;case"down":e.fillRect(c*s,t.height-r,s,r);break;default:e.fillRect(0,0,t.width,r);break}e.restore()}}typeof window<"u"&&(window.RendererEffectsManager=He);class Ke extends ye{transition;constructor(e){super(e),this.transition={active:!1}}isActive(){return!!this.transition?.active}start(e={}){const t=e.fromFrame,a=e.toFrame;if(!t||!a)return e.onComplete?.(),!1;const n=e.direction||"right",i=Number.isFinite(e.duration)?Math.max(120,e.duration):320,r=performance.now();return this.transition?.rafId&&window.cancelAnimationFrame(this.transition.rafId),this.removePlayerFromFrame(t,e.playerPath?.from),this.removePlayerFromFrame(a,e.playerPath?.to),this.transition={active:!0,direction:n,fromFrame:t,toFrame:a,duration:i,startTime:r,playerPath:e.playerPath||null,onComplete:e.onComplete??null,rafId:null},this.gameState.pauseGame("room-transition"),this.renderer.draw(),this.scheduleTick(),!0}scheduleTick(){const e=()=>{if(!this.isActive())return;if(this.getProgress()>=1){this.finish();return}this.renderer.draw(),this.transition.rafId=window.requestAnimationFrame(e)};this.transition.rafId=window.requestAnimationFrame(e)}getProgress(){if(!this.transition?.active)return 1;const t=performance.now()-this.transition.startTime;return Math.max(0,Math.min(1,t/this.transition.duration))}drawFrame(e,t){const a=this.transition;if(!a?.active)return;const n=t.width,i=t.height,r=this.getProgress(),s=r*n,l=r*i;let o=0,c=0,d=0,u=0;switch(a.direction){case"left":o=s,d=s-n;break;case"right":o=-s,d=n-s;break;case"up":c=l,u=l-i;break;case"down":c=-l,u=i-l;break;default:o=-s,d=n-s;break}e.save(),e.fillStyle=this.paletteManager.getColor(this.gameState.getCurrentRoom()?.bg??0),e.fillRect(0,0,n,i),e.drawImage(a.fromFrame,Math.round(o),Math.round(c)),e.drawImage(a.toFrame,Math.round(d),Math.round(u)),this.drawTransitionPlayer(e,t,r),e.restore(),r>=1&&this.finish()}removePlayerFromFrame(e,t){if(!e||!t)return;const a=e.getContext("2d");if(!a)return;const n=Math.max(1,Math.floor(e.width/8)),i=Math.max(0,Math.min(7,Math.floor(t.x??0))),r=Math.max(0,Math.min(7,Math.floor(t.y??0))),s=Number.isFinite(t.roomIndex)?t.roomIndex:this.gameState.getPlayer()?.roomIndex??0,l=this.gameState.getGame().rooms?.[s];a.fillStyle=this.paletteManager.getColor(l?.bg??0),a.fillRect(i*n,r*n,n,n),this.drawTileStackOnContext(a,s,i,r,n)}drawTransitionPlayer(e,t,a){const i=this.transition?.playerPath;if(!i?.from||!i?.to)return;const r=Math.max(1,Math.floor(t.width/8)),s=r/8,l=i.from.x+(i.to.x-i.from.x)*a,o=i.from.y+(i.to.y-i.from.y)*a;let c=this.spriteFactory.getPlayerSprite(),d=i.facingLeft;d===void 0&&(d=i.to.x<i.from.x),d&&(c=this.spriteFactory.turnSpriteHorizontally(c)),this.canvasHelper.drawSprite(e,c,l*r,o*r,s)}drawTileStackOnContext(e,t,a,n,i){const r=this.tileManager.getTileMap(t);if(!r)return;const s=a*i,l=n*i,o=r.ground?.[n]?.[a]??null;o!=null&&this.drawTilePixelsOnContext(e,o,s,l,i);const c=r.overlay?.[n]?.[a]??null;c!=null&&this.drawTilePixelsOnContext(e,c,s,l,i)}drawTilePixelsOnContext(e,t,a,n,i){const r=this.tileManager.getTilePixels(t);if(!r)return;const s=Math.max(1,Math.floor(i/8));for(let l=0;l<8;l++)for(let o=0;o<8;o++){const c=r[l]?.[o];!c||c==="transparent"||(e.fillStyle=c,e.fillRect(a+o*s,n+l*s,s,s))}}finish(){if(!this.transition?.active)return;this.transition.rafId&&window.cancelAnimationFrame(this.transition.rafId);const e=this.transition.onComplete;this.transition={active:!1},this.gameState.resumeGame("room-transition"),e?.()}}typeof window<"u"&&(window.RendererTransitionManager=Ke);const ae=(m,e="")=>TextResources.get(m,e)||e||"",Ye=(m,e={},t="")=>TextResources.format(m,e,t)||t||"";class $e extends ye{introData;pickupFx;pickupAnimationHandle;levelUpAnimationHandle;constructor(e){super(e),this.introData={title:"Tiny RPG Studio",author:""},this.pickupFx={id:null,startTime:0},this.pickupAnimationHandle=0,this.levelUpAnimationHandle=0}setIntroData(e={}){this.introData={title:e.title||"Tiny RPG Studio",author:e.author||""}}drawIntroOverlay(e,t){this.entityRenderer.cleanupEnemyLabels();const a=this.introData?.title||"Tiny RPG Studio",n=(this.introData?.author||"").trim(),i=t.width,r=t.height;e.save(),e.fillStyle="rgba(4, 6, 14, 0.78)",e.fillRect(0,0,i,r),e.textAlign="center",e.textBaseline="middle";const s=i/2,l=r/2;if(e.fillStyle="#FFFFFF",e.font=`${Math.max(12,Math.floor(r/12))}px monospace`,e.fillText(a,s,l-r*.12),n){const o=Ye("intro.byline",{author:n},`por ${n}`);e.fillStyle="rgba(255,255,255,0.8)",e.font=`${Math.max(10,Math.floor(r/18))}px monospace`,e.fillText(o,s,l)}if(this.renderer?.gameEngine?.canDismissIntroScreen){const o=Date.now()/500%2>1?.3:.95;e.fillStyle=`rgba(100, 181, 246, ${o.toFixed(2)})`;const c=ae("intro.startAdventure","Iniciar aventura");e.font=`${Math.max(9,Math.floor(r/20))}px monospace`,e.fillText(c,s,l+r*.18)}e.restore()}drawLevelUpOverlay(e,t){if(!e||!t)return;const a=this.gameState.getLevelUpOverlay?.();if(!a?.active)return;this.entityRenderer.cleanupEnemyLabels();const n=Array.isArray(a.choices)?a.choices:[],i=t.width,r=t.height,s=i/2,l=ae("skills.levelUpTitle","Level Up!"),o=Math.max(0,this.gameState.getPendingLevelUpChoices?.()||0),c=this.paletteManager.getColor(7)||"#FFF1E8",d=this.paletteManager.getColor(13)||c,u=Math.max(7,Math.floor(r/42)),h=Math.max(5,Math.floor(r/70)),g=this.getLevelUpCardLayout({width:i,height:r,choicesLength:n.length,hasPendingText:o>0,titleFont:u,pendingFont:h});e.save(),e.fillStyle="rgba(5, 7, 12, 0.88)",e.fillRect(0,0,i,r),e.textAlign="center",e.textBaseline="top",e.fillStyle=c;const p=Math.floor(r*.05);e.font=`${u}px "Press Start 2P", "VT323", monospace`;const f=p;e.fillText(l,s,f);let y=f+u+Math.floor(r*.02);if(o>0){const b=Ye("skills.pendingLabel",{value:o},"");b&&(e.font=`${h}px monospace`,e.fillStyle=d,e.fillText(b,s,y),y+=h+Math.floor(r*.02))}if(y+=Math.floor(r*.06),Math.max(1,n.length||1),!n.length){const b=ae("skills.allUnlocked","");if(b){e.font=`${Math.max(9,Math.floor(r/20))}px monospace`,e.fillStyle=d;const x=g?.cardArea?g.cardArea.cardYStart+g.cardArea.cardHeight/2:r/2;e.fillText(b,s,x)}e.restore();return}(g?.rects||[]).forEach((b,x)=>{this.drawLevelUpCard(e,{x:b.x,y:b.y,width:b.width,height:b.height,active:a.cursor===x,data:n[x]})}),e.restore()}getLevelUpCardLayout({width:e=0,height:t=0,choicesLength:a=0,hasPendingText:n=!1,titleFont:i=null,pendingFont:r=null}={}){const s=Math.max(1,a||1),l=Number.isFinite(i)?i:Math.max(8,Math.floor(t/34)),o=Number.isFinite(r)?r:Math.max(6,Math.floor(t/58));let u=Math.floor(t*.05)+l+Math.floor(t*.02);n&&(u+=o+Math.floor(t*.02)),u+=Math.floor(t*.06);const h=s===2?1:s,g=Math.max(1,Math.ceil(s/h)),p=Math.max(4,Math.floor(e*.025)),f=Math.max(5,Math.floor(e*.02)),y=Math.max(6,Math.floor(t*.018)),T=Math.max(70,e-p*2),b=Math.max(105,Math.min(Math.floor(T/h),Math.floor(e*.9))),x=b*h+f*Math.max(0,h-1),O=Math.round((e-x)/2),N=Math.round(Math.max(u+Math.floor(t*.01),t*.18)),D=Math.max(100,Math.floor((t-N-y*(g-1))/g)),L=Math.min(Math.max(100,D),Math.floor(t*.36));return{rects:Array.from({length:s},(v,I)=>{const k=Math.floor(I/h),w=I%h,F=Math.round(O+w*(b+f)),$=Math.round(N+k*(L+y));return{x:F,y:$,width:b,height:L}}),cardArea:{startX:O,cardYStart:N,cardWidth:b,cardHeight:L,gapX:f,gapY:y,perRow:h,rows:g}}}drawLevelUpCard(e,{x:t,y:a,width:n,height:i,active:r=!1,data:s=null}){e.save();const l=r?this.paletteManager.getColor(13)||"#64b5f6":this.paletteManager.getColor(6)||"#C2C3C7";e.fillStyle=r?"rgba(100, 181, 246, 0.16)":"rgba(0, 0, 0, 0.55)",e.strokeStyle=l,e.lineWidth=Math.max(2,Math.floor(n*.015)),e.shadowColor=r?"rgba(100, 181, 246, 0.4)":"rgba(0,0,0,0.35)",e.shadowBlur=r?Math.max(8,Math.floor(n*.05)):Math.max(4,Math.floor(n*.02)),e.fillRect(t,a,n,i),e.strokeRect(t+.5,a+.5,n-1,i-1);const o=Math.max(6,Math.floor(n*.05)),c=s?.nameKey?ae(s.nameKey,s.id||""):s?.id||"",d=s?.descriptionKey?ae(s.descriptionKey,""):"";e.shadowColor="transparent",e.fillStyle="#FFFFFF",e.textAlign="left",e.textBaseline="top";const u=Math.max(8,Math.floor(i/16));e.font=`${u}px "Press Start 2P", "VT323", monospace`,e.fillText(c,t+o,a+o),s?.icon&&(e.font=`${Math.max(8,Math.floor(i/14))}px monospace`,e.textAlign="right",e.fillText(s.icon,t+n-o,a+o+Math.max(0,Math.floor(i*.02))),e.textAlign="left"),e.font=`${Math.max(7,Math.floor(i/22))}px monospace`,e.fillStyle="rgba(255,255,255,0.9)";const h=Math.max(5,Math.floor(i*.06)),g=a+o+u+h,p=Math.max(8,Math.floor(i/20));this.drawWrappedText(e,d,t+o,g,n-o*2,p,2),e.restore()}drawWrappedText(e,t,a,n,i,r,s=null){if(!e||!t)return;const l=t.split(/\s+/).filter(Boolean);let o="",c=n,d=0;for(let u=0;u<l.length;u++){const h=l[u],g=o?`${o} ${h}`:h,f=e.measureText(g).width>i&&o,y=s&&d>=s-1;if(f||y){if(e.fillText(o,a,c),o=h,c+=r,d+=1,s&&d>=s){const b=`${l.slice(u).join(" ")}`.slice(0,32).trim(),x=b?`${b}...`:"...";e.fillText(x,a,c);return}}else o=g}o&&e.fillText(o,a,c)}drawLevelUpOverlayFull(e){e?.canvas&&this.drawLevelUpOverlay(e,{width:e.canvas.width,height:e.canvas.height})}drawLevelUpCelebrationOverlay(e,t){if(!e||!t)return;const a=this.gameState.getLevelUpCelebration?.();if(!a?.active){this.stopLevelUpAnimationLoop();return}this.ensureLevelUpAnimationLoop(),this.entityRenderer.cleanupEnemyLabels();const n=t.width,i=t.height,r=this.getNow(),s=Number.isFinite(a.startTime)?a.startTime:r,l=Math.max(0,(r-s)/1e3),o=Math.min(n,i),c=Math.floor(o*.62),d=this.easeOutBack(Math.min(1,l/.42)),u=1+Math.sin(l*5.2)*.035,h=Math.round(c*(.76+d*.22)*u),g=n/2,p=i/2,f=Math.sin(l*2.1)*6,y=Math.round(g-h/2),T=Math.round(p-h/2+f),b=this.paletteManager.getColor(13)||"#F8E7A1";e.save(),this.drawPickupFrame(e,{x:y,y:T,size:h,elapsed:l,accent:b}),e.restore();const x=ae("player.levelUp","Level Up!");e.save(),e.textAlign="center",e.textBaseline="middle";const O=Math.max(12,Math.floor(i/12));e.font=`${O}px "Press Start 2P", "VT323", monospace`,e.fillStyle="#FFF1E8",e.fillText(x,g,p+f),e.restore()}drawPickupOverlay(e,t){if(!e||!t)return;const a=this.gameState.getPickupOverlay?.();if(!a?.active){this.stopPickupAnimationLoop();return}this.ensurePickupAnimationLoop();const n=t.width,i=t.height,r=this.getNow(),s=this.ensurePickupFx(a,r),l=Math.max(0,(r-s.startTime)/1e3),o=Math.min(n,i),c=Math.floor(o*.62),d=this.easeOutBack(Math.min(1,l/.35)),u=1+Math.sin(l*5.2)*.04,h=Math.round(c*(.78+d*.22)*u),g=n/2,p=i/2,f=Math.sin(l*2.4)*6,y=Math.round(g-h/2),T=Math.round(p-h/2+f);e.save(),this.drawPickupFrame(e,{x:y,y:T,size:h,elapsed:l}),e.restore();const b=this.getPickupSprite(a);if(b){const x=Math.floor(h*.48),O=Math.max(2,Math.floor(x/8)),N=1+Math.sin(l*8.2)*.1,D=Math.max(2,Math.floor(O*N)),L=D*8,A=Math.round(g-L/2),v=Math.round(T+h/2-L/2);this.canvasHelper.drawSprite(e,b,A,v,D)}}drawPickupFrame(e,{x:t,y:a,size:n,elapsed:i=0,accent:r=null}){const s=r||this.paletteManager.getColor(2)||"#FFF1E8";e.save();const l=e.createLinearGradient(t,a,t+n,a+n);l.addColorStop(0,"rgba(7, 11, 26, 0.96)"),l.addColorStop(.55,"rgba(14, 25, 48, 0.96)"),l.addColorStop(1,"rgba(9, 14, 32, 0.96)"),e.fillStyle=l,e.fillRect(t,a,n,n),e.shadowColor="rgba(0, 0, 0, 0.45)",e.shadowBlur=Math.max(10,Math.floor(n*.08)),e.shadowOffsetY=Math.max(4,Math.floor(n*.02));const o=Math.max(2,Math.floor(n*.025));e.lineWidth=o,e.strokeStyle=`rgba(255, 241, 232, ${(.35+.25*Math.sin(i*4)).toFixed(2)})`,e.strokeRect(t+o/2,a+o/2,n-o,n-o);const c=Math.max(10,Math.floor(n*.08)),d=Math.max(6,Math.floor(n*.05));e.globalAlpha=.18,e.fillStyle=s,e.fillRect(t+c,a+c,n-c*2,d),e.fillRect(t+c,a+n-c-d,n-c*2,d),e.restore()}drawPickupRings(e,{centerX:t,centerY:a,size:n,elapsed:i=0}){e.save();const r=n*.35+Math.sin(i*3.2)*n*.05,s=Math.max(2,Math.floor(n*.02)),l=.35+.15*Math.sin(i*5.4);e.lineWidth=s,e.strokeStyle=`rgba(255, 241, 232, ${l.toFixed(2)})`;for(let o=0;o<2;o++)e.beginPath(),e.arc(t,a,r+o*n*.07,0,Math.PI*2),e.stroke();e.globalAlpha=.18,e.fillStyle="rgba(100, 181, 246, 0.5)",e.beginPath(),e.arc(t,a,r*.65,0,Math.PI*2),e.fill(),e.restore()}ensurePickupFx(e,t=this.getNow()){const a=`${e.spriteGroup||""}:${e.spriteType||""}:${e.name||""}`;return this.pickupFx.id!==a&&(this.pickupFx={id:a,startTime:t}),this.pickupFx}ensureLevelUpAnimationLoop(){if(this.levelUpAnimationHandle)return;const e=()=>{if(!this.gameState.isLevelUpCelebrationActive?.()){this.stopLevelUpAnimationLoop(),this.renderer?.draw?.();return}this.levelUpAnimationHandle=this.schedulePickupFrame(e),this.renderer?.draw?.()};this.levelUpAnimationHandle=this.schedulePickupFrame(e)}stopLevelUpAnimationLoop(){this.levelUpAnimationHandle&&(this.cancelPickupFrame(this.levelUpAnimationHandle),this.levelUpAnimationHandle=0)}ensurePickupAnimationLoop(){if(this.pickupAnimationHandle)return;const e=()=>{if(!this.gameState.isPickupOverlayActive?.()){this.stopPickupAnimationLoop();return}this.pickupAnimationHandle=this.schedulePickupFrame(e),this.renderer?.draw?.()};this.pickupAnimationHandle=this.schedulePickupFrame(e)}stopPickupAnimationLoop(){this.pickupAnimationHandle&&(this.cancelPickupFrame(this.pickupAnimationHandle),this.pickupAnimationHandle=0)}schedulePickupFrame(e){return typeof requestAnimationFrame=="function"?requestAnimationFrame(e):setTimeout(e,1e3/30)}cancelPickupFrame(e){typeof cancelAnimationFrame=="function"?cancelAnimationFrame(e):clearTimeout(e)}easeOutBack(e=0){const n=this.clamp(e,0,1);return 1+2.70158*Math.pow(n-1,3)+1.70158*Math.pow(n-1,2)}easeOutQuad(e=0){const t=this.clamp(e,0,1);return 1-(1-t)*(1-t)}clamp(e,t,a){return Math.max(t,Math.min(a,e))}getNow(){return typeof performance<"u"&&performance.now?performance.now():Date.now()}getPickupSprite(e=null){if(!e?.spriteGroup)return null;const t=this.spriteFactory;return t&&e.spriteGroup==="object"&&t.getObjectSprites()?.[e.spriteType]||null}drawGameOverScreen(){const e=this.ctx;if(!e)return;this.entityRenderer.cleanupEnemyLabels(),e.save(),e.fillStyle="#000000",e.fillRect(0,0,this.canvas.width,this.canvas.height);const a=this.gameState.getGameOverReason()==="victory",n=a&&this.gameState.getActiveEndingText()||"",i=a&&n.trim().length>0,r=Math.round(this.canvas.width/2)+.5,s=Math.round(this.canvas.height/2)+.5;if(i){e.save();const h=Math.floor(this.canvas.width*.08),g=Math.max(32,this.canvas.width-h*2),p=Math.max(7,Math.floor(this.canvas.height/30)),f=Math.round(p*1.4),y=`${p}px "Press Start 2P", "VT323", monospace`;e.font=y,e.textAlign="center",e.textBaseline="top",e.fillStyle="#F8FAFC";const b=(L=>{const A=L.replace(/\r\n/g,`
`).split(/\n+/).map(I=>I.trim()).filter(Boolean);if(!A.length)return[];const v=[];return A.forEach((I,k)=>{const w=I.split(/\s+/);let F="";w.forEach($=>{const H=F?`${F} ${$}`:$;e.measureText(H).width>g&&F?(v.push(F),F=$):F=H}),F&&v.push(F),k<A.length-1&&v.push("")}),v.length?v:[""]})(n),x=b.length*f,O=Math.max(f,Math.floor(p*1.2));let N=Math.max(h,Math.floor(s-x-O));Number.isFinite(N)||(N=h);let D=N;b.forEach(L=>{if(L.trim().length){const A=Math.round(D)+.5;e.fillText(L,r,A)}D+=f}),e.restore()}e.fillStyle="#FFFFFF";let l=Math.max(5,Math.floor(this.canvas.height/22));const o=`${l}px "Press Start 2P", monospace`;if(e.font=o,e.textAlign="center",e.textBaseline="middle",e.fillText(a?"The End":"Game Over",r,s),!this.gameState.canResetAfterGameOver){e.restore();return}e.save();const c=Date.now()/500%2>1?.3:.95;e.fillStyle=`rgba(100, 181, 246, ${c.toFixed(2)})`,l=Math.max(4,Math.floor(this.canvas.height/26)),e.font=`${l}px "Press Start 2P", monospace`,e.textAlign="center",e.textBaseline="middle";const d=Math.round(this.canvas.height/1.5)+.5,u=this.gameState.hasNecromancerReviveReady?.()?ae("skills.necromancer.revivePrompt",""):ae(a?"gameOver.retryVictory":"gameOver.retryDefeat","");e.fillText(u,r,d),e.restore(),e.restore()}}typeof window<"u"&&(window.RendererOverlayRenderer=$e);let Yt=class{canvas;ctx;hudBarHeight;inventoryBarHeight;totalHudHeight;gameplayHeight;gameplayOffsetY;inventoryOffsetY;gameplayCanvasBounds;gameState;gameEngine;tileManager;npcManager;paletteManager;spriteFactory;canvasHelper;tileRenderer;entityRenderer;dialogRenderer;hudRenderer;effectsManager;transitionManager;overlayRenderer;playerSprite;npcSprites;enemySprites;enemySprite;objectSprites;drawIconIdNextFrame;timeIconOverPlayer;tileAnimationInterval;tileAnimationTimer;constructor(e,t,a,n,i=null){this.canvas=e;const r=Math.max(8,Math.floor(this.canvas.width/8));this.hudBarHeight=Math.max(28,Math.round(r*1.75)),this.inventoryBarHeight=Math.max(40,Math.round(r*2)),this.totalHudHeight=this.hudBarHeight+this.inventoryBarHeight,this.gameplayHeight=r*8;const s=this.gameplayHeight+this.totalHudHeight;this.canvas.height!==s&&(this.canvas.height=s),this.ctx=e.getContext("2d"),this.ctx&&(this.ctx.imageSmoothingEnabled=!1),this.gameplayOffsetY=this.hudBarHeight,this.inventoryOffsetY=this.hudBarHeight+this.gameplayHeight,this.gameplayCanvasBounds={width:this.canvas.width,height:this.gameplayHeight},this.gameState=t,this.gameEngine=i,this.tileManager=a,this.npcManager=n,this.paletteManager=new Ve(t),this.spriteFactory=new _e(this.paletteManager,t),this.canvasHelper=new Be(e,this.ctx,a),this.tileRenderer=new Ge(t,a,this.paletteManager,this.canvasHelper),this.entityRenderer=new Ue(t,a,this.spriteFactory,this.canvasHelper,this.paletteManager),this.entityRenderer.setViewportOffset(this.gameplayOffsetY),this.dialogRenderer=new ze(t,this.paletteManager),this.hudRenderer=new We(t,this.entityRenderer,this.paletteManager),this.effectsManager=new He(this),this.transitionManager=new Ke(this),this.overlayRenderer=new $e(this),this.playerSprite=this.spriteFactory.getPlayerSprite(),this.npcSprites=this.spriteFactory.getNpcSprites(),this.enemySprites=this.spriteFactory.getEnemySprites(),this.enemySprite=this.spriteFactory.getEnemySprite(),this.objectSprites=this.spriteFactory.getObjectSprites(),this.drawIconIdNextFrame="",this.timeIconOverPlayer=2e3,this.tileAnimationInterval=320,this.tileAnimationTimer=null,this.startTileAnimationLoop()}draw(){const e=this.ctx;if(!e)return;e.clearRect(0,0,this.canvas.width,this.canvas.height);const t=this.gameplayCanvasBounds,a=this.isIntroOverlayActive(),n=this.gameState.isPickupOverlayActive?.(),i=this.gameState.isLevelUpCelebrationActive?.(),r=this.gameState.isLevelUpOverlayActive?.();e.save(),e.translate(0,this.gameplayOffsetY),this.transitionManager.isActive()?this.transitionManager.drawFrame(e,t):(this.tileRenderer.clearCanvas(e,t),this.tileRenderer.drawBackground(e,t),this.tileRenderer.drawTiles(e,t),this.tileRenderer.drawWalls(e),this.effectsManager.drawEdgeFlash(e,t),!a&&!this.gameState.isGameOver()&&(this.entityRenderer.drawObjects(e),this.entityRenderer.drawItems(e),this.entityRenderer.drawNPCs(e),this.entityRenderer.drawEnemies(e),this.entityRenderer.drawPlayer(e),this.drawIconIdNextFrame&&this.drawTileIconOnPlayer(e,this.drawIconIdNextFrame),!n&&!r&&!i&&this.dialogRenderer.drawDialog(e,t))),a?this.overlayRenderer.drawIntroOverlay(e,t):i?this.overlayRenderer.drawLevelUpCelebrationOverlay(e,t):n&&this.overlayRenderer.drawPickupOverlay(e,t),e.restore();const s={width:this.canvas.width,height:this.hudBarHeight},l={x:0,y:this.inventoryOffsetY,width:this.canvas.width,height:this.inventoryBarHeight};if(a?(e.save(),e.fillStyle="#000000",e.fillRect(0,0,s.width,s.height),e.fillRect(l.x,l.y,l.width,l.height),e.restore()):r||(this.hudRenderer.drawHUD(e,s),this.hudRenderer.drawInventory(e,l)),this.gameState.isGameOver()){this.overlayRenderer.drawGameOverScreen();return}r&&this.overlayRenderer.drawLevelUpOverlayFull(e)}getTilePixelSize(){return this.canvasHelper.getTilePixelSize()}getColor(e){return this.paletteManager.getColor(e)}setIconOverPlayer(e){this.drawIconIdNextFrame=e,setTimeout(()=>{this.drawIconIdNextFrame=""},this.timeIconOverPlayer)}drawCustomTile(e,t,a,n){this.canvasHelper.drawCustomTile(e,t,a,n)}drawSprite(e,t,a,n,i){this.canvasHelper.drawSprite(e,t,a,n,i)}drawTileOnCanvas(e,t){this.canvasHelper.drawTileOnCanvas(e,t)}drawTileIconOnPlayer(e,t){this.entityRenderer.drawTileIconOnPlayer(e,t)}drawTilePreviewAt(e,t,a,n,i){this.canvasHelper.drawTilePreview(e,t,a,n,i)}setIntroData(e={}){this.overlayRenderer.setIntroData(e)}isIntroOverlayActive(){return!!this.gameEngine?.isIntroVisible?.()}captureGameplayFrame(){if(typeof document>"u"||!this.canvas)return null;const e=this.gameplayCanvasBounds.width,t=this.gameplayCanvasBounds.height,a=document.createElement("canvas");a.width=e,a.height=t;const n=a.getContext("2d");return n?(n.drawImage(this.canvas,0,this.gameplayOffsetY,e,t,0,0,e,t),a):null}isRoomTransitionActive(){return this.transitionManager.isActive()}startRoomTransition(e={}){return this.transitionManager.start(e)}flashEdge(e,t={}){this.effectsManager.flashEdge(e,t)}startTileAnimationLoop(){this.tileAnimationTimer&&(clearInterval(this.tileAnimationTimer),this.tileAnimationTimer=null);const e=Math.max(60,this.tileAnimationInterval||0);this.tileAnimationTimer=setInterval(()=>this.tickTileAnimation(),e)}tickTileAnimation(){if(this.gameState.isEditorModeActive?.())return;const e=this.tileManager;if(e.getAnimationFrameCount()<=1)return;const a=e.advanceAnimationFrame();this.draw();try{window.dispatchEvent(new CustomEvent("tile-animation-frame",{detail:{frameIndex:a}}))}catch{window.dispatchEvent(new Event("tile-animation-frame"))}}showCombatIndicator(e,t={}){this.effectsManager.showCombatIndicator(e,t)}flashScreen(e={}){this.effectsManager.flashScreen(e)}drawObjectSprite(e,t,a,n,i){const s=this.spriteFactory.getObjectSprites()?.[t];if(!s)return;const l=i||this.canvasHelper.getTilePixelSize()/8;this.canvasHelper.drawSprite(e,s,a,n,l)}buildPlayerSprite(){return this.playerSprite=this.spriteFactory.getPlayerSprite(),this.playerSprite}buildNpcSprites(){return this.npcSprites=this.spriteFactory.getNpcSprites(),this.npcSprites}buildEnemySprite(){return this.enemySprites=this.spriteFactory.getEnemySprites(),this.enemySprite=this.spriteFactory.getEnemySprite(),this.enemySprite}buildObjectSprites(){return this.objectSprites=this.spriteFactory.getObjectSprites(),this.objectSprites}};typeof window<"u"&&(window.Renderer=Yt);let $t=class se{constructor(e,t=8){this.game=e,this.defaultRoomSize=t}setGame(e){this.game=e}get roomSize(){return this.game?.roomSize??this.defaultRoomSize}static createEmptyRoom(e,t=0,a=1){const n=t%a,i=Math.floor(t/a);return{size:e,bg:0,tiles:Array.from({length:e},()=>Array(e).fill(0)),walls:Array.from({length:e},()=>Array(e).fill(!1)),worldX:n,worldY:i}}createEmptyRoom(e=this.roomSize,t=0,a=1){return se.createEmptyRoom(e,t,a)}static createWorldRooms(e,t,a){return Array.from({length:e*t},(n,i)=>se.createEmptyRoom(a,i,t))}createWorldRooms(e,t,a=this.roomSize){return se.createWorldRooms(e,t,a)}static createEmptyTileMap(e){return{ground:Array.from({length:e},()=>Array(e).fill(null)),overlay:Array.from({length:e},()=>Array(e).fill(null))}}createEmptyTileMap(e=this.roomSize){return se.createEmptyTileMap(e)}normalizeRooms(e,t,a){const n=this.roomSize,i=Array.from({length:t},(r,s)=>se.createEmptyRoom(n,s,a));return Array.isArray(e)&&e.forEach((r,s)=>{if(s>=i.length)return;const l=i[s];l.bg=typeof r?.bg=="number"?r.bg:l.bg,l.tiles=Array.isArray(r?.tiles)?r.tiles.map((o,c)=>Array.from({length:n},(d,u)=>{const h=o?.[u];return Number.isFinite(h)?h:l.tiles[c][u]})):l.tiles,l.walls=Array.isArray(r?.walls)?r.walls.map((o,c)=>Array.from({length:n},(d,u)=>!!o?.[u])):l.walls}),i}normalizeTileMaps(e,t){const a=this.roomSize,n=Array.from({length:t},()=>se.createEmptyTileMap(a));if(!e)return n;const i=(r,s)=>{r.ground=Array.from({length:a},(l,o)=>Array.from({length:a},(c,d)=>s?.ground?.[o]?.[d]??null)),r.overlay=Array.from({length:a},(l,o)=>Array.from({length:a},(c,d)=>s?.overlay?.[o]?.[d]??null))};return Array.isArray(e)?(e.forEach((r,s)=>{s>=n.length||(r?.ground||r?.overlay)&&i(n[s],r)}),n):((e?.ground||e?.overlay)&&i(n[0],e),n)}clampRoomIndex(e){const t=this.game?.rooms??[],a=Math.max(0,t.length-1),n=Number(e);return Number.isFinite(n)?Math.max(0,Math.min(a,Math.floor(n))):0}clampCoordinate(e){const t=this.roomSize,a=Number(e);return Number.isFinite(a)?Math.max(0,Math.min(t-1,Math.floor(a))):0}getWorldRows(){return this.game?.world?.rows||1}getWorldCols(){return this.game?.world?.cols||1}getRoomCoords(e){const t=this.getWorldCols(),a=Math.floor(e/t),n=e%t;return{row:a,col:n}}getRoomIndex(e,t){const a=this.getWorldRows(),n=this.getWorldCols();return e<0||e>=a||t<0||t>=n?null:e*n+t}};typeof window<"u"&&(window.StateWorldManager=$t);let Xt=class{constructor(e){this.state=e,this.resetRuntime()}setState(e){this.state=e,this.ensureRuntime(),this.ensureOverlay()}ensureRuntime(){if(!this.state)return{owned:[],bonusMaxLives:0,xpBoost:0,pendingSelections:0,necromancerCharges:0,pendingManualRevive:!1,recentRevive:!1,carryoverSkills:[],currentChoicePool:[],pendingLevelQueue:[]};this.state.skillRuntime||(this.state.skillRuntime={});const e=this.state.skillRuntime;return e.owned=Array.isArray(e.owned)?Array.from(new Set(e.owned.filter(t=>typeof t=="string"&&t))):[],e.bonusMaxLives=Number.isFinite(e.bonusMaxLives)?Math.max(0,Math.floor(e.bonusMaxLives)):0,e.xpBoost=Number.isFinite(e.xpBoost)?Math.max(0,e.xpBoost):0,e.pendingSelections=Number.isFinite(e.pendingSelections)?Math.max(0,Math.floor(e.pendingSelections)):0,e.necromancerCharges=Number.isFinite(e.necromancerCharges)?Math.max(0,Math.floor(e.necromancerCharges)):0,e.pendingManualRevive=!!e.pendingManualRevive,e.recentRevive=!!e.recentRevive,e.carryoverSkills=Array.isArray(e.carryoverSkills)?Array.from(new Set(e.carryoverSkills.filter(t=>typeof t=="string"&&t))):[],e.currentChoicePool=Array.isArray(e.currentChoicePool)?Array.from(new Set(e.currentChoicePool.filter(t=>typeof t=="string"&&t))):[],e.pendingLevelQueue=Array.isArray(e.pendingLevelQueue)?e.pendingLevelQueue.map(t=>Number.isFinite(t)?Math.max(1,Math.floor(t)):null).filter(t=>t!==null):[],e.pendingSelections=e.pendingLevelQueue.length,e}ensureOverlay(){if(!this.state)return{active:!1,choices:[],cursor:0};this.state.levelUpOverlay||(this.state.levelUpOverlay={});const e=this.state.levelUpOverlay;return e.active=!!e.active,e.choices=Array.isArray(e.choices)?e.choices:[],e.cursor=Number.isFinite(e.cursor)?Math.max(0,Math.floor(e.cursor)):0,e}resetRuntime(){const e=this.ensureRuntime();e.owned=[],e.bonusMaxLives=0,e.xpBoost=0,e.pendingSelections=0,e.necromancerCharges=0,e.pendingManualRevive=!1,e.recentRevive=!1,e.carryoverSkills=[],e.currentChoicePool=[],e.pendingLevelQueue=[],this.resetOverlay()}resetOverlay(){const e=this.ensureOverlay();e.active=!1,e.choices=[],e.cursor=0}getOwnedSkills(){return this.ensureRuntime().owned.slice()}hasSkill(e){return e?this.ensureRuntime().owned.includes(e):!1}addSkill(e){const t=this.ensureRuntime(),a=SkillDefinitions.getById(e);return a?(t.owned.includes(e)||(t.owned.push(e),this.applyImmediateEffects(a)),a):null}applyImmediateEffects(e){const t=this.ensureRuntime();switch(e.id){case"xp-boost":t.xpBoost=.5;break;case"necromancer":t.necromancerCharges=Math.min(1,(t.necromancerCharges||0)+1);break}}getBonusMaxLives(){const e=this.ensureRuntime();return Math.max(0,e.bonusMaxLives||0)}addBonusMaxLife(e=1){const t=this.ensureRuntime(),a=Number.isFinite(e)?Math.max(0,Math.floor(e)):0;return a<=0||(t.bonusMaxLives=Math.max(0,(t.bonusMaxLives||0)+a)),t.bonusMaxLives}getXpBoost(){const e=this.ensureRuntime();return Math.max(0,Number(e.xpBoost)||0)}queueLevelUps(e=1,t=null){const a=this.ensureRuntime(),n=Number.isFinite(e)?Math.max(0,Math.floor(e)):0;if(n<=0)return a.pendingSelections=a.pendingLevelQueue.length,a.pendingSelections;const i=Number.isFinite(this.state?.player?.level)?Math.max(1,Math.floor(this.state.player.level)):1,r=Number.isFinite(t)?Math.max(1,Math.floor(t)):null,s=[];if(r!==null){const l=Math.max(1,r-n+1);for(let o=l;o<=r;o++)s.push(o)}else for(let l=0;l<n;l++)s.push(i+l);return s.forEach(l=>{l%2===0&&a.pendingLevelQueue.push(l)}),a.pendingSelections=a.pendingLevelQueue.length,a.pendingSelections}getPendingSelections(){const e=this.ensureRuntime();return e.pendingSelections=e.pendingLevelQueue.length,e.pendingSelections}hasPendingSelections(){return this.getPendingSelections()>0}startLevelSelection(){if(!this.hasPendingSelections())return null;const e=this.ensureOverlay();if(e.active)return e;const t=this.ensureRuntime(),a=Math.max(1,t.pendingLevelQueue.length||1);for(let n=0;n<a;n++){const i=t.pendingLevelQueue.shift()||(Number.isFinite(this.state?.player?.level)?Math.max(1,Math.floor(this.state.player.level)):1),r=this.pickChoices(2,i);if(r.length)return e.active=!0,e.choices=r,e.cursor=0,t.pendingSelections=t.pendingLevelQueue.length,e}return t.pendingSelections=t.pendingLevelQueue.length,t.carryoverSkills=[],t.currentChoicePool=[],null}pickChoices(e=2,t=null){const a=this.ensureRuntime(),n=Number.isFinite(t)?Math.max(1,Math.floor(t)):Number.isFinite(this.state?.player?.level)?Math.max(1,Math.floor(this.state.player.level)):1,i=SkillDefinitions.buildQueueForLevel(n,a.carryoverSkills,a.owned);if(a.currentChoicePool=i,!i.length)return a.carryoverSkills=[],[];const r=Math.max(1,Math.min(e,i.length));return i.slice(0,r).map(l=>SkillDefinitions.getById(l)).filter(Boolean)}moveCursor(e=0){const t=this.ensureOverlay();if(!t.active)return t.cursor;const a=t.choices.length;if(a<=1)return t.cursor=0,t.cursor;const n=Number.isFinite(e)?Math.floor(e):0,i=(t.cursor+n+a)%a;return t.cursor=i,t.cursor}completeSelection(e=null){const t=this.ensureOverlay();if(!t.active)return null;const a=Number.isFinite(e)?Math.max(0,Math.min(t.choices.length-1,Math.floor(e))):t.cursor,n=t.choices[a]||null;t.active=!1,t.choices=[],t.cursor=0,n&&this.addSkill(n.id);const i=this.ensureRuntime(),r=n?.id||null,s=Array.isArray(i.currentChoicePool)?i.currentChoicePool:[];return i.carryoverSkills=s.filter(l=>l&&l!==r&&!i.owned.includes(l)),i.currentChoicePool=[],i.pendingSelections=i.pendingLevelQueue.length,n}isOverlayActive(){return!!this.ensureOverlay().active}getOverlay(){return this.ensureOverlay()}attemptRevive(e=null){if(!e||!this.hasSkill("necromancer"))return!1;const t=this.ensureRuntime();return t.necromancerCharges<=0||(t.pendingManualRevive=!0,t.recentRevive=!1),!1}consumeRecentReviveFlag(){const e=this.ensureRuntime();return e.recentRevive=!1,!1}hasPendingManualRevive(){const e=this.ensureRuntime();return this.hasSkill("necromancer")&&e.necromancerCharges>0&&e.pendingManualRevive}consumeManualRevive(){const e=this.ensureRuntime();return this.hasPendingManualRevive()?(e.necromancerCharges=Math.max(0,e.necromancerCharges-1),e.pendingManualRevive=!1,e.recentRevive=!1,!0):!1}clearManualReviveFlag(){const e=this.ensureRuntime();e.pendingManualRevive=!1}};typeof window<"u"&&(window.StateSkillManager=Xt);let qt=class{constructor(e,t,a=null){this.state=e,this.worldManager=t,this.skillManager=a,this.maxLevel=10,this.baseMaxLives=3,this.experienceBase=6,this.experienceGrowth=1.35,this.maxKeys=9,this.roomChangeDamageCooldown=1e3}setState(e){this.state=e}setWorldManager(e){this.worldManager=e}setSkillManager(e){this.skillManager=e}get player(){return this.state?.player}getPlayer(){return this.player}setPosition(e,t,a=null){this.player&&(this.player.lastX=this.player.x,this.player.x=this.worldManager.clampCoordinate(e),this.player.y=this.worldManager.clampCoordinate(t),a!=null&&(this.player.roomIndex=this.worldManager.clampRoomIndex(a)),this.ensurePlayerStats())}reset(e){const t=e||{x:1,y:1,roomIndex:0};this.setPosition(t.x,t.y,t.roomIndex),this.player&&(this.player.level=1,this.player.maxLives=this.calculateMaxLives(this.player.level),this.player.currentLives=this.player.maxLives,this.player.lives=this.player.currentLives,this.player.keys=0,this.player.experience=0,this.player.damageShield=0,this.player.damageShieldMax=0,this.player.swordType=null,this.player.lastDamageReduction=0,this.player.godMode=!1)}setLevel(e=1){if(!this.player)return 1;const t=this.clampLevel(e);return this.player.level=t,this.player.experience=0,this.player.maxLives=this.calculateMaxLives(t),this.player.currentLives=this.player.maxLives,this.player.lives=this.player.currentLives,this.ensurePlayerStats(),t}setGodMode(e=!1){return this.player?(this.player.godMode=!!e,this.player.godMode&&(this.player.currentLives=this.player.maxLives,this.player.lives=this.player.currentLives),this.player.godMode):!1}isGodMode(){return!!this.player?.godMode}addKeys(e=1){if(!this.player)return 0;const t=Number(e);if(!Number.isFinite(t))return this.player.keys;const a=Math.floor(t),n=Math.max(0,this.player.keys+a);return this.player.keys=Math.min(this.maxKeys,n),this.player.keys}consumeKey(){return!this.player||this.player.keys<=0?!1:(this.player.keys-=1,!0)}getKeys(){return this.player?.keys??0}getMaxKeys(){return this.maxKeys}damage(e=1){if(!this.player)return 0;this.ensurePlayerStats();let t=Number.isFinite(e)?Math.max(0,e):1;if(this.skillManager?.hasSkill?.("iron-body")&&(t=Math.max(0,t-1)),this.player.godMode)return this.player.lastDamageReduction=t,this.player.currentLives=this.player.maxLives,this.player.lives=this.player.currentLives,this.player.currentLives;const a=Math.max(0,Number(this.player.damageShield)||0),n=Math.min(a,t),i=Math.max(0,t-n);return this.player.damageShield=Math.max(0,a-n),this.player.damageShield===0&&(this.player.damageShieldMax=0,this.player.swordType=null),this.player.lastDamageReduction=n,this.player.currentLives=Math.max(0,this.player.currentLives-i),this.player.currentLives<=0&&this.skillManager?.attemptRevive?.(this.player),this.player.lives=this.player.currentLives,this.player.currentLives}isOnDamageCooldown(){const e=Date.now();return this.player.lastRoomChangeTime&&e-this.player.lastRoomChangeTime<this.roomChangeDamageCooldown}addDamageShield(e=1,t=null){if(!this.player)return 0;const a=Number.isFinite(e)?Math.max(0,Math.floor(e)):0;if(a<=0)return this.player.damageShield??0;this.ensurePlayerStats();const n=Math.max(0,Number(this.player.damageShield)||0)+a;return this.player.damageShield=n,this.player.damageShieldMax=Math.max(n,a,Number(this.player.damageShieldMax)||0),t&&(this.player.swordType=t),n}getDamageShield(){return Math.max(0,Number(this.player?.damageShield)||0)}getDamageShieldMax(){return Math.max(0,Number(this.player?.damageShieldMax)||0)}getSwordType(){return typeof this.player?.swordType=="string"?this.player.swordType:null}consumeLastDamageReduction(){if(!this.player)return 0;this.ensurePlayerStats();const e=Math.max(0,Number(this.player.lastDamageReduction)||0);return this.player.lastDamageReduction=0,e}gainLives(e=1){if(!this.player)return 0;this.ensurePlayerStats();const t=Number.isFinite(e)?Math.max(0,Math.floor(e)):0;return t<=0?this.player.currentLives:(this.player.currentLives=Math.min(this.player.maxLives,this.player.currentLives+t),this.player.lives=this.player.currentLives,this.player.currentLives)}getLives(){return this.ensurePlayerStats(),this.player?.currentLives??0}getMaxLives(){return this.ensurePlayerStats(),this.player?.maxLives??0}getLevel(){return this.ensurePlayerStats(),this.player?.level??1}calculateMaxLives(e){const t=Number.isFinite(e)?Math.floor(e):1,a=this.skillManager?.getBonusMaxLives?.()||0;return this.baseMaxLives+Math.max(0,t-1)+a}clampLevel(e){const t=Number.isFinite(e)?Math.floor(e):1;return Math.max(1,Math.min(this.maxLevel,t))}ensurePlayerStats(){if(!this.player)return;const e=this.clampLevel(this.player.level??1);this.player.level=e;const t=this.calculateMaxLives(e);this.player.maxLives=t;const a=Number.isFinite(this.player.currentLives)?Math.floor(this.player.currentLives):this.player.maxLives;this.player.currentLives=Math.max(0,Math.min(this.player.maxLives,a)),this.player.lives=this.player.currentLives;const n=Number.isFinite(this.player.experience)?Math.max(0,Math.floor(this.player.experience)):0;if(e>=this.maxLevel)this.player.experience=0;else{const i=this.getExperienceForNextLevel(e);this.player.experience=Math.min(n,Math.max(0,i-1))}Number.isFinite(this.player.damageShield)?this.player.damageShield=Math.max(0,Math.floor(this.player.damageShield)):this.player.damageShield=0,Number.isFinite(this.player.damageShieldMax)?this.player.damageShieldMax=Math.max(this.player.damageShield,Math.floor(this.player.damageShieldMax)):this.player.damageShieldMax=0,typeof this.player.swordType!="string"&&(this.player.swordType=null),this.player.damageShield<=0&&(this.player.swordType=null),Number.isFinite(this.player.lastDamageReduction)||(this.player.lastDamageReduction=0),this.player.godMode=!!this.player.godMode}healToFull(){return this.player?(this.ensurePlayerStats(),this.player.currentLives=this.player.maxLives,this.player.lives=this.player.currentLives,this.player.currentLives):this.getLives()}getExperience(){return this.ensurePlayerStats(),this.player?.experience??0}getExperienceForNextLevel(e){const t=this.clampLevel(e);if(t>=this.maxLevel)return 0;const a=Math.floor(this.experienceBase*Math.pow(this.experienceGrowth,t-1));return Math.max(5,a)}getExperienceToNext(){this.ensurePlayerStats();const e=this.player?.level??1;return this.getExperienceForNextLevel(e)}addExperience(e=0){if(!this.player)return{leveledUp:!1,levelsGained:0,level:0,experience:0,experienceToNext:0,currentLives:0,maxLives:0};this.ensurePlayerStats();let t=Number.isFinite(e)?Math.max(0,Math.floor(e)):0;if(this.skillManager?.hasSkill?.("xp-boost")){const i=this.skillManager?.getXpBoost?.()??0;i>0&&(t=Math.floor(t*(1+i)))}if(t<=0||this.player.level>=this.maxLevel)return this.player.level>=this.maxLevel&&(this.player.experience=0),{leveledUp:!1,levelsGained:0,level:this.player.level,experience:this.player.experience,experienceToNext:this.getExperienceToNext(),currentLives:this.player.currentLives,maxLives:this.player.maxLives};let a=this.player.experience+t,n=0;for(;this.player.level<this.maxLevel;){const i=this.getExperienceForNextLevel(this.player.level);if(a<i)break;a-=i,this.player.level+=1,n+=1,this.player.maxLives=this.calculateMaxLives(this.player.level),this.player.currentLives=this.player.maxLives,this.player.lives=this.player.currentLives}return this.player.level>=this.maxLevel?(this.player.level=this.maxLevel,this.player.experience=0):this.player.experience=a,{leveledUp:n>0,levelsGained:n,level:this.player.level,experience:this.player.experience,experienceToNext:this.getExperienceToNext(),currentLives:this.player.currentLives,maxLives:this.player.maxLives}}handleEnemyDefeated(e=0){return this.addExperience(e)}};typeof window<"u"&&(window.StatePlayerManager=qt);let Jt=class{constructor(e){this.state=e}setState(e){this.state=e}get dialog(){return this.state?.dialog}getDialog(){return this.dialog}setDialog(e,t="",a=null){const n=this.dialog;if(n){if(!e){n.active=!1,n.text="",n.page=1,n.maxPages=1,n.meta=null;return}n.active=!0,n.text=t,n.page=1,n.maxPages=1,n.meta=a||null}}setPage(e){const t=this.dialog;if(!t)return;const a=Number(e);if(!Number.isFinite(a))return;const n=Math.max(1,t.maxPages||1),i=Math.min(Math.max(1,Math.floor(a)),n);t.page=i}reset(){this.setDialog(!1)}};typeof window<"u"&&(window.StateDialogManager=Jt);const Zt=(m,e="")=>TextResources.get(m,e)||e||m||"",ee=(m,e,t,a,n)=>Object.freeze({id:m,order:e,nameKey:t,fallbackName:a,color:n}),Xe=Object.freeze([ee("var-1",1,"variables.names.var1","","#000000"),ee("var-2",2,"variables.names.var2","","#1D2B53"),ee("var-3",3,"variables.names.var3","","#7E2553"),ee("var-4",4,"variables.names.var4","","#008751"),ee("var-5",5,"variables.names.var5","","#AB5236"),ee("var-6",6,"variables.names.var6","","#5F574F"),ee("var-7",7,"variables.names.var7","","#29ADFF"),ee("var-8",8,"variables.names.var8","","#FF77A8"),ee("var-9",9,"variables.names.var9","","#FFFF27")]);let Qt=class{constructor(e,t,a=Xe){this.game=e,this.state=t,this.presets=a}setGame(e){this.game=e}setState(e){this.state=e}ensureDefaultVariables(){return this.game?(this.game.variables=this.normalizeVariables(this.game.variables),this.game.variables):[]}resetRuntime(){return this.state?(this.state.variables=this.cloneVariables(this.game?.variables),this.state.variables):[]}cloneVariables(e){return(e||[]).map(t=>({id:t.id,order:t.order,name:t.name,color:t.color,value:!!t.value}))}normalizeVariables(e){const t=Array.isArray(e)?e:[],a=new Map(t.map(n=>[n?.id,n]));return this.presets.map(n=>{const i=a.get(n.id)||{};return{id:n.id,order:n.order,name:typeof i.name=="string"&&i.name.trim()?i.name.trim():this.getPresetDefaultName(n),color:typeof i.color=="string"&&i.color.trim()?i.color.trim():n.color,value:!!i.value}})}getVariableDefinitions(){return this.game?.variables??[]}getVariables(){return this.state?.variables??[]}normalizeVariableId(e){return typeof e!="string"?null:new Set(["skill:bard"]).has(e)||this.getVariableDefinitions().some(a=>a.id===e)?e:null}getVariable(e){return e&&this.getVariables().find(t=>t.id===e)||null}isVariableOn(e){const t=this.getVariable(e);return t?!!t.value:!1}setVariableValue(e,t,a=!1){let n=!1;return this.getVariables().forEach(i=>{if(i.id===e){const r=!!t;i.value!==r&&(i.value=r,n=!0)}}),a&&this.getVariableDefinitions().forEach(i=>{if(i.id===e){const r=!!t;i.value!==r&&(i.value=r,n=!0)}}),n}getFirstVariableId(){return this.getVariableDefinitions()?.[0]?.id??this.presets?.[0]?.id??null}getPresetDefaultName(e){if(!e)return"";const t=e.fallbackName||e.name||"";return e.nameKey?Zt(e.nameKey,t):t}getPresetTranslationSet(e){const t=new Set;if(!e)return t;const a=i=>{typeof i=="string"&&i.trim()&&t.add(i.trim())};a(e.fallbackName),a(e.name);const n=typeof TextResources<"u"&&TextResources?.bundles||(typeof TEXT_BUNDLES<"u"?TEXT_BUNDLES:{});return e.nameKey&&n&&Object.values(n).forEach(i=>{i&&a(i[e.nameKey])}),a(this.getPresetDefaultName(e)),t}refreshPresetNames(){const e=new Map(this.presets.map(a=>[a.id,a])),t=a=>{Array.isArray(a)&&a.forEach(n=>{const i=e.get(n.id);if(!i)return;const r=this.getPresetTranslationSet(i);if(!n.name||r.has(n.name)){const s=this.getPresetDefaultName(i);n.name!==s&&(n.name=s)}})};t(this.game?.variables),t(this.state?.variables)}static get PRESETS(){return Xe}};typeof window<"u"&&(window.StateVariableManager=Qt);let ea=class{constructor(e,t,a){this.game=e,this.state=t,this.worldManager=a}setGame(e){this.game=e}setState(e){this.state=e}setWorldManager(e){this.worldManager=e}cloneEnemies(e){const t=[];return(e||[]).forEach(a=>{const n=this.normalizeEnemyType(a.type);if(this.isBossType(n)){const i=t.findIndex(r=>r.type===n);i!==-1&&t.splice(i,1)}t.push({id:a.id,type:n,roomIndex:this.worldManager.clampRoomIndex(a.roomIndex??0),x:this.worldManager.clampCoordinate(a.x??0),y:this.worldManager.clampCoordinate(a.y??0),lastX:this.worldManager.clampCoordinate(a.x??0),lives:a.lives??1,defeatVariableId:this.normalizeEnemyVariableId(a.defeatVariableId)})}),t}resetRuntime(){return this.state?(this.state.enemies=this.cloneEnemies(this.game?.enemies),this.state.enemies):[]}getEnemies(){return this.state?.enemies??[]}getEnemyDefinitions(){return this.game?.enemies??[]}addEnemy(e){if(!this.game||!this.state)return null;const t=this.normalizeEnemyType(e.type);this.isBossType(t)&&(this.game.enemies=(this.game.enemies||[]).filter(s=>this.normalizeEnemyType(s.type)!==t),this.state.enemies=(this.state.enemies||[]).filter(s=>this.normalizeEnemyType(s.type)!==t));const a=this.worldManager.clampRoomIndex(e.roomIndex??0);if((this.game?.enemies||[]).reduce((s,l)=>this.worldManager.clampRoomIndex(l.roomIndex??0)===a?s+1:s,0)>=6)return null;const r={id:e.id,type:t,roomIndex:a,x:this.worldManager.clampCoordinate(e.x??0),y:this.worldManager.clampCoordinate(e.y??0),lastX:this.worldManager.clampCoordinate(e.x??0),defeatVariableId:this.normalizeEnemyVariableId(e.defeatVariableId)};return this.game.enemies.push(r),this.state.enemies.push({...r}),r.id}removeEnemy(e){!this.game||!this.state||(this.game.enemies=this.game.enemies.filter(t=>t.id!==e),this.state.enemies=this.state.enemies.filter(t=>t.id!==e))}setEnemyPosition(e,t,a,n=null){const i=this.getEnemies().find(r=>r.id===e);i&&(i.lastX=i.x,i.x=this.worldManager.clampCoordinate(t),i.y=this.worldManager.clampCoordinate(a),n!=null&&(i.roomIndex=this.worldManager.clampRoomIndex(n)))}setEnemyVariable(e,t=null){const a=this.normalizeEnemyVariableId(t);let n=!1;if(Array.isArray(this.game?.enemies)){const i=this.game.enemies.find(r=>r.id===e);i&&i.defeatVariableId!==a&&(i.defeatVariableId=a,n=!0)}if(Array.isArray(this.state?.enemies)){const i=this.state.enemies.find(r=>r.id===e);i&&i.defeatVariableId!==a&&(i.defeatVariableId=a,n=!0)}return n}normalizeEnemyType(e){return EnemyDefinitions.normalizeType(e)}isBossType(e){return!!EnemyDefinitions.getEnemyDefinition(e)?.boss}normalizeEnemyVariableId(e){return typeof e!="string"?null:(Array.isArray(this.game?.variables)?this.game.variables:[]).some(a=>a.id===e)?e:null}};typeof window<"u"&&(window.StateEnemyManager=ea);const qe=40;let ta=class V{static get TYPES(){return typeof ObjectTypes<"u"?ObjectTypes:{}}get types(){return V.TYPES}static get PLAYER_START_TYPE(){return this.TYPES.PLAYER_START}static get PLAYER_END_TYPE(){return this.TYPES.PLAYER_END}static get SWITCH_TYPE(){return this.TYPES.SWITCH}static get PLACEABLE_OBJECT_TYPES(){return this.getPlaceableTypesArray()}static get COLLECTIBLE_OBJECT_TYPES(){return this.getCollectibleTypeSet()}static get PLAYER_END_TEXT_LIMIT(){return qe}static getPlaceableTypesArray(){return ObjectDefinitions.getPlaceableTypes()}static getPlaceableTypeSet(){return new Set(this.getPlaceableTypesArray())}static getCollectibleTypeSet(){return this._collectibleSet||(this._collectibleSet=new Set(ObjectDefinitions.getCollectibleTypes())),this._collectibleSet}static isCollectibleType(e){return ObjectDefinitions.isCollectible(e)}constructor(e,t,a){this.game=e,this.worldManager=t,this.variableManager=a,this.ensurePlayerStartObject()}setGame(e){this.game=e,this.ensurePlayerStartObject()}setWorldManager(e){this.worldManager=e}setVariableManager(e){this.variableManager=e}normalizeObjects(e){if(!Array.isArray(e))return[];const t=this.types,a=V.getPlaceableTypeSet();let n=!1;const i=new Set;return e.map(r=>{const s=typeof r?.type=="string"?r.type:null;if(!a.has(s))return null;const l=s,o=this.worldManager.clampRoomIndex(r?.roomIndex??0);if(l===V.PLAYER_START_TYPE){if(n)return null;n=!0}if(l===V.PLAYER_END_TYPE){if(i.has(o))return null;i.add(o)}const c=this.worldManager.clampCoordinate(r?.x??0),d=this.worldManager.clampCoordinate(r?.y??0),u=typeof r?.id=="string"&&r.id.trim()?r.id.trim():this.generateObjectId(l,o),h=this.variableManager?.getFirstVariableId?.()??null,p=ObjectDefinitions.requiresVariable(l)?this.variableManager?.normalizeVariableId?.(r?.variableId)??h:null,f={id:u,type:l,roomIndex:o,x:c,y:d,collected:V.isCollectibleType(l)?!!r?.collected:!1,opened:l===t.DOOR?!!r?.opened:!1,variableId:p};return l===V.SWITCH_TYPE&&(f.on=!!r?.on),l===V.PLAYER_END_TYPE&&(f.endingText=this.normalizePlayerEndText(r?.endingText)),this.applyObjectBehavior(f)}).filter(Boolean)}normalizePlayerEndText(e){return typeof e!="string"?"":e.replace(/\r\n/g,`
`).slice(0,qe).trim()}resetRuntime(){this.types,this.getObjects().forEach(t=>{t.isCollectible&&(t.collected=!1),t.isLockedDoor&&(t.opened=!1),t.type===V.SWITCH_TYPE&&(t.on=!1)}),this.ensurePlayerStartObject()}generateObjectId(e,t){return e===V.PLAYER_START_TYPE?V.PLAYER_START_TYPE:`${e}-${t}`}getObjects(){return this.game?(Array.isArray(this.game.objects)||(this.game.objects=[]),this.game.objects.forEach(e=>this.applyObjectBehavior(e)),this.game.objects):[]}getObjectsForRoom(e){const t=this.worldManager.clampRoomIndex(e??0);return this.getObjects().filter(a=>a.roomIndex===t)}getObjectAt(e,t,a){const n=this.worldManager.clampRoomIndex(e??0),i=this.worldManager.clampCoordinate(t??0),r=this.worldManager.clampCoordinate(a??0);return this.getObjects().find(s=>s.roomIndex===n&&s.x===i&&s.y===r)||null}setObjectPosition(e,t,a,n){this.types;const r=V.getPlaceableTypeSet().has(e)?e:null;if(!r)return null;const s=this.worldManager.clampRoomIndex(t??0),l=this.worldManager.clampCoordinate(a??0),o=this.worldManager.clampCoordinate(n??0),c=this.getObjects();let d=null;if(r===V.PLAYER_START_TYPE?d=c.find(u=>u.type===r)||null:d=c.find(u=>u.type===r&&u.roomIndex===s)||null,d?(d.roomIndex=s,d.x=l,d.y=o):(d={id:this.generateObjectId(r,s),type:r,roomIndex:s,x:l,y:o},r===V.SWITCH_TYPE&&(d.on=!1),r===V.PLAYER_END_TYPE&&(d.endingText=""),c.push(d)),V.isCollectibleType(r)&&(d.collected=!1),ObjectDefinitions.isLockedDoor(r)&&(d.opened=!1),ObjectDefinitions.isVariableDoor(r)){const u=this.variableManager?.getFirstVariableId?.()??null;d.variableId=this.variableManager?.normalizeVariableId?.(d.variableId)??u}if(r===V.PLAYER_START_TYPE&&this.syncPlayerStart(d),r===V.SWITCH_TYPE){const u=this.variableManager?.getFirstVariableId?.()??null;d.variableId=this.variableManager?.normalizeVariableId?.(d.variableId)??u,d.on=!!d.on}return r===V.PLAYER_END_TYPE&&(d.endingText=this.normalizePlayerEndText(d.endingText??"")),this.applyObjectBehavior(d)}removeObject(e,t){const n=V.getPlaceableTypeSet().has(e)?e:null;if(!n||n===V.PLAYER_START_TYPE)return;const i=this.worldManager.clampRoomIndex(t??0);this.game.objects=this.getObjects().filter(r=>!(r.type===n&&r.roomIndex===i))}setObjectVariable(e,t,a){if(!ObjectDefinitions.requiresVariable(e))return null;const i=this.worldManager.clampRoomIndex(t??0),r=this.getObjects().find(o=>o.type===e&&o.roomIndex===i);if(!r)return null;const s=this.variableManager?.getFirstVariableId?.()??null,l=this.variableManager?.normalizeVariableId?.(a);return r.variableId=l??s,r.variableId}syncSwitchState(e,t){if(!e)return!1;let a=!1;const n=this.variableManager?.normalizeVariableId?.(e)??null;if(!n)return!1;const i=!!t;return this.getObjects().forEach(r=>{r.type===V.SWITCH_TYPE&&r.variableId===n&&r.on!==i&&(r.on=i,a=!0)}),a}ensurePlayerStartObject(){if(!this.game||!this.worldManager)return null;const e=this.getObjects(),t=this.game.start||{x:1,y:1,roomIndex:0},a=this.worldManager.clampRoomIndex(t?.roomIndex??0),n=this.worldManager.clampCoordinate(t?.x??1),i=this.worldManager.clampCoordinate(t?.y??1);let r=e.find(s=>s.type===V.PLAYER_START_TYPE);return r?(r.roomIndex=a,r.x=n,r.y=i):(r={id:V.PLAYER_START_TYPE,type:V.PLAYER_START_TYPE,roomIndex:a,x:n,y:i},e.unshift(r)),this.applyObjectBehavior(r)}getPlayerEndObject(e=null){const t=this.getObjects();if(e==null)return t.find(n=>n.type===V.PLAYER_END_TYPE)||null;const a=this.worldManager.clampRoomIndex(e??0);return t.find(n=>n.type===V.PLAYER_END_TYPE&&n.roomIndex===a)||null}getPlayerEndText(e=null){const t=this.getPlayerEndObject(e);return typeof t?.endingText=="string"?t.endingText:""}setPlayerEndText(e,t){const a=this.getPlayerEndObject(e);if(!a)return"";const n=this.normalizePlayerEndText(t);return a.endingText=n,n}syncPlayerStart(e){if(!e||!this.worldManager||!this.game)return;const t=this.worldManager.clampCoordinate(e?.x??0),a=this.worldManager.clampCoordinate(e?.y??0),n=this.worldManager.clampRoomIndex(e?.roomIndex??0);this.game.start={x:t,y:a,roomIndex:n},e.x=t,e.y=a,e.roomIndex=n}applyObjectBehavior(e){if(!e)return e;const t=e.type,a=V.isCollectibleType(t);return e.isCollectible=a,e.hideWhenCollected=ObjectDefinitions.shouldHideWhenCollected(t),e.hiddenInRuntime=ObjectDefinitions.isHiddenInRuntime(t),e.isLockedDoor=ObjectDefinitions.isLockedDoor(t),e.hideWhenOpened=ObjectDefinitions.shouldHideWhenOpened(t),e.isVariableDoor=ObjectDefinitions.isVariableDoor(t),e.hideWhenVariableOpen=ObjectDefinitions.shouldHideWhenVariableOpen(t),e.requiresVariable=ObjectDefinitions.requiresVariable(t),e.swordDurability=ObjectDefinitions.getSwordDurability(t),e}checkOpenedMagicDoor(e,t){const a=this.types;for(const n of this.getObjects())if(t&&n.type==a.DOOR_VARIABLE&&n.variableId==e)return!0;return!1}};typeof window<"u"&&(window.StateObjectManager=ta);let aa=class{constructor(e){this.game=e}setGame(e){this.game=e}resetItems(){Array.isArray(this.game?.items)&&this.game.items.forEach(e=>{e.collected=!1})}};typeof window<"u"&&(window.StateItemManager=aa);let na=class{constructor(e,t,a={}){this.gameState=e,this.screenManager=t,this.pauseReasons=new Set,this.timeToResetAfterGameOver=Number.isFinite(a.timeToResetAfterGameOver)?Math.max(0,a.timeToResetAfterGameOver):2e3}pauseGame(e="manual"){const t=e||"manual";this.pauseReasons.add(t),this.updatePlayingLock()}resumeGame(e="manual"){e==null?this.pauseReasons.clear():this.pauseReasons.delete(e||"manual"),this.updatePlayingLock()}updatePlayingLock(){this.gameState.playing=this.pauseReasons.size===0}setGameOver(e=!0,t="defeat"){const a=this.gameState.state;if(!a)return;const n=!!e;n&&this.screenManager.startGameOverCooldown(this.timeToResetAfterGameOver),a.gameOver=n,a.gameOverReason=n?t||"defeat":null}isGameOver(){return!!this.gameState.state?.gameOver}getGameOverReason(){return this.gameState.state?.gameOverReason||"defeat"}};typeof window<"u"&&(window.GameStateLifecycle=na);let ia=class{constructor(e){this.gameState=e,this.canResetAfterGameOver=!1,this.lastEndingText="",this.gameOverResetTimer=null}reset(){this.lastEndingText="",this.clearGameOverCooldown(),this.canResetAfterGameOver=!1}setActiveEndingText(e=""){const t=typeof e=="string"?e.trim():"";return this.lastEndingText=t,this.lastEndingText}getActiveEndingText(){return this.lastEndingText}startGameOverCooldown(e){this.canResetAfterGameOver=!1,this.clearGameOverCooldown();const t=Number.isFinite(e)?Math.max(0,e):0;this.gameOverResetTimer=setTimeout(()=>{this.canResetAfterGameOver=!0,this.gameOverResetTimer=null},t)}clearGameOverCooldown(){this.gameOverResetTimer&&(clearTimeout(this.gameOverResetTimer),this.gameOverResetTimer=null)}};typeof window<"u"&&(window.GameStateScreenManager=ia);let ra=class{constructor(e,t){this.gameState=e,this.worldManager=t}createEmptyRoom(e,t=0,a=1){return this.worldManager.createEmptyRoom(e,t,a)}createWorldRooms(e,t,a){return this.worldManager.createWorldRooms(e,t,a)}createEmptyTileMap(e){return this.worldManager.createEmptyTileMap(e)}normalizeRooms(e,t,a){return this.worldManager.normalizeRooms(e,t,a)}normalizeTileMaps(e,t){return this.worldManager.normalizeTileMaps(e,t)}};typeof window<"u"&&(window.GameStateWorldFacade=ra);let sa=class{constructor(e,t){this.gameState=e,this.playerManager=t}getPlayer(){return this.playerManager.getPlayer()}setPlayerPosition(e,t,a=null){this.playerManager.setPosition(e,t,a)}resetPlayer(){this.playerManager.reset(this.gameState.game.start)}addKeys(e=1){return this.playerManager.addKeys(e)}addLife(e=1){return this.playerManager.gainLives(e)}addDamageShield(e=1,t=null){return this.playerManager.addDamageShield(e,t)}getDamageShield(){return this.playerManager.getDamageShield()}getDamageShieldMax(){return this.playerManager.getDamageShieldMax()}getSwordType(){return this.playerManager.getSwordType()}consumeKey(){return this.playerManager.consumeKey()}getKeys(){return this.playerManager.getKeys()}getMaxKeys(){return this.playerManager.getMaxKeys()}consumeLastDamageReduction(){return this.playerManager.consumeLastDamageReduction()}damage(e=0){return this.playerManager.damage(e)}isOnDamageCooldown(){return this.playerManager.isOnDamageCooldown()}getLives(){return this.playerManager.getLives()}getMaxLives(){return this.playerManager.getMaxLives()}getLevel(){return this.playerManager.getLevel()}healPlayerToFull(){return this.playerManager.healToFull()}getExperience(){return this.playerManager.getExperience()}getExperienceToNext(){return this.playerManager.getExperienceToNext()}addExperience(e=0){return this.playerManager.addExperience(e)}handleEnemyDefeated(e=0){return this.playerManager.handleEnemyDefeated(e)}};typeof window<"u"&&(window.GameStatePlayerFacade=sa);let la=class{constructor(e,t){this.gameState=e,this.dataManager=t}exportGameData(){return this.dataManager.exportGameData()}importGameData(e){this.dataManager.importGameData(e),this.gameState.enemyManager.setGame(this.gameState.game),this.gameState.itemManager.setGame(this.gameState.game),this.gameState.objectManager.setGame(this.gameState.game),this.gameState.variableManager.setGame(this.gameState.game),this.gameState.ensureDefaultVariables(),this.gameState.resetGame()}};typeof window<"u"&&(window.GameStateDataFacade=la);let oa=class{constructor({game:e,worldManager:t,objectManager:a,variableManager:n}){this.game=e,this.worldManager=t,this.objectManager=a,this.variableManager=n}setGame(e){this.game=e}setWorldManager(e){this.worldManager=e}setObjectManager(e){this.objectManager=e}setVariableManager(e){this.variableManager=e}exportGameData(){return{title:this.game.title,author:this.game.author,palette:this.game.palette,roomSize:this.game.roomSize,world:this.game.world,rooms:this.game.rooms,start:this.game.start,sprites:this.game.sprites,enemies:this.game.enemies,items:this.game.items,objects:this.game.objects,variables:this.game.variables,exits:this.game.exits,tileset:this.game.tileset}}importGameData(e){if(!e)return null;const t=3,a=3,n=t*a,i=Array.isArray(e.tileset?.tiles)?e.tileset.tiles:this.game.tileset?.tiles??[],r=this.worldManager.normalizeRooms(e.rooms,n,a),s=this.worldManager.normalizeTileMaps(e.tileset?.maps??e.tileset?.map??null,n),l=this.objectManager.normalizeObjects(e.objects),o=this.variableManager.normalizeVariables(e.variables);Object.assign(this.game,{title:typeof e.title=="string"?e.title.slice(0,18):"My Tiny RPG Game",author:typeof e.author=="string"?e.author.slice(0,18):"",palette:Array.isArray(e.palette)&&e.palette.length>=3?e.palette.slice(0,3):["#000000","#1D2B53","#FFF1E8"],roomSize:8,world:{rows:t,cols:a},rooms:r,start:e.start||{x:1,y:1,roomIndex:0},sprites:Array.isArray(e.sprites)?e.sprites:[],enemies:Array.isArray(e.enemies)?e.enemies:[],items:Array.isArray(e.items)?e.items:[],objects:l,variables:o,exits:Array.isArray(e.exits)?e.exits:[],tileset:{tiles:i,maps:s}}),this.game.tileset.map=this.game.tileset.maps[0];const c={x:this.worldManager.clampCoordinate(e.start?.x??1),y:this.worldManager.clampCoordinate(e.start?.y??1),roomIndex:this.worldManager.clampRoomIndex(e.start?.roomIndex??0)};return this.game.start=c,this.worldManager.setGame(this.game),this.objectManager.setGame(this.game),this.variableManager.setGame(this.game),c}};typeof window<"u"&&(window.StateDataManager=oa);let ca=class R{static get VERSION_1(){return 1}static get VERSION_2(){return 2}static get VERSION_3(){return 3}static get VERSION_4(){return 4}static get VERSION_5(){return 5}static get VERSION_6(){return 6}static get VERSION_7(){return 7}static get VERSION_8(){return 8}static get VERSION_9(){return 9}static get VERSION_10(){return 10}static get VERSION_11(){return 11}static get VERSION_12(){return 12}static get VERSION_13(){return 13}static get VERSION_14(){return 14}static get VERSION_15(){return 15}static get VERSION_16(){return 16}static get VERSION_17(){return 17}static get VERSION_18(){return 18}static get VERSION_19(){return 19}static get VERSION(){return R.VERSION_19}static get LEGACY_VERSION(){return R.VERSION_1}static get OBJECTS_VERSION(){return R.VERSION_4}static get VARIABLES_VERSION(){return R.VERSION_5}static get WORLD_MULTIMAP_VERSION(){return R.VERSION_6}static get NPC_VARIABLE_TEXT_VERSION(){return R.VERSION_6}static get MAGIC_DOOR_VERSION(){return R.VERSION_7}static get NPC_CONDITIONAL_REWARD_VERSION(){return R.VERSION_8}static get ENEMY_TYPE_VERSION(){return R.VERSION_9}static get ENEMY_VARIABLE_VERSION(){return R.VERSION_10}static get LIFE_POTION_VERSION(){return R.VERSION_11}static get XP_SCROLL_VERSION(){return R.VERSION_12}static get SWORD_VERSION(){return R.VERSION_13}static get PLAYER_END_VERSION(){return R.VERSION_14}static get SWITCH_VERSION(){return R.VERSION_15}static get TILE_EXTENDED_VERSION(){return R.VERSION_16}static get PLAYER_END_TEXT_VERSION(){return R.VERSION_17}static get PLAYER_END_TEXT_ARRAY_VERSION(){return R.VERSION_18}static get TIERED_SWORD_VERSION(){return R.VERSION_19}static get MATRIX_SIZE(){return 8}static get TILE_COUNT(){return R.MATRIX_SIZE*R.MATRIX_SIZE}static get WORLD_ROWS(){return 3}static get WORLD_COLS(){return 3}static get WORLD_ROOM_COUNT(){return R.WORLD_ROWS*R.WORLD_COLS}static get MAX_ROOM_INDEX(){return R.WORLD_ROOM_COUNT-1}static get NULL_CHAR(){return"z"}static get TILE_LEGACY_MAX(){return 15}static get TILE_VALUE_MAX(){return 255}static get GROUND_SPARSE_PREFIX(){return"x"}static get OVERLAY_BINARY_PREFIX(){return"y"}static get POSITION_WIDE_PREFIX(){return"~"}static get DEFAULT_TITLE(){return"My Tiny RPG Game"}static get DEFAULT_PALETTE(){return["#000000","#1D2B53","#7E2553","#008751","#AB5236","#5F574F","#C2C3C7","#FFF1E8","#FF004D","#FFA300","#FFFF27","#00E756","#29ADFF","#83769C","#FF77A8","#FFCCAA"]}static get VARIABLE_IDS(){return["var-1","var-2","var-3","var-4","var-5","var-6","var-7","var-8","var-9","skill:bard"]}static get VARIABLE_NAMES(){return["1 - Preto","2 - Azul Escuro","3 - Roxo","4 - Verde","5 - Marrom","6 - Cinza","7 - Azul Claro","8 - Rosa Choque","9 - Amarelo","Habilidade: Bardo"]}static get VARIABLE_COLORS(){return["#000000","#1D2B53","#7E2553","#008751","#AB5236","#5F574F","#29ADFF","#FF77A8","#FFCCAA","#FFD700"]}static get SUPPORTED_VERSIONS(){return this._supportedVersions||(this._supportedVersions=new Set([R.VERSION_1,R.VERSION_2,R.VERSION_3,R.VERSION_4,R.VERSION_5,R.VERSION_6,R.VERSION_7,R.VERSION_8,R.VERSION_9,R.VERSION_10,R.VERSION_11,R.VERSION_12,R.VERSION_13,R.VERSION_14,R.VERSION_15,R.VERSION_16,R.VERSION_17,R.VERSION_18,R.VERSION_19])),this._supportedVersions}static get NPC_DEFINITIONS(){const e=typeof window<"u"&&window.NPCDefinitions;return(!this._npcDefinitions||e&&!this._npcDefinitions.length)&&(e?this._npcDefinitions=window.NPCDefinitions.definitions||window.NPCDefinitions.NPC_DEFINITIONS||[]:this._npcDefinitions||(this._npcDefinitions=[])),this._npcDefinitions||[]}static get ENEMY_DEFINITIONS(){const e=typeof window<"u"&&window.EnemyDefinitions;return(!this._enemyDefinitions||e&&!this._enemyDefinitions.length)&&(e?this._enemyDefinitions=window.EnemyDefinitions.definitions||window.EnemyDefinitions.ENEMY_DEFINITIONS||[]:this._enemyDefinitions||(this._enemyDefinitions=[])),this._enemyDefinitions||[]}};typeof window<"u"&&(window.ShareConstants=ca);let da=class et{static clamp(e,t,a,n){return Number.isFinite(e)?Math.max(t,Math.min(a,e)):n}static clampRoomIndex(e){return et.clamp(Number(e),0,ShareConstants.MAX_ROOM_INDEX,0)}};typeof window<"u"&&(window.ShareMath=da);let ha=class xe{static toBase64Url(e){if(!e||!e.length)return"";if(typeof Buffer<"u")return Buffer.from(e).toString("base64").replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/g,"");let t="";for(let a=0;a<e.length;a++)t+=String.fromCharCode(e[a]);return btoa(t).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/g,"")}static fromBase64Url(e){if(!e)return new Uint8Array(0);const t=String(e).replace(/[\s\r\n]+/g,"");if(!t)return new Uint8Array(0);if(/[^0-9a-zA-Z\-_]/.test(t))return xe.logInvalidInput(t),new Uint8Array(0);const a=t.replace(/-/g,"+").replace(/_/g,"/"),n=(4-a.length%4)%4,i=a+"=".repeat(n);try{if(typeof Buffer<"u")return Uint8Array.from(Buffer.from(i,"base64"));const r=atob(i),s=new Uint8Array(r.length);for(let l=0;l<r.length;l++)s[l]=r.charCodeAt(l);return s}catch(r){return xe.logInvalidInput(t,r),new Uint8Array(0)}}static logInvalidInput(e,t){console.warn("[TinyRPG] Invalid base64 segment ignored.",{input:e,error:t})}};typeof window<"u"&&(window.ShareBase64=ha);let ua=class me{static encodeUtf8(e){if(typeof TextEncoder<"u")return new TextEncoder().encode(e);const t=unescape(encodeURIComponent(e)),a=new Uint8Array(t.length);for(let n=0;n<t.length;n++)a[n]=t.charCodeAt(n);return a}static decodeUtf8(e){if(typeof TextDecoder<"u")return new TextDecoder().decode(e);let t="";for(let a=0;a<e.length;a++)t+=String.fromCharCode(e[a]);return decodeURIComponent(escape(t))}static encodeText(e){return e?ShareBase64.toBase64Url(me.encodeUtf8(e)):""}static decodeText(e,t=""){if(!e)return t;try{return me.decodeUtf8(ShareBase64.fromBase64Url(e))}catch(a){return console.warn("Failed to decode text payload",a),t}}static encodeTextArray(e){if(!e.length)return"";const t=JSON.stringify(e);return ShareBase64.toBase64Url(me.encodeUtf8(t))}static decodeTextArray(e){if(!e)return[];try{const t=me.decodeUtf8(ShareBase64.fromBase64Url(e)),a=JSON.parse(t);return Array.isArray(a)?a.map(n=>typeof n=="string"?n:""):[]}catch(t){return console.warn("Failed to decode text array payload",t),[]}}};typeof window<"u"&&(window.ShareTextCodec=ua);let ma=class Ie{static encodeVariables(e){if(!Array.isArray(e)||!e.length)return"";const t=ShareConstants.VARIABLE_IDS,a=new Map;e.forEach(s=>{typeof s?.id=="string"&&a.set(s.id,!!s.value)});const n=Math.ceil(t.length/8),i=new Uint8Array(n);return t.forEach((s,l)=>{if(!a.get(s))return;const o=l>>3,c=l&7;i[o]|=1<<c}),i.some(s=>s!==0)?ShareBase64.toBase64Url(i):""}static decodeVariables(e){const t=ShareConstants.VARIABLE_IDS,a=new Array(t.length).fill(!1);if(!e)return a;const n=ShareBase64.fromBase64Url(e);return t.forEach((i,r)=>{const s=r>>3,l=r&7,o=n[s]??0;a[r]=!!(o&1<<l)}),a}static variableIdToNibble(e){if(typeof e!="string")return 0;const t=ShareConstants.VARIABLE_IDS.indexOf(e);return t>=0?t+1:0}static nibbleToVariableId(e){if(!Number.isFinite(e)||e<=0)return null;const t=e-1;return ShareConstants.VARIABLE_IDS[t]||null}static encodeVariableNibbleArray(e){return!Array.isArray(e)||!e.length||!e.some(a=>Number.isFinite(a)&&a>0)?"":ShareBase64.toBase64Url(Ie.packNibbles(e.map(a=>Number(a)&15)))}static decodeVariableNibbleArray(e,t){const a=Number.isFinite(t)&&t>0?t:0;if(!e||!a)return new Array(a).fill(0);const n=ShareBase64.fromBase64Url(e);return Ie.unpackNibbles(n,a).map(r=>Number.isFinite(r)?r:0)}static buildVariableEntries(e){const t=ShareConstants.VARIABLE_IDS,a=ShareConstants.VARIABLE_NAMES,n=ShareConstants.VARIABLE_COLORS,i=Array.isArray(e)&&e.length===t.length?e:new Array(t.length).fill(!1);return t.map((r,s)=>({id:r,order:s+1,name:a[s]||r,color:n[s]||"#000000",value:!!i[s]}))}static packNibbles(e){const t=Math.ceil(e.length/2),a=new Uint8Array(t);for(let n=0;n<e.length;n+=2){const i=e[n]&15,r=e[n+1]!==void 0?e[n+1]&15:0,s=n>>1;a[s]=i<<4|r}return a}static unpackNibbles(e,t){const a=new Array(t);for(let n=0;n<t;n++){const i=e[n>>1]||0;a[n]=n%2===0?i>>4&15:i&15}return a}static getFirstVariableId(){return ShareConstants.VARIABLE_IDS?.[0]??null}};typeof window<"u"&&(window.ShareVariableCodec=ma);let ga=class B{static normalizeGround(e){const t=ShareConstants.MATRIX_SIZE,a=[],n=ShareConstants.TILE_VALUE_MAX;for(let i=0;i<t;i++){const r=[];for(let s=0;s<t;s++){const l=B.coerceTileValue(e?.[i]?.[s],0);r.push(ShareMath.clamp(l,0,n,0))}a.push(r)}return a}static normalizeOverlay(e){const t=ShareConstants.MATRIX_SIZE,a=[],n=ShareConstants.TILE_VALUE_MAX;for(let i=0;i<t;i++){const r=[];for(let s=0;s<t;s++){const l=e?.[i]?.[s];if(l==null)r.push(null);else{const o=B.coerceTileValue(l,0);r.push(ShareMath.clamp(o,0,n,0))}}a.push(r)}return a}static collectGroundMatrices(e,t){const a=Array.isArray(e?.tileset?.maps)?e.tileset.maps:[],n=e?.tileset?.map?.ground??null,i=[];for(let r=0;r<t;r++){const s=a[r]?.ground??(r===0?n:null);i.push(s??[])}return i}static collectOverlayMatrices(e,t){const a=Array.isArray(e?.tileset?.maps)?e.tileset.maps:[],n=e?.tileset?.map?.overlay??null,i=[];for(let r=0;r<t;r++){const s=a[r]?.overlay??(r===0?n:null);i.push(s??[])}return i}static encodeGround(e){const t=B.normalizeGround(e),a=[],n=[],i=ShareConstants.TILE_COUNT,r=new Uint8Array(Math.ceil(i/8));let s=!1,l=0;const o=ShareConstants.MATRIX_SIZE,c=B.shouldUseExtendedTileEncoding(t);for(let p=0;p<o;p++)for(let f=0;f<o;f++){const y=t[p][f]&255;if(!s&&y!==0&&(s=!0),y!==0){const T=l>>3,b=l&7;r[T]|=1<<b,n.push(y)}a.push(y),l++}if(!s)return"";const d=ShareBase64.toBase64Url(B.packTileValues(a,c));if(!n.length)return d;const u=ShareBase64.toBase64Url(r),h=ShareBase64.toBase64Url(B.packTileValues(n,c));return 1+u.length+h.length<d.length?`${ShareConstants.GROUND_SPARSE_PREFIX}${u}${h}`:d}static decodeGround(e,t){const a=ShareConstants.TILE_COUNT,n=ShareConstants.MATRIX_SIZE,i=ShareConstants.TILE_VALUE_MAX,r=t>=ShareConstants.TILE_EXTENDED_VERSION,s=t===ShareConstants.LEGACY_VERSION||e?.length===a&&/^[0-9a-f]+$/i.test(e),l=[];if(s){let h=0;for(let g=0;g<n;g++){const p=[];for(let f=0;f<n;f++){const y=e?.[h++]??"0",T=parseInt(y,16);p.push(Number.isFinite(T)?ShareMath.clamp(T,0,ShareConstants.TILE_LEGACY_MAX,0):0)}l.push(p)}return l}if(e?.[0]===ShareConstants.GROUND_SPARSE_PREFIX&&t!==ShareConstants.LEGACY_VERSION){const h=B.getTileMaskBase64Length(a),g=e.slice(1,1+h),p=e.slice(1+h),f=ShareBase64.fromBase64Url(g),y=B.countSetBits(f),T=p?ShareBase64.fromBase64Url(p):new Uint8Array(0),b=B.unpackTileValues(T,y,r);let x=0,O=0;for(let N=0;N<n;N++){const D=[];for(let L=0;L<n;L++){const A=O>>3,v=O&7,k=(f[A]&1<<v)!==0?b[x++]??0:0;D.push(ShareMath.clamp(k,0,i,0)),O++}l.push(D)}return l}const c=ShareBase64.fromBase64Url(e),d=B.unpackTileValues(c,a,r);let u=0;for(let h=0;h<n;h++){const g=[];for(let p=0;p<n;p++){const f=d[u++]??0;g.push(ShareMath.clamp(f,0,i,0))}l.push(g)}return l}static encodeOverlay(e){const t=B.normalizeOverlay(e),a=ShareConstants.TILE_COUNT,n=new Uint8Array(Math.ceil(a/8)),i=[];let r=!1,s=0;const l=ShareConstants.MATRIX_SIZE,o=B.shouldUseExtendedTileEncoding(t);for(let u=0;u<l;u++)for(let h=0;h<l;h++){const g=t[u][h],p=s++;if(g==null)continue;r=!0;const f=p>>3,y=p&7;n[f]|=1<<y,i.push(g&255)}if(!r)return{text:"",hasData:!1};const c=ShareBase64.toBase64Url(n),d=i.length?ShareBase64.toBase64Url(B.packTileValues(i,o)):"";return{text:`${ShareConstants.OVERLAY_BINARY_PREFIX}${c}${d}`,hasData:!0}}static decodeOverlay(e,t){const a=ShareConstants.MATRIX_SIZE,n=ShareConstants.TILE_COUNT,i=ShareConstants.TILE_VALUE_MAX,r=e?.[0]===ShareConstants.OVERLAY_BINARY_PREFIX&&t!==ShareConstants.LEGACY_VERSION,s=t>=ShareConstants.TILE_EXTENDED_VERSION,l=[];if(r){const c=B.getTileMaskBase64Length(n),d=e.slice(1,1+c),u=e.slice(1+c),h=ShareBase64.fromBase64Url(d),g=B.countSetBits(h),p=u?ShareBase64.fromBase64Url(u):new Uint8Array(0),f=B.unpackTileValues(p,g,s);let y=0,T=0;for(let b=0;b<a;b++){const x=[];for(let O=0;O<a;O++){const N=y>>3,D=y&7;if((h[N]&1<<D)!==0){const A=f[T++]??0;x.push(ShareMath.clamp(A,0,i,0))}else x.push(null);y++}l.push(x)}return l}let o=0;for(let c=0;c<a;c++){const d=[];for(let u=0;u<a;u++){const h=e?.[o++]??ShareConstants.NULL_CHAR;if(h===ShareConstants.NULL_CHAR)d.push(null);else{const g=parseInt(h,16);d.push(Number.isFinite(g)?ShareMath.clamp(g,0,ShareConstants.TILE_LEGACY_MAX,0):null)}}l.push(d)}return l}static decodeWorldGround(e,t,a){if(t>=ShareConstants.WORLD_MULTIMAP_VERSION){const n=e?e.split(","):[],i=[];for(let r=0;r<a;r++){const s=n[r]??"";i.push(B.decodeGround(s,t))}return i}return[B.decodeGround(e,t)]}static decodeWorldOverlay(e,t,a){if(t>=ShareConstants.WORLD_MULTIMAP_VERSION){const n=e?e.split(","):[],i=[];for(let r=0;r<a;r++){const s=n[r]??"";i.push(B.decodeOverlay(s,t))}return i}return[B.decodeOverlay(e||"",t)]}static coerceTileValue(e,t=0){if(typeof e=="number"&&Number.isFinite(e))return e;if(typeof e=="string"&&e.trim()!==""){const a=Number(e);if(Number.isFinite(a))return a}return t}static shouldUseExtendedTileEncoding(e){return ShareConstants.VERSION<ShareConstants.TILE_EXTENDED_VERSION?B.matrixHasExtendedTiles(e):!0}static matrixHasExtendedTiles(e){const t=ShareConstants.TILE_LEGACY_MAX,a=ShareConstants.MATRIX_SIZE;for(let n=0;n<a;n++)for(let i=0;i<a;i++){const r=e?.[n]?.[i];if(r!=null&&Number.isFinite(r)&&r>t)return!0}return!1}static packTileValues(e,t){if(t){const a=new Uint8Array(e.length);for(let n=0;n<e.length;n++){const i=Number.isFinite(e[n])?e[n]:0;a[n]=i&255}return a}return ShareVariableCodec.packNibbles(e.map(a=>Number(a)&15))}static unpackTileValues(e,t,a){if(a){const n=new Array(t);for(let i=0;i<t;i++)n[i]=e[i]??0;return n}return ShareVariableCodec.unpackNibbles(e,t)}static countSetBits(e){let t=0;for(let a=0;a<e.length;a++){let n=e[a]||0;for(;n;)n&=n-1,t++}return t}static getTileMaskBase64Length(e){if(B._tileMaskLengthCache||(B._tileMaskLengthCache=new Map),!B._tileMaskLengthCache.has(e)){const t=new Uint8Array(Math.ceil(e/8));B._tileMaskLengthCache.set(e,ShareBase64.toBase64Url(t).length)}return B._tileMaskLengthCache.get(e)}};typeof window<"u"&&(window.ShareMatrixCodec=ga);let pa=class Ce{static positionToByte(e){const t=ShareMath.clamp(Number(e?.roomIndex),0,ShareConstants.MAX_ROOM_INDEX,0)&15,a=ShareMath.clamp(Number(e?.y),0,ShareConstants.MATRIX_SIZE-1,0)&7,n=ShareMath.clamp(Number(e?.x),0,ShareConstants.MATRIX_SIZE-1,0)&7;return(t&3)<<6|a<<3|n}static byteToPosition(e){return{x:e&7,y:e>>3&7,roomIndex:ShareMath.clamp(e>>6&3,0,ShareConstants.MAX_ROOM_INDEX,0)}}static encodePositions(e){if(!e.length)return"";if(e.reduce((i,r)=>Math.max(i,ShareMath.clamp(Number(r?.roomIndex),0,ShareConstants.MAX_ROOM_INDEX,0)),0)>3){const i=new Uint8Array(e.length*2);for(let r=0;r<e.length;r++){const s=ShareMath.clamp(Number(e[r]?.roomIndex),0,ShareConstants.MAX_ROOM_INDEX,0)&15,l=ShareMath.clamp(Number(e[r]?.y),0,ShareConstants.MATRIX_SIZE-1,0)&7,o=ShareMath.clamp(Number(e[r]?.x),0,ShareConstants.MATRIX_SIZE-1,0)&7,c=r*2;i[c]=(s&3)<<6|l<<3|o,i[c+1]=s>>2&15}return ShareConstants.POSITION_WIDE_PREFIX+ShareBase64.toBase64Url(i)}const n=new Uint8Array(e.length);for(let i=0;i<e.length;i++)n[i]=Ce.positionToByte(e[i]);return ShareBase64.toBase64Url(n)}static decodePositions(e){if(!e)return[];if(e[0]===ShareConstants.POSITION_WIDE_PREFIX){const a=ShareBase64.fromBase64Url(e.slice(1)),n=[];for(let i=0;i<a.length;i+=2){const r=a[i]??0,s=a[i+1]??0,l=r&7,o=r>>3&7,c=r>>6&3,d=s&15,u=ShareMath.clamp(d<<2|c,0,ShareConstants.MAX_ROOM_INDEX,0);n.push({x:l,y:o,roomIndex:u})}return n}const t=ShareBase64.fromBase64Url(e);return Array.from(t,a=>Ce.byteToPosition(a))}static encodeNpcTypeIndexes(e){if(!e.length)return"";const t=ShareConstants.NPC_DEFINITIONS,a=new Uint8Array(e.length);let n=!1;for(let i=0;i<e.length;i++){const r=e[i],s=t.findIndex(l=>l.type===r.type);a[i]=s>=0?s:255,!n&&a[i]!==i&&(n=!0)}return n?ShareBase64.toBase64Url(a):""}static decodeNpcTypeIndexes(e){return e?Array.from(ShareBase64.fromBase64Url(e),t=>t):[]}static encodeEnemyTypeIndexes(e){if(!e.length)return"";const t=ShareConstants.ENEMY_DEFINITIONS;if(!Array.isArray(t)||!t.length)return"";const a=new Uint8Array(e.length);for(let n=0;n<e.length;n++){const i=e[n]||{};let r=Number.isInteger(i.typeIndex)?i.typeIndex:-1;if(r<0||r>=t.length){const s=typeof i.type=="string"?i.type:null;r=s?t.findIndex(l=>l.type===s):-1}a[n]=r>=0?r:255}return ShareBase64.toBase64Url(a)}static decodeEnemyTypeIndexes(e,t=0){if(!e)return Array.from({length:t},()=>255);const a=Array.from(ShareBase64.fromBase64Url(e),n=>n);if(t>0&&a.length<t)for(;a.length<t;)a.push(255);return a}};typeof window<"u"&&(window.SharePositionCodec=pa);let fa=class G{static get Types(){return typeof ObjectTypes<"u"?ObjectTypes:{}}static normalizeStart(e){return{x:ShareMath.clamp(Number(e?.x),0,ShareConstants.MATRIX_SIZE-1,1),y:ShareMath.clamp(Number(e?.y),0,ShareConstants.MATRIX_SIZE-1,1),roomIndex:ShareMath.clampRoomIndex(e?.roomIndex)}}static resolveNpcType(e){if(typeof e?.type=="string")return e.type;if(typeof e?.id=="string"){const t=ShareConstants.NPC_DEFINITIONS.find(a=>a.id===e.id);if(t)return t.type}if(typeof e?.name=="string"){const t=ShareConstants.NPC_DEFINITIONS.find(a=>a.name===e.name);if(t)return t.type}return null}static normalizeSprites(e){if(!Array.isArray(e))return[];const t=new Set,a=[],n=ShareConstants.NPC_DEFINITIONS;for(const i of e){const r=G.resolveNpcType(i);if(!r||t.has(r))continue;const s=n.find(g=>g.type===r);if(!s||!(i?.placed!==!1))continue;const o=ShareMath.clamp(Number(i?.x),0,ShareConstants.MATRIX_SIZE-1,0),c=ShareMath.clamp(Number(i?.y),0,ShareConstants.MATRIX_SIZE-1,0);if(!Number.isFinite(o)||!Number.isFinite(c))continue;const d=typeof i?.conditionVariableId=="string"?i.conditionVariableId:typeof i?.conditionalVariableId=="string"?i.conditionalVariableId:null,u=typeof i?.rewardVariableId=="string"?i.rewardVariableId:typeof i?.activateVariableId=="string"?i.activateVariableId:null,h=typeof i?.conditionalRewardVariableId=="string"?i.conditionalRewardVariableId:typeof i?.alternativeRewardVariableId=="string"?i.alternativeRewardVariableId:null;a.push({type:r,id:s.id,name:s.name,x:o,y:c,roomIndex:ShareMath.clampRoomIndex(i?.roomIndex),text:typeof i?.text=="string"?i.text:s.defaultText||"",textKey:typeof i?.textKey=="string"&&i.textKey.length?i.textKey:s.defaultTextKey||null,conditionVariableId:ShareConstants.VARIABLE_IDS.includes(d)?d:null,conditionText:typeof i?.conditionText=="string"?i.conditionText:typeof i?.conditionalText=="string"?i.conditionalText:"",rewardVariableId:ShareConstants.VARIABLE_IDS.includes(u)?u:null,conditionalRewardVariableId:ShareConstants.VARIABLE_IDS.includes(h)?h:null}),t.add(r)}return a}static normalizeEnemies(e){if(!Array.isArray(e))return[];const t=ShareConstants.ENEMY_DEFINITIONS,a=new Map;return e.map((n,i)=>{const r=G.normalizeEnemyType(n?.type),s=Array.isArray(t)&&t.length?t.findIndex(o=>o.type===r):-1,l=G.normalizeEnemyVariable(n?.defeatVariableId);return{x:ShareMath.clamp(Number(n?.x),0,ShareConstants.MATRIX_SIZE-1,0),y:ShareMath.clamp(Number(n?.y),0,ShareConstants.MATRIX_SIZE-1,0),roomIndex:ShareMath.clampRoomIndex(n?.roomIndex),type:r,id:n?.id||`enemy-${i+1}`,typeIndex:s,defeatVariableId:l,variableNibble:ShareVariableCodec.variableIdToNibble(l)}}).filter(n=>{if(!Number.isFinite(n.x)||!Number.isFinite(n.y))return!1;const i=a.get(n.roomIndex)||0;return i>=9?!1:(a.set(n.roomIndex,i+1),!0)})}static normalizeObjectPositions(e,t){if(!Array.isArray(e))return[];const a=new Set,n=[];for(const i of e){if(i?.type!==t)continue;const r=ShareMath.clamp(Number(i?.x),0,ShareConstants.MATRIX_SIZE-1,0),s=ShareMath.clamp(Number(i?.y),0,ShareConstants.MATRIX_SIZE-1,0);if(!Number.isFinite(r)||!Number.isFinite(s))continue;const l=ShareMath.clampRoomIndex(i?.roomIndex),o=l;a.has(o)||(a.add(o),n.push({x:r,y:s,roomIndex:l}))}return n.sort((i,r)=>i.roomIndex!==r.roomIndex?i.roomIndex-r.roomIndex:i.y!==r.y?i.y-r.y:i.x-r.x)}static normalizeVariableDoorObjects(e){if(!Array.isArray(e))return[];const t=new Set,a=ShareVariableCodec.variableIdToNibble(ShareVariableCodec.getFirstVariableId())||1,n=[];for(const i of e){if(i?.type!==G.Types.DOOR_VARIABLE)continue;const r=ShareMath.clamp(Number(i?.x),0,ShareConstants.MATRIX_SIZE-1,0),s=ShareMath.clamp(Number(i?.y),0,ShareConstants.MATRIX_SIZE-1,0);if(!Number.isFinite(r)||!Number.isFinite(s))continue;const l=ShareMath.clampRoomIndex(i?.roomIndex);if(t.has(l))continue;t.add(l);const o=ShareVariableCodec.variableIdToNibble(typeof i?.variableId=="string"?i.variableId:null)||a;n.push({x:r,y:s,roomIndex:l,variableNibble:o})}return n.sort((i,r)=>i.roomIndex!==r.roomIndex?i.roomIndex-r.roomIndex:i.y!==r.y?i.y-r.y:i.x-r.x)}static normalizeSwitchObjects(e){if(!Array.isArray(e))return[];const t=new Set,a=ShareVariableCodec.variableIdToNibble(ShareVariableCodec.getFirstVariableId())||1,n=[];for(const i of e){if(i?.type!==G.Types.SWITCH)continue;const r=ShareMath.clamp(Number(i?.x),0,ShareConstants.MATRIX_SIZE-1,0),s=ShareMath.clamp(Number(i?.y),0,ShareConstants.MATRIX_SIZE-1,0);if(!Number.isFinite(r)||!Number.isFinite(s))continue;const l=ShareMath.clampRoomIndex(i?.roomIndex);if(t.has(l))continue;t.add(l);const o=ShareVariableCodec.variableIdToNibble(typeof i?.variableId=="string"?i.variableId:null)||a,c=i?.on?1:0;n.push({x:r,y:s,roomIndex:l,variableNibble:o,stateNibble:c})}return n.sort((i,r)=>i.roomIndex!==r.roomIndex?i.roomIndex-r.roomIndex:i.y!==r.y?i.y-r.y:i.x-r.x)}static buildObjectEntries(e,t,a={}){if(!Array.isArray(e)||!e.length)return[];const n=Array.isArray(a.variableNibbles)?a.variableNibbles:[],i=Array.isArray(a.endingTexts)?a.endingTexts:[],r=ShareVariableCodec.getFirstVariableId();return e.map((s,l)=>{const o=ShareMath.clampRoomIndex(s?.roomIndex),c=ShareMath.clamp(Number(s?.x),0,ShareConstants.MATRIX_SIZE-1,0),d=ShareMath.clamp(Number(s?.y),0,ShareConstants.MATRIX_SIZE-1,0),u={id:`${t}-${o}`,type:t,roomIndex:o,x:c,y:d};if(t===G.Types.KEY&&(u.collected=!1),t===G.Types.LIFE_POTION&&(u.collected=!1),t===G.Types.XP_SCROLL&&(u.collected=!1),(t===G.Types.SWORD||t===G.Types.SWORD_BRONZE||t===G.Types.SWORD_WOOD)&&(u.collected=!1),t===G.Types.DOOR&&(u.opened=!1),t===G.Types.DOOR_VARIABLE){const h=n[l]??ShareVariableCodec.variableIdToNibble(r),g=ShareVariableCodec.nibbleToVariableId(h)||r;g&&(u.variableId=g)}if(t===G.Types.SWITCH){const h=n[l]??ShareVariableCodec.variableIdToNibble(r),g=ShareVariableCodec.nibbleToVariableId(h)||r;g&&(u.variableId=g);const p=Array.isArray(a.stateBits)?a.stateBits[l]:null;u.on=!!p}if(t===G.Types.PLAYER_END){const h=G.normalizeEndingTextValue(i[l]??"");h&&(u.endingText=h)}return u})}static getPlayerEndTextLimit(){return typeof StateObjectManager?.PLAYER_END_TEXT_LIMIT=="number"?StateObjectManager.PLAYER_END_TEXT_LIMIT:40}static normalizeEndingTextValue(e){if(typeof e!="string")return"";const t=e.replace(/\r\n/g,`
`),a=G.getPlayerEndTextLimit();return t.slice(0,a).trim()}static collectPlayerEndTexts(e){if(!Array.isArray(e))return[];const t=[],a=new Set;for(const n of e){if(n?.type!==G.Types.PLAYER_END)continue;const i=ShareMath.clampRoomIndex(n?.roomIndex);if(a.has(i))continue;a.add(i);const r=ShareMath.clamp(Number(n?.x),0,ShareConstants.MATRIX_SIZE-1,0),s=ShareMath.clamp(Number(n?.y),0,ShareConstants.MATRIX_SIZE-1,0);!Number.isFinite(r)||!Number.isFinite(s)||t.push({roomIndex:i,x:r,y:s,text:G.normalizeEndingTextValue(n?.endingText??"")})}return t.sort((n,i)=>n.roomIndex!==i.roomIndex?n.roomIndex-i.roomIndex:n.y!==i.y?n.y-i.y:n.x-i.x),t.map(n=>n.text)}static normalizeEnemyType(e){return EnemyDefinitions.normalizeType(e)}static normalizeEnemyVariable(e){return typeof e!="string"?null:ShareConstants.VARIABLE_IDS.includes(e)?e:null}};typeof window<"u"&&(window.ShareDataNormalizer=fa);let ya=class{static buildShareCode(e){const t=ObjectTypes,a=ShareConstants.WORLD_ROOM_COUNT,n=ShareMatrixCodec.collectGroundMatrices(e,a),i=ShareMatrixCodec.collectOverlayMatrices(e,a),r=ShareDataNormalizer.normalizeStart(e?.start??{}),s=ShareDataNormalizer.normalizeSprites(e?.sprites),l=ShareDataNormalizer.normalizeEnemies(e?.enemies),o=Array.isArray(e?.objects)?e.objects:[],c=ShareDataNormalizer.normalizeObjectPositions(o,t.DOOR),d=ShareDataNormalizer.normalizeObjectPositions(o,t.KEY),u=ShareDataNormalizer.normalizeObjectPositions(o,t.LIFE_POTION),h=ShareDataNormalizer.normalizeObjectPositions(o,t.XP_SCROLL),g=ShareDataNormalizer.normalizeObjectPositions(o,t.SWORD),p=ShareDataNormalizer.normalizeObjectPositions(o,t.SWORD_BRONZE),f=ShareDataNormalizer.normalizeObjectPositions(o,t.SWORD_WOOD),y=ShareDataNormalizer.normalizeObjectPositions(o,t.PLAYER_END),T=ShareDataNormalizer.collectPlayerEndTexts(o),b=ShareDataNormalizer.normalizeSwitchObjects(o),x=ShareDataNormalizer.normalizeVariableDoorObjects(o),O=x.map(S=>({x:S.x,y:S.y,roomIndex:S.roomIndex})),N=x.map(S=>S.variableNibble??0),D=Array.isArray(e?.variables)?e.variables:[],L=ShareVariableCodec.encodeVariables(D),A=n.map(S=>ShareMatrixCodec.encodeGround(S)),v=A.some(S=>!!S),I=[];let k=!1;for(let S=0;S<a;S++){const{text:U,hasData:z}=ShareMatrixCodec.encodeOverlay(i[S]??[]);I.push(U),z&&(k=!0)}const w=[];w.push("v"+ShareConstants.VERSION.toString(36)),v&&w.push("g"+A.join(",")),k&&w.push("o"+I.join(","));const F=ShareDataNormalizer.normalizeStart({});if(r.x!==F.x||r.y!==F.y||r.roomIndex!==F.roomIndex){const S=SharePositionCodec.encodePositions([r]);S&&w.push("s"+S)}if(s.length){const S=SharePositionCodec.encodePositions(s),U=SharePositionCodec.encodeNpcTypeIndexes(s),z=s.map(M=>typeof M.text=="string"?M.text:""),W=s.map(M=>typeof M.conditionText=="string"?M.conditionText:""),J=s.map(M=>ShareVariableCodec.variableIdToNibble(M.conditionVariableId)),E=s.map(M=>ShareVariableCodec.variableIdToNibble(M.rewardVariableId)),C=s.map(M=>ShareVariableCodec.variableIdToNibble(M.conditionalRewardVariableId)),j=W.some(M=>typeof M=="string"&&M.trim().length),Y=ShareTextCodec.encodeTextArray(z),re=j?ShareTextCodec.encodeTextArray(W):"",ce=ShareVariableCodec.encodeVariableNibbleArray(J),ve=ShareVariableCodec.encodeVariableNibbleArray(E),be=ShareVariableCodec.encodeVariableNibbleArray(C);S&&w.push("p"+S),U&&w.push("i"+U),Y&&w.push("t"+Y),re&&w.push("u"+re),ce&&w.push("c"+ce),ve&&w.push("r"+ve),be&&w.push("h"+be)}if(l.length){const S=SharePositionCodec.encodePositions(l),U=SharePositionCodec.encodeEnemyTypeIndexes(l),z=l.map(J=>J.variableNibble??0),W=ShareVariableCodec.encodeVariableNibbleArray(z);S&&w.push("e"+S),U&&w.push("f"+U),W&&w.push("w"+W)}if(c.length){const S=SharePositionCodec.encodePositions(c);S&&w.push("d"+S)}if(O.length){const S=SharePositionCodec.encodePositions(O);S&&w.push("m"+S);const U=ShareVariableCodec.encodeVariableNibbleArray(N);U&&w.push("q"+U)}if(d.length){const S=SharePositionCodec.encodePositions(d);S&&w.push("k"+S)}if(u.length){const S=SharePositionCodec.encodePositions(u);S&&w.push("l"+S)}if(h.length){const S=SharePositionCodec.encodePositions(h);S&&w.push("x"+S)}if(g.length){const S=SharePositionCodec.encodePositions(g);S&&w.push("a"+S)}if(p.length){const S=SharePositionCodec.encodePositions(p);S&&w.push("B"+S)}if(f.length){const S=SharePositionCodec.encodePositions(f);S&&w.push("W"+S)}if(y.length){const S=SharePositionCodec.encodePositions(y);S&&w.push("z"+S)}if(Array.isArray(T)&&T.some(S=>typeof S=="string"&&S.length)&&w.push("E"+ShareTextCodec.encodeTextArray(T)),b.length){const S=b.map(z=>({x:z.x,y:z.y,roomIndex:z.roomIndex})),U=SharePositionCodec.encodePositions(S);if(U){w.push("J"+U);const z=ShareVariableCodec.encodeVariableNibbleArray(b.map(J=>J.variableNibble??0)),W=ShareVariableCodec.encodeVariableNibbleArray(b.map(J=>J.stateNibble??0));z&&w.push("K"+z),W&&w.push("L"+W)}}L&&w.push("b"+L);const P=typeof e?.title=="string"?e.title.trim():"";P&&P!==ShareConstants.DEFAULT_TITLE&&w.push("n"+ShareTextCodec.encodeText(P.slice(0,80)));const X=typeof e?.author=="string"?e.author.trim():"";return X&&w.push("y"+ShareTextCodec.encodeText(X.slice(0,60))),w.join(".")}};typeof window<"u"&&(window.ShareEncoder=ya);let va=class{static decodeShareCode(e){const t=ObjectTypes;if(!e)return null;const a=e.split("."),n={};for(const M of a){if(!M)continue;const q=M[0],Z=M.slice(1);n[q]=Z}const i=n.v?parseInt(n.v,36):NaN;if(!Number.isFinite(i)||!ShareConstants.SUPPORTED_VERSIONS.has(i))return null;const r=i>=ShareConstants.VERSION_3?ShareConstants.WORLD_ROOM_COUNT:1,s=ShareMatrixCodec.decodeWorldGround(n.g||"",i,r),l=ShareMatrixCodec.decodeWorldOverlay(n.o||"",i,r),o=SharePositionCodec.decodePositions(n.s||"")?.[0]??ShareDataNormalizer.normalizeStart({}),c=SharePositionCodec.decodePositions(n.p||""),d=ShareTextCodec.decodeTextArray(n.t||""),u=SharePositionCodec.decodeNpcTypeIndexes(n.i||""),h=i>=ShareConstants.NPC_VARIABLE_TEXT_VERSION?ShareTextCodec.decodeTextArray(n.u||""):[],g=i>=ShareConstants.NPC_VARIABLE_TEXT_VERSION?ShareVariableCodec.decodeVariableNibbleArray(n.c||"",c.length):[],p=i>=ShareConstants.NPC_VARIABLE_TEXT_VERSION?ShareVariableCodec.decodeVariableNibbleArray(n.r||"",c.length):[],f=i>=ShareConstants.NPC_CONDITIONAL_REWARD_VERSION?ShareVariableCodec.decodeVariableNibbleArray(n.h||"",c.length):[],y=SharePositionCodec.decodePositions(n.e||""),T=i>=ShareConstants.ENEMY_TYPE_VERSION?SharePositionCodec.decodeEnemyTypeIndexes(n.f||"",y.length):[],b=i>=ShareConstants.ENEMY_VARIABLE_VERSION?ShareVariableCodec.decodeVariableNibbleArray(n.w||"",y.length):new Array(y.length).fill(0),x=i>=ShareConstants.OBJECTS_VERSION?SharePositionCodec.decodePositions(n.d||""):[],O=i>=ShareConstants.OBJECTS_VERSION?SharePositionCodec.decodePositions(n.k||""):[],N=i>=ShareConstants.MAGIC_DOOR_VERSION?SharePositionCodec.decodePositions(n.m||""):[],D=i>=ShareConstants.MAGIC_DOOR_VERSION?ShareVariableCodec.decodeVariableNibbleArray(n.q||"",N.length):[],L=i>=ShareConstants.LIFE_POTION_VERSION?SharePositionCodec.decodePositions(n.l||""):[],A=i>=ShareConstants.XP_SCROLL_VERSION?SharePositionCodec.decodePositions(n.x||""):[],v=i>=ShareConstants.SWORD_VERSION?SharePositionCodec.decodePositions(n.a||""):[],I=i>=ShareConstants.TIERED_SWORD_VERSION?SharePositionCodec.decodePositions(n.B||""):[],k=i>=ShareConstants.TIERED_SWORD_VERSION?SharePositionCodec.decodePositions(n.W||""):[],w=i>=ShareConstants.PLAYER_END_VERSION?SharePositionCodec.decodePositions(n.z||""):[];let F=[];if(i>=ShareConstants.PLAYER_END_TEXT_ARRAY_VERSION)F=ShareTextCodec.decodeTextArray(n.E||"");else if(i>=ShareConstants.PLAYER_END_TEXT_VERSION){const M=ShareTextCodec.decodeText(n.E||"","");M&&(F=[M])}const $=i>=ShareConstants.VARIABLES_VERSION?ShareVariableCodec.decodeVariables(n.b||""):[],H=i>=ShareConstants.SWITCH_VERSION?SharePositionCodec.decodePositions(n.J||""):[],P=i>=ShareConstants.SWITCH_VERSION?ShareVariableCodec.decodeVariableNibbleArray(n.K||"",H.length):[],X=i>=ShareConstants.SWITCH_VERSION?ShareVariableCodec.decodeVariableNibbleArray(n.L||"",H.length):[],S=(ShareTextCodec.decodeText(n.n,ShareConstants.DEFAULT_TITLE)||ShareConstants.DEFAULT_TITLE).slice(0,18),U=(ShareTextCodec.decodeText(n.y,"")||"").slice(0,18),z=M=>`npc-${M+1}`,W=ShareConstants.NPC_DEFINITIONS,J=W.length>0&&(u.length>0||c.length<=W.length),E=[];if(J)for(let M=0;M<c.length;M++){const q=u[M]??M,Z=W[q];if(!Z)continue;const Q=c[M],Te=ShareVariableCodec.nibbleToVariableId(g[M]??0),wa=ShareVariableCodec.nibbleToVariableId(p[M]??0),Ea=ShareVariableCodec.nibbleToVariableId(f[M]??0);E.push({id:z(M),type:Z.type,name:Z.name,x:Q.x,y:Q.y,roomIndex:Q.roomIndex,text:d[M]??(Z.defaultText||""),placed:!0,conditionVariableId:Te,conditionText:h[M]??"",rewardVariableId:wa,conditionalRewardVariableId:Ea})}else for(let M=0;M<c.length;M++){const q=c[M],Z=ShareVariableCodec.nibbleToVariableId(g[M]??0),Q=ShareVariableCodec.nibbleToVariableId(p[M]??0),Te=ShareVariableCodec.nibbleToVariableId(f[M]??0);E.push({id:z(M),name:`NPC ${M+1}`,x:q.x,y:q.y,roomIndex:q.roomIndex,text:d[M]??"",placed:!0,conditionVariableId:Z,conditionText:h[M]??"",rewardVariableId:Q,conditionalRewardVariableId:Te})}const C=ShareDataNormalizer.normalizeEnemyType(),j=ShareConstants.ENEMY_DEFINITIONS,Y=y.map((M,q)=>{const Z=b[q]??0;return{id:`enemy-${q+1}`,type:(()=>{const Q=T[q];return Number.isFinite(Q)&&Q>=0&&Q<j.length?ShareDataNormalizer.normalizeEnemyType(j[Q]?.type):C})(),x:M.x,y:M.y,roomIndex:M.roomIndex,defeatVariableId:ShareVariableCodec.nibbleToVariableId(Z)}}),re=Array.from({length:r},()=>({bg:0})),ce=[];for(let M=0;M<r;M++){const q=s[M]??ShareMatrixCodec.normalizeGround([]),Z=l[M]??ShareMatrixCodec.normalizeOverlay([]);ce.push({ground:q,overlay:Z})}const ve=ShareDataNormalizer.buildObjectEntries(w,t.PLAYER_END,{endingTexts:F}),be=[...ShareDataNormalizer.buildObjectEntries(x,t.DOOR),...ShareDataNormalizer.buildObjectEntries(O,t.KEY),...ShareDataNormalizer.buildObjectEntries(N,t.DOOR_VARIABLE,{variableNibbles:D}),...ShareDataNormalizer.buildObjectEntries(L,t.LIFE_POTION),...ShareDataNormalizer.buildObjectEntries(A,t.XP_SCROLL),...ShareDataNormalizer.buildObjectEntries(v,t.SWORD),...ShareDataNormalizer.buildObjectEntries(I,t.SWORD_BRONZE),...ShareDataNormalizer.buildObjectEntries(k,t.SWORD_WOOD),...ve,...ShareDataNormalizer.buildObjectEntries(H,t.SWITCH,{variableNibbles:P,stateBits:X})];return{title:S,author:U,start:o,sprites:E,enemies:Y,world:i>=ShareConstants.VERSION_3?{rows:ShareConstants.WORLD_ROWS,cols:ShareConstants.WORLD_COLS}:{rows:1,cols:1},rooms:re,objects:be,variables:ShareVariableCodec.buildVariableEntries($),tileset:{tiles:[],maps:ce,map:ce[0]||{ground:ShareMatrixCodec.normalizeGround([]),overlay:ShareMatrixCodec.normalizeOverlay([])}}}}};typeof window<"u"&&(window.ShareDecoder=va);let ba=class tt{static getBaseUrl(){return typeof window<"u"&&window.location?`${window.location.origin}${window.location.pathname}`:""}static buildShareUrl(e){const t=ShareEncoder.buildShareCode(e),a=tt.getBaseUrl();return t?`${a}#${t}`:a}static extractGameDataFromLocation(e){if(!e)return null;const t=e.hash||"";if(!t||t.length<=1)return null;const a=t.startsWith("#")?t.substring(1):t;try{return ShareDecoder.decodeShareCode(a)}catch(n){return console.warn("[TinyRPG] Unable to decode shared game data.",n),null}}};typeof window<"u"&&(window.ShareUrlHelper=ba);let Je=class{static buildShareUrl(e){return ShareUrlHelper.buildShareUrl(e)}static extractGameDataFromLocation(e){return ShareUrlHelper.extractGameDataFromLocation(e)}static encode(e){return ShareEncoder.buildShareCode(e)}static decode(e){return ShareDecoder.decodeShareCode(e)}};typeof window<"u"&&(window.ShareUtils=Je,window.TinyRPGShare=Je);let Sa=class at{constructor(e=null,t={}){this.config=e||null,this.collection=t.collection||"shareUrls",this.app=null,this.db=null,this.mode=null,this.firestoreHelpers=null,this.init()}static fromGlobal(){const e=typeof window<"u"?window.TinyRPGFirebaseConfig:null,t=typeof window<"u"?window.TinyRPGFirebaseCollection:null;return new at(e,{collection:t})}get firebase(){return typeof window<"u"?window.firebase:null}init(){return this.initFromModule()?!0:this.config?this.initFromCompat():!1}initFromModule(){const e=typeof window<"u"?window.TinyRPGFirebaseDb:null,t=typeof window<"u"?window.TinyRPGFirebaseFirestore:null;return!e||!t?.addDoc||!t?.collection?!1:(this.db=e,this.firestoreHelpers=t,this.mode="modular",console.info("[TinyRPG] Firebase tracker initialized (modular)."),!0)}initFromCompat(){const e=this.firebase;if(!e?.initializeApp)return console.warn("[TinyRPG] Firebase SDK not available."),!1;try{this.app=e.apps?.length?e.app():e.initializeApp(this.config)}catch(t){return console.warn("[TinyRPG] Firebase init failed.",t),!1}return e.firestore?(this.db=e.firestore(),this.mode="compat",console.info("[TinyRPG] Firebase tracker initialized (compat)."),!0):(console.warn("[TinyRPG] Firebase Firestore not available."),!1)}buildPayload(e,t={}){const a=this.mode==="modular"?this.firestoreHelpers?.serverTimestamp:this.firebase?.firestore?.FieldValue?.serverTimestamp;return{url:e,createdAt:a?a():new Date().toISOString(),userAgent:typeof navigator<"u"?navigator.userAgent:"",language:typeof navigator<"u"?navigator.language:"",referrer:typeof document<"u"?document.referrer:"",...t}}async trackShareUrl(e,t={}){if(!e||(this.db||this.init(),!this.db))return!1;try{const a=this.buildPayload(e,t);if(this.mode==="modular"){const{addDoc:n,collection:i}=this.firestoreHelpers;await n(i(this.db,this.collection),a)}else await this.db.collection(this.collection).add(a);return console.info("[TinyRPG] Share URL tracked.",{url:e,collection:this.collection}),!0}catch(a){return console.warn("[TinyRPG] Failed to track share URL.",a),!1}}};typeof window<"u"&&(window.FirebaseShareTracker=Sa);class Ze{canvas;gameState;tileManager;npcManager;renderer;dialogManager;interactionManager;enemyManager;movementManager;inputManager;awaitingRestart;introVisible;introStartTime;introData;canDismissIntroScreen;timeToResetAfterIntro;constructor(e){this.canvas=e,this.gameState=new GameState,this.tileManager=new TileManager(this.gameState),this.npcManager=new NPCManager(this.gameState),this.npcManager.ensureDefaultNPCs?.(),this.renderer=new Renderer(e,this.gameState,this.tileManager,this.npcManager,this),this.dialogManager=new DialogManager(this.gameState,this.renderer),this.interactionManager=new InteractionManager(this.gameState,this.dialogManager,{onPlayerVictory:()=>this.handleGameCompletion()}),this.enemyManager=new EnemyManager(this.gameState,this.renderer,this.tileManager,{onPlayerDefeated:()=>this.handlePlayerDefeat(),dialogManager:this.dialogManager}),this.movementManager=new MovementManager({gameState:this.gameState,tileManager:this.tileManager,renderer:this.renderer,dialogManager:this.dialogManager,interactionManager:this.interactionManager,enemyManager:this.enemyManager}),this.inputManager=new InputManager(this),this.awaitingRestart=!1,this.introVisible=!1,this.introStartTime=0,this.introData={title:"Tiny RPG Studio",author:""},this.canDismissIntroScreen=!1,this.timeToResetAfterIntro=2e3,this.setupIntroScreen(),this.tileManager.ensureDefaultTiles(),this.syncDocumentTitle(),this.renderer.draw(),this.showIntroScreen(),this.startEnemyLoop()}tryMove(e,t){this.movementManager.tryMove(e,t)}checkInteractions(){this.interactionManager.handlePlayerInteractions()}showDialog(e,t={}){this.dialogManager.showDialog(e,t)}completeDialog(){this.dialogManager.completeDialog()}closeDialog(){this.dialogManager.closeDialog()}isPickupOverlayActive(){return this.gameState.isPickupOverlayActive?.()}dismissPickupOverlay(){this.gameState.isPickupOverlayActive?.()&&(this.gameState.hidePickupOverlay?.(),this.renderer.draw())}isLevelUpCelebrationActive(){return this.gameState.isLevelUpCelebrationActive?.()}dismissLevelUpCelebration(){this.gameState.isLevelUpCelebrationActive?.()&&(this.gameState.hideLevelUpCelebration?.(),this.renderer.draw())}isLevelUpOverlayActive(){return this.gameState.isLevelUpOverlayActive?.()}moveLevelUpCursor(e=0){this.isLevelUpOverlayActive()&&(this.gameState.moveLevelUpCursor?.(e),this.renderer.draw())}confirmLevelUpSelection(){if(!this.isLevelUpOverlayActive())return;const e=this.gameState.getLevelUpOverlay?.(),t=Number.isFinite(e?.cursor)?e.cursor:0;this.chooseLevelUpSkill(t)}chooseLevelUpSkill(e=null){if(!this.isLevelUpOverlayActive())return;const t=this.gameState.selectLevelUpSkill?.(e);if(t){const a=this.getSkillDisplayName(t),n=TextResources.format("skills.pickupMessage",{name:a},"")||`VocÃª aprendeu ${a}`;this.dialogManager.showDialog?.(n)}this.renderer.draw()}getSkillDisplayName(e=null){if(!e)return"skill";if(e.nameKey){const t=TextResources.get(e.nameKey,e.id||"skill");if(t)return t}return e.id?e.id:"skill"}pickLevelUpChoiceFromPointer(e,t){const a=this.gameState.getLevelUpOverlay?.();if(!a?.active)return null;const n=Array.isArray(a.choices)?a.choices:[];if(!n.length)return null;const i=this.canvas?.getBoundingClientRect?.();if(!i||!Number.isFinite(e)||!Number.isFinite(t))return Number.isFinite(a.cursor)?a.cursor:0;const r=this.canvas.width/(i.width||1),s=this.canvas.height/(i.height||1),l=(e-i.left)*r,o=(t-i.top)*s,c=Math.max(0,this.gameState.getPendingLevelUpChoices?.()||0),d=this.renderer?.overlayRenderer?.getLevelUpCardLayout?.({width:this.canvas.width,height:this.canvas.height,choicesLength:n.length,hasPendingText:c>0}),u=Array.isArray(d?.rects)?d.rects:[],h=u.findIndex(g=>l>=g.x&&l<=g.x+g.width&&o>=g.y&&o<=g.y+g.height);if(h>=0)return h;if(u.length){let g=0,p=Number.POSITIVE_INFINITY;return u.forEach((f,y)=>{const T=f.x+f.width/2,b=f.y+f.height/2,x=l-T,O=o-b,N=x*x+O*O;N<p&&(p=N,g=y)}),g}return Number.isFinite(a.cursor)?a.cursor:0}resetGame(){this.awaitingRestart=!1,this.gameState.setGameOver?.(!1),this.gameState.resumeGame?.("game-over"),this.gameState.resetGame(),this.startEnemyLoop(),this.dialogManager.reset(),this.renderer.draw(),this.showIntroScreen()}exportGameData(){return this.gameState.exportGameData()}importGameData(e){this.gameState.importGameData(e),this.npcManager.ensureDefaultNPCs?.(),this.tileManager.ensureDefaultTiles(),this.syncDocumentTitle(),this.startEnemyLoop(),this.dialogManager.reset(),this.renderer.draw(),this.showIntroScreen()}getTestSettings(){return this.gameState.getTestSettings?.()||{startLevel:1,skills:[],godMode:!1}}updateTestSettings(e={}){this.gameState.setTestSettings?.(e),this.resetGame()}getMaxPlayerLevel(){return this.gameState.getMaxPlayerLevel?.()||1}getState(){return this.gameState.getState()}getGame(){return this.gameState.getGame()}draw(){this.renderer.draw()}clamp(e,t,a){return Math.max(t,Math.min(a,e))}syncDocumentTitle(){const e=this.gameState.getGame();document.title=e.title||"Tiny RPG Studio"}setupIntroScreen(){typeof document>"u"||this.refreshIntroScreen()}showIntroScreen(){this.canDismissIntroScreen=!0,this.refreshIntroScreen(),this.introVisible=!0,this.introStartTime=typeof performance<"u"&&performance.now?performance.now():Date.now(),this.gameState.pauseGame?.("intro-screen"),this.renderer.draw()}dismissIntroScreen(){return!this.introVisible||!this.canDismissIntroScreen?!1:(this.introVisible=!1,this.gameState.resumeGame?.("intro-screen"),this.renderer.draw(),!0)}isIntroVisible(){return!!this.introVisible}refreshIntroScreen(){const e=this.getGame();this.introData={title:e.title||"Tiny RPG Studio",author:(e.author||"").trim()},this.renderer.setIntroData(this.introData)}getIntroData(){return this.introData||{title:"Tiny RPG Studio",author:""}}getTiles(){return this.tileManager.getTiles()}getTileMap(e=null){const t=this.gameState.getPlayer()?.roomIndex??0,a=e??t;return this.tileManager.getTileMap(a)}getTilePresetNames(){return this.tileManager.getPresetTileNames()}getVariableDefinitions(){return this.gameState.getVariableDefinitions()}getRuntimeVariables(){return this.gameState.getVariables()}setVariableDefault(e,t){const[a]=this.gameState.setVariableValue(e,t,!0);return a&&this.renderer.draw(),a}isVariableOn(e){return this.gameState.isVariableOn(e)}getObjects(){return this.gameState.getObjects()}getObjectsForRoom(e=null){const t=this.gameState.getPlayer()?.roomIndex??0,a=e??t;return this.gameState.getObjectsForRoom(a)}setObjectPosition(e,t,a,n){const i=this.gameState.setObjectPosition(e,t,a,n);return this.renderer.draw(),i}setObjectVariable(e,t,a){const n=this.gameState.setObjectVariable?.(e,t,a);return this.renderer.draw(),n}setPlayerEndText(e,t){const a=this.gameState.setPlayerEndText?.(e,t)??"";return this.renderer.draw(),a}getPlayerEndText(e=null){return this.gameState.getPlayerEndText?.(e)??""}removeObject(e,t){this.gameState.removeObject(e,t),this.renderer.draw()}getKeyCount(){return this.gameState.getKeys()}getSprites(){return this.npcManager.ensureDefaultNPCs?.(),this.npcManager.getNPCs()}updateTile(e,t){this.tileManager.updateTile(e,t)}setMapTile(e,t,a,n=null){const i=this.gameState.getPlayer()?.roomIndex??0,r=n??i;this.tileManager.setMapTile(e,t,a,r)}addSprite(e){return this.npcManager.addNPC(e)}getEnemyDefinitions(){return this.enemyManager.getEnemyDefinitions()}getActiveEnemies(){return this.enemyManager.getActiveEnemies()}addEnemy(e){return this.enemyManager.addEnemy(e)}removeEnemy(e){this.enemyManager.removeEnemy(e)}generateEnemyId(){return this.enemyManager.generateEnemyId()}setEnemyVariable(e,t=null){if(typeof this.gameState.setEnemyVariable!="function")return!1;const a=this.gameState.setEnemyVariable(e,t);return a&&this.renderer.draw(),a}startEnemyLoop(){this.enemyManager.start()}tickEnemies(){this.enemyManager.tick()}handleEnemyCollision(e){this.enemyManager.handleEnemyCollision(e)}checkEnemyCollisionAt(e,t){this.enemyManager.checkCollisionAt(e,t)}handlePlayerDefeat(){this.gameState.prepareNecromancerRevive?.(),this.enemyManager.stop(),this.gameState.pauseGame?.("game-over"),this.gameState.setGameOver?.(!0,"defeat"),this.awaitingRestart=!0,this.renderer.draw()}handleGameCompletion(){this.isGameOver()||(this.enemyManager.stop(),this.gameState.pauseGame?.("game-over"),this.gameState.setGameOver?.(!0,"victory"),this.awaitingRestart=!0,this.renderer.draw())}isGameOver(){return this.gameState.isGameOver()}handleGameOverInteraction(){if(!(!this.isGameOver()||!this.gameState.canResetAfterGameOver)){if(this.gameState.hasNecromancerReviveReady?.()&&this.gameState.reviveFromNecromancer?.()){this.awaitingRestart=!1,this.enemyManager.start(),this.renderer.draw();return}this.resetGame()}}}typeof window<"u"&&(window.GameEngine=Ze);const ie=(m,e="")=>TextResources.get(m,e)||e||m||"";class Qe{static boot(){document.addEventListener("DOMContentLoaded",()=>{this.initializeApplication(),this.setupResponsiveCanvas()})}static initializeApplication(){this.setupTabs();const e=document.getElementById("game-canvas");if(!(e instanceof HTMLCanvasElement))return;const t=new Ze(e);this.loadSharedGameIfAvailable(t);const a=!!window.__TINY_RPG_EXPORT_MODE;let n=null;document.addEventListener("game-tab-activated",i=>{i.detail?.initial||t.resetGame()}),document.addEventListener("editor-tab-activated",i=>{i.detail?.initial||t.resetGame()}),window.TinyRPGMaker={exportGameData:()=>t.exportGameData(),importGameData:i=>t.importGameData(i),getState:()=>t.getState(),draw:()=>t.draw(),resetGame:()=>t.resetGame(),updateTile:(i,r)=>t.updateTile(i,r),setMapTile:(i,r,s)=>t.setMapTile(i,r,s),getTiles:()=>t.getTiles(),getTileMap:()=>t.getTileMap(),getTilePresetNames:()=>t.getTilePresetNames(),getVariables:()=>t.getVariableDefinitions(),setVariableDefault:(i,r)=>t.setVariableDefault(i,r),addSprite:i=>t.addSprite(i),getSprites:()=>t.getSprites(),resetNPCs:()=>t.npcManager.resetNPCs(),renderAll:()=>n?.renderAll?.()},a||(n=new EditorManager(t)),this.bindResetButton(t),this.bindTouchPad(t),this.bindLanguageSelector(),console.log(ie("log.engineReady"))}static bindResetButton(e){const t=document.getElementById("btn-reset");if(!(t instanceof HTMLButtonElement))return;const a=()=>`${window.location.origin}${window.location.pathname}`,n=s=>{if(window.open(s,"_blank","noopener"))return!0;const o=document.createElement("a");return o.href=s,o.target="_blank",o.rel="noopener noreferrer",o.style.position="absolute",o.style.left="-9999px",document.body.appendChild(o),o.click(),requestAnimationFrame(()=>o.remove()),!0},i=s=>{if(document.body.classList.contains("editor-mode")){s.preventDefault(),s.stopImmediatePropagation();const o=a();return n(o),t.blur(),!1}return e.resetGame(),t.blur(),!1},r=()=>{document.body.classList.contains("editor-mode")?(t.textContent=ie("buttons.newGame"),t.setAttribute("aria-label",ie("aria.newGame"))):(t.textContent=ie("buttons.reset"),t.setAttribute("aria-label",ie("aria.reset")))};t.addEventListener("click",i),document.addEventListener("game-tab-activated",r),document.addEventListener("editor-tab-activated",r),document.addEventListener("language-changed",r),r()}static bindTouchPad(e){const t=document.querySelectorAll(".game-touch-pad .pad-button[data-direction]"),a=document.getElementById("touch-controls-toggle"),n=document.getElementById("touch-controls-hide"),i=document.getElementById("mobile-touch-pad");if(!t.length||!(a instanceof HTMLButtonElement)||!i)return;const r={left:[-1,0],right:[1,0],up:[0,-1],down:[0,1]};t.forEach(u=>{u.addEventListener("touchstart",h=>{h.preventDefault();const g=u.dataset.direction;if(!g)return;const p=r[g];p&&e.tryMove(p[0],p[1])},{passive:!1})});let s="",l="";const o=()=>{s=ie("touchControls.show"),l=ie("touchControls.hide"),a.textContent=s,n instanceof HTMLButtonElement&&(n.textContent=l,n.setAttribute("aria-label",l))};o();const c=()=>{const u=document.body.classList.contains("touch-controls-visible");a.setAttribute("aria-expanded",u?"true":"false"),a.setAttribute("aria-pressed",u?"true":"false"),i.setAttribute("aria-hidden",u?"false":"true"),u||(a.textContent=s),n instanceof HTMLButtonElement&&(n.hidden=!u,u&&(n.textContent=l))};a.addEventListener("click",()=>{document.body.classList.add("touch-controls-visible"),c()}),n instanceof HTMLButtonElement&&n.addEventListener("click",()=>{document.body.classList.remove("touch-controls-visible"),c()});const d=()=>{document.body.classList.remove("touch-controls-visible"),c()};document.addEventListener("editor-tab-activated",d),document.addEventListener("game-tab-activated",c),document.addEventListener("language-changed",()=>{o(),c()}),c()}static bindLanguageSelector(){if(typeof TextResources>"u")return;const e=document.getElementById("language-select");if(!(e instanceof HTMLSelectElement))return;const t=()=>{e.value=TextResources.getLocale()};t(),e.addEventListener("change",()=>{const a=e.value;if(!a)return;TextResources.setLocale(a)||t()}),document.addEventListener("language-changed",t)}static setupTabs(){const e=document.querySelectorAll(".tab-button[data-tab]"),t=document.querySelectorAll(".tab-content"),a=r=>{const s=r==="editor",l=r==="game";document.body.classList.toggle("editor-mode",s),document.body.classList.toggle("game-mode",l)},n=r=>{if(r.classList.contains("active"))return;const s=r.dataset.tab;if(!s)return;e.forEach(c=>{c.classList.remove("active"),c.setAttribute("aria-selected","false")}),t.forEach(c=>c.classList.remove("active")),r.classList.add("active"),r.setAttribute("aria-selected","true");const l=`tab-${s}`,o=document.getElementById(l);if(o&&o.classList.add("active"),a(s),s==="game"&&document.dispatchEvent(new CustomEvent("game-tab-activated")),s==="editor"&&(window.TinyRPGMaker&&window.TinyRPGMaker.resetNPCs&&window.TinyRPGMaker.resetNPCs(),window.TinyRPGMaker&&window.TinyRPGMaker.draw&&window.TinyRPGMaker.draw(),document.dispatchEvent(new CustomEvent("editor-tab-activated")),window.TinyRPGMaker&&window.TinyRPGMaker.renderAll&&window.TinyRPGMaker.renderAll(),window.TinyRPGMaker&&window.TinyRPGMaker.exportGameData&&window.TinyRPGMaker.importGameData)){const c=window.TinyRPGMaker.exportGameData();window.TinyRPGMaker.importGameData(c)}};e.forEach(r=>{r.addEventListener("pointerdown",s=>{s.preventDefault(),n(r)}),r.addEventListener("keydown",s=>{(s.key==="Enter"||s.key===" ")&&(s.preventDefault(),n(r))})});const i=document.querySelector(".tab-button.active[data-tab]");i?.dataset.tab&&(a(i.dataset.tab),i.dataset.tab==="game"&&document.dispatchEvent(new CustomEvent("game-tab-activated",{detail:{initial:!0}})),i.dataset.tab==="editor"&&document.dispatchEvent(new CustomEvent("editor-tab-activated",{detail:{initial:!0}})))}static loadSharedGameIfAvailable(e){const t=window.TinyRPGShare;if(!t?.extractGameDataFromLocation)return;const a=t.extractGameDataFromLocation(window.location);a&&e.importGameData(a)}static setupResponsiveCanvas(){const e=document.getElementById("game-canvas"),t=document.getElementById("game-container");if(!(e instanceof HTMLCanvasElement)||!t)return;const a=()=>{const i=t.getBoundingClientRect(),r=i.width||window.innerWidth,s=i.height||window.innerHeight,l=(e.height||1)/(e.width||1),o=Math.max(128,r*.9),d=Math.max(128,s*.9)/l,u=Math.min(o,d),h=u*l;e.style.width=`${u}px`,e.style.height=`${h}px`},n=()=>window.requestAnimationFrame(a);window.addEventListener("resize",n),document.addEventListener("game-tab-activated",n),n()}}Qe.boot(),window.TinyRPGApplication=Qe})();
